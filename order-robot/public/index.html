<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¬å¸è®¢é¤ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/element-plus@2.4.4/dist/index.css" rel="stylesheet">
    <style>
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        .main-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .meal-section {
            margin-bottom: 30px;
        }
        .meal-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
        }
        .meal-title .icon {
            margin-right: 10px;
            font-size: 24px;
        }
        .dish-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }
        .dish-card {
            border: 1px solid #ebeef5;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }
        .dish-card:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transform: translateY(-2px);
            border-color: #409eff;
        }
        .dish-name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .dish-desc {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
        }
        .dish-rating {
            display: flex;
            align-items: center;
            font-size: 12px;
            color: #f56c6c;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .stat-card {
            text-align: center;
            padding: 20px;
            border-radius: 12px;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            color: white;
        }
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        .register-form {
            background: #f8f9ff;
            border-radius: 12px;
            padding: 25px;
            margin-top: 30px;
        }
        .actions-bar {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }
        .rating-section {
            background: #fff7f0;
            border-radius: 12px;
            padding: 25px;
            margin-top: 30px;
        }
        @media (max-width: 768px) {
            .dish-grid {
                grid-template-columns: 1fr;
            }
            .container {
                padding: 10px;
            }
            .main-card {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <div class="header">
                <h1>ğŸ½ï¸ å…¬å¸è®¢é¤ç³»ç»Ÿ</h1>
                <p>{{ todayDate }} {{ getDayName() }}</p>
            </div>

            <div class="main-card">
                <!-- ä»Šæ—¥èœå• -->
                <div v-if="todayMenu.lunch.length > 0 || todayMenu.dinner.length > 0">
                    <div class="meal-section" v-if="todayMenu.lunch.length > 0">
                        <div class="meal-title">
                            <span class="icon">ğŸŒ…</span>
                            åˆé¤èœå•
                        </div>
                        <div class="dish-grid">
                            <div class="dish-card" v-for="dish in todayMenu.lunch" :key="dish.id" 
                                 @click="selectDishForRating(dish, 'lunch')">
                                <div class="dish-name">{{ dish.dishName }}</div>
                                <div class="dish-desc">{{ dish.restaurantName || 'ç‚¹å‡»è¯„ä»·æ­¤èœå“' }}</div>
                                <div class="dish-rating">
                                    â­ {{ dish.rating ? dish.rating.toFixed(1) : 'æš‚æ— è¯„åˆ†' }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="meal-section" v-if="todayMenu.dinner.length > 0">
                        <div class="meal-title">
                            <span class="icon">ğŸŒ™</span>
                            æ™šé¤èœå•
                        </div>
                        <div class="dish-grid">
                            <div class="dish-card" v-for="dish in todayMenu.dinner" :key="dish.id"
                                 @click="selectDishForRating(dish, 'dinner')">
                                <div class="dish-name">{{ dish.dishName }}</div>
                                <div class="dish-desc">{{ dish.restaurantName || 'ç‚¹å‡»è¯„ä»·æ­¤èœå“' }}</div>
                                <div class="dish-rating">
                                    â­ {{ dish.rating ? dish.rating.toFixed(1) : 'æš‚æ— è¯„åˆ†' }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å‘¨æœ«æç¤º -->
                <div v-else style="text-align: center; padding: 50px; color: #666;">
                    <h3>ğŸ‰ ä»Šå¤©æ˜¯ä¼‘æ¯æ—¥ï¼Œæš‚æ— èœå•</h3>
                    <p>å‘¨ä¸€åˆ°å‘¨äº”æ‰æœ‰è®¢é¤æœåŠ¡å“¦</p>
                </div>

                <!-- è®¢é¤ç»Ÿè®¡ -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">{{ orderStats.lunch.orderCount }}</div>
                        <div class="stat-label">åˆé¤è®¢é¤ä»½æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">{{ orderStats.lunch.noEatCount }}</div>
                        <div class="stat-label">åˆé¤ä¸åƒäººæ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">{{ orderStats.dinner.orderCount }}</div>
                        <div class="stat-label">æ™šé¤è®¢é¤ä»½æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">{{ orderStats.dinner.noEatCount }}</div>
                        <div class="stat-label">æ™šé¤ä¸åƒäººæ•°</div>
                    </div>
                </div>

                <!-- å½“å‰äººæ•°è®¾ç½® -->
                <div class="register-form">
                    <h3 style="margin-top: 0;">ğŸ‘¥ å½“å‰äººæ•°è®¾ç½®</h3>
                    <el-form :model="currentPeopleForm" inline>
                        <el-form-item label="é¤æ¬¡">
                            <el-select v-model="currentPeopleForm.mealType" placeholder="é€‰æ‹©é¤æ¬¡" style="width: 120px;">
                                <el-option label="åˆé¤" value="lunch"></el-option>
                                <el-option label="æ™šé¤" value="dinner"></el-option>
                            </el-select>
                        </el-form-item>
                        <el-form-item label="å½“å‰äººæ•°">
                            <el-input-number 
                                v-model="currentPeopleForm.count" 
                                :min="0" 
                                :max="200" 
                                placeholder="è¾“å…¥å½“å‰äººæ•°"
                                style="width: 150px;">
                            </el-input-number>
                        </el-form-item>
                        <el-form-item>
                            <el-button type="primary" @click="setCurrentPeople">è®¾ç½®äººæ•°</el-button>
                        </el-form-item>
                    </el-form>
                    <div style="margin-top: 15px; font-size: 14px; color: #666;">
                        <div>å½“å‰è®¾ç½® - åˆé¤äººæ•°: {{ currentPeople.lunch }} äººï¼Œæ™šé¤äººæ•°: {{ currentPeople.dinner }} äºº</div>
                    </div>
                </div>

                <!-- èœå“è¯„ä»· -->
                <div class="rating-section" v-if="showRatingForm">
                    <h3 style="margin-top: 0;">â­ èœå“è¯„ä»·</h3>
                    <el-form :model="ratingForm">
                        <el-form-item label="èœå“">
                            <span>{{ selectedDish.dishName }}</span>
                        </el-form-item>
                        <el-form-item label="å§“å">
                            <el-input v-model="ratingForm.employeeName" placeholder="è¯·è¾“å…¥å§“å"></el-input>
                        </el-form-item>
                        <el-form-item label="è¯„åˆ†">
                            <el-rate v-model="ratingForm.rating" :max="5"></el-rate>
                        </el-form-item>
                        <el-form-item label="å»ºè®®">
                            <el-input v-model="ratingForm.comment" type="textarea" placeholder="å¯¹è¿™é“èœçš„å»ºè®®(å¯é€‰)"></el-input>
                        </el-form-item>
                        <el-form-item>
                            <el-button type="primary" @click="submitRating">æäº¤è¯„ä»·</el-button>
                            <el-button @click="closeRatingForm">å–æ¶ˆ</el-button>
                        </el-form-item>
                    </el-form>
                </div>

                <div class="actions-bar">
                    <el-button type="info" @click="showWeekMenu">æŸ¥çœ‹æœ¬å‘¨èœå•</el-button>
                    <el-button type="success" @click="refreshData">åˆ·æ–°æ•°æ®</el-button>
                </div>
            </div>
        </div>

        <!-- å‘¨èœå•å¼¹çª— -->
        <el-dialog v-model="weekMenuVisible" title="æœ¬å‘¨èœå•" width="90%" :before-close="closeWeekMenu">
            <div v-for="(dayMenu, day) in weekMenus" :key="day">
                <h4>{{ getDayNameByNum(day) }}</h4>
                <div style="margin-bottom: 20px;">
                    <div v-if="dayMenu.lunch.length > 0">
                        <strong>åˆé¤ï¼š</strong>
                        <span v-for="(dish, index) in dayMenu.lunch" :key="dish.id">
                            {{ dish.dishName }}<span v-if="index < dayMenu.lunch.length - 1">ã€</span>
                        </span>
                    </div>
                    <div v-if="dayMenu.dinner.length > 0" style="margin-top: 10px;">
                        <strong>æ™šé¤ï¼š</strong>
                        <span v-for="(dish, index) in dayMenu.dinner" :key="dish.id">
                            {{ dish.dishName }}<span v-if="index < dayMenu.dinner.length - 1">ã€</span>
                        </span>
                    </div>
                </div>
            </div>
            <template #footer>
                <el-button @click="closeWeekMenu">å…³é—­</el-button>
            </template>
        </el-dialog>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.8/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/element-plus@2.4.4/dist/index.full.js"></script>
    <script>
        const { createApp } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;

        createApp({
            data() {
                return {
                    todayDate: new Date().toLocaleDateString('zh-CN'),
                    todayMenu: {
                        lunch: [],
                        dinner: []
                    },
                    orderStats: {
                        lunch: { orderCount: 0, noEatCount: 0, status: 'closed' },
                        dinner: { orderCount: 0, noEatCount: 0, status: 'closed' }
                    },
                    currentPeopleForm: {
                        mealType: 'lunch',
                        count: 0
                    },
                    currentPeople: {
                        lunch: 0,
                        dinner: 0
                    },
                    ratingForm: {
                        employeeName: '',
                        dishId: null,
                        rating: 5,
                        comment: '',
                        mealType: 'lunch'
                    },
                    selectedDish: {},
                    showRatingForm: false,
                    weekMenuVisible: false,
                    weekMenus: {}
                };
            },
            mounted() {
                this.loadTodayMenu();
                this.loadOrderStats();
                this.loadCurrentPeople();
                // æ¯30ç§’åˆ·æ–°ç»Ÿè®¡æ•°æ®
                setInterval(() => {
                    this.loadOrderStats();
                    this.loadCurrentPeople();
                }, 30000);
            },
            methods: {
                async loadTodayMenu() {
                    try {
                        const response = await fetch('/api/menu/today');
                        const result = await response.json();
                        if (result.success) {
                            this.todayMenu = result.data;
                        }
                    } catch (error) {
                        console.error('åŠ è½½ä»Šæ—¥èœå•å¤±è´¥:', error);
                    }
                },
                async loadOrderStats() {
                    try {
                        const response = await fetch('/api/order/stats/today');
                        const result = await response.json();
                        if (result.success) {
                            this.orderStats = result.data;
                        }
                    } catch (error) {
                        console.error('åŠ è½½è®¢é¤ç»Ÿè®¡å¤±è´¥:', error);
                    }
                },
                async loadCurrentPeople() {
                    try {
                        const response = await fetch('/api/current-people/today');
                        const result = await response.json();
                        if (result.success) {
                            this.currentPeople = result.data;
                        }
                    } catch (error) {
                        console.error('åŠ è½½å½“å‰äººæ•°å¤±è´¥:', error);
                    }
                },
                async setCurrentPeople() {
                    if (this.currentPeopleForm.count === undefined || this.currentPeopleForm.count < 0) {
                        ElMessage.warning('è¯·è¾“å…¥æœ‰æ•ˆçš„äººæ•°');
                        return;
                    }

                    try {
                        const response = await fetch('/api/current-people/set', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                mealType: this.currentPeopleForm.mealType,
                                currentPeople: this.currentPeopleForm.count
                            })
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            ElMessage.success('è®¾ç½®æˆåŠŸ');
                            this.currentPeopleForm.count = 0;
                            this.loadOrderStats();
                            this.loadCurrentPeople();
                        } else {
                            ElMessage.error(result.message || 'è®¾ç½®å¤±è´¥');
                        }
                    } catch (error) {
                        ElMessage.error('è®¾ç½®å¤±è´¥ï¼Œè¯·é‡è¯•');
                        console.error('è®¾ç½®å¤±è´¥:', error);
                    }
                },
                selectDishForRating(dish, mealType) {
                    this.selectedDish = dish;
                    this.ratingForm.dishId = dish.dishId;
                    this.ratingForm.mealType = mealType;
                    this.showRatingForm = true;
                },
                async submitRating() {
                    if (!this.ratingForm.employeeName) {
                        ElMessage.warning('è¯·è¾“å…¥å§“å');
                        return;
                    }

                    try {
                        const response = await fetch('/api/rating/submit', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.ratingForm)
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            ElMessage.success('è¯„ä»·æäº¤æˆåŠŸ');
                            this.closeRatingForm();
                        } else {
                            ElMessage.error(result.message || 'è¯„ä»·æäº¤å¤±è´¥');
                        }
                    } catch (error) {
                        ElMessage.error('è¯„ä»·æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                        console.error('è¯„ä»·æäº¤å¤±è´¥:', error);
                    }
                },
                closeRatingForm() {
                    this.showRatingForm = false;
                    this.ratingForm = {
                        employeeName: '',
                        dishId: null,
                        rating: 5,
                        comment: '',
                        mealType: 'lunch'
                    };
                    this.selectedDish = {};
                },
                async showWeekMenu() {
                    try {
                        const response = await fetch('/api/menu/week');
                        const result = await response.json();
                        if (result.success) {
                            this.weekMenus = result.data;
                            this.weekMenuVisible = true;
                        }
                    } catch (error) {
                        ElMessage.error('åŠ è½½å‘¨èœå•å¤±è´¥');
                        console.error('åŠ è½½å‘¨èœå•å¤±è´¥:', error);
                    }
                },
                closeWeekMenu() {
                    this.weekMenuVisible = false;
                },
                refreshData() {
                    this.loadTodayMenu();
                    this.loadOrderStats();
                    this.loadCurrentPeople();
                    ElMessage.success('æ•°æ®å·²åˆ·æ–°');
                },
                getDayName() {
                    const days = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
                    return days[new Date().getDay()];
                },
                getDayNameByNum(dayNum) {
                    const days = ['', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”'];
                    return days[dayNum] || dayNum;
                }
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>