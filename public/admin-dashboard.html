<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理员中心 - 公司订餐系统</title>
    <link href="https://cdn.jsdelivr.net/npm/element-plus@2.4.4/dist/index.css" rel="stylesheet">
    <style>
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
        }
        .dashboard-container {
            display: flex !important;
            height: 100vh;
            min-height: 100vh;
        }
        .sidebar {
            width: 250px;
            background: white;
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
            display: flex !important;
            flex-direction: column;
            flex-shrink: 0;
        }
        .sidebar-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #ebeef5;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .sidebar-header h2 {
            margin: 0;
            font-size: 18px;
        }
        .sidebar-header p {
            margin: 5px 0 0 0;
            font-size: 12px;
            opacity: 0.8;
        }
        .nav-menu {
            flex: 1;
            padding: 20px 0;
        }
        .nav-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }
        .nav-item:hover {
            background: #f5f7fa;
        }
        .nav-item.active {
            background: #fff2e6;
            border-left-color: #f56c6c;
            color: #f56c6c;
        }
        .nav-item .icon {
            margin-right: 12px;
            font-size: 18px;
            width: 20px;
            text-align: center;
        }
        .nav-item .text {
            font-weight: 500;
        }
        .admin-info {
            padding: 20px;
            border-top: 1px solid #ebeef5;
            background: #fafafa;
        }
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .content-header {
            background: white;
            padding: 20px 30px;
            border-bottom: 1px solid #ebeef5;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .content-body {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }
        .page-title {
            font-size: 24px;
            font-weight: bold;
            margin: 0;
            color: #303133;
        }
        .page-subtitle {
            margin: 5px 0 0 0;
            color: #909399;
            font-size: 14px;
        }
        .page-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* 表格样式 */
        .table-container {
            margin-top: 20px;
        }
        
        /* 菜单管理相关样式 */
        .menu-card {
            margin-bottom: 20px;
        }
        
        .menu-card .el-card__header {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #ebeef5;
        }
        
        .dish-list {
            min-height: 200px;
            padding: 10px;
        }
        
        .dish-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #ebeef5;
        }
        
        .dish-item:hover {
            background: #ecf5ff;
            border-color: #409eff;
        }
        
        .dish-operations {
            display: flex;
            gap: 8px;
        }
        
        .empty-menu {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 150px;
            color: #909399;
            font-style: italic;
        }
        
        .weekly-menu {
            display: grid;
            gap: 20px;
        }
        
        .week-day-menu {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #ebeef5;
        }
        
        .week-day-menu h4 {
            margin: 0 0 15px 0;
            color: #303133;
            font-size: 16px;
        }
        
        .meal-card .el-card__header {
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .mini-dish-list {
            min-height: 80px;
            padding: 5px;
        }
        
        .mini-dish-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            background: white;
            border-radius: 4px;
            margin-bottom: 5px;
            font-size: 12px;
            border: 1px solid #ebeef5;
        }
        
        .mini-dish-item:hover {
            background: #f0f9ff;
        }
        
        /* 添加菜品弹窗样式 */
        .dish-image-uploader {
            border: 1px dashed #d9d9d9;
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: border-color 0.3s;
            width: 148px;
            height: 148px;
            display: block;
        }
        
        .dish-image-uploader:hover {
            border-color: #409eff;
        }
        
        .dish-image-uploader-icon {
            font-size: 28px;
            color: #8c939d;
            width: 148px;
            height: 148px;
            line-height: 148px;
            text-align: center;
        }
        
        .dish-image {
            width: 148px;
            height: 148px;
            display: block;
            object-fit: cover;
        }
        
        /* 菜品库管理样式 */
        .pagination-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        
        /* 餐厅式菜单显示样式 */
        .restaurant-menu-item {
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #ebeef5;
        }
        
        .restaurant-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #ddd;
        }
        
        .restaurant-name {
            margin: 0;
            font-size: 16px;
            font-weight: bold;
            color: #303133;
        }
        
        .restaurant-operations {
            display: flex;
            gap: 8px;
        }
        
        .restaurant-dishes {
            margin-top: 8px;
        }
        
        .restaurant-dish-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 4px 0;
            background: white;
            border-radius: 4px;
            border: 1px solid #e4e7ed;
        }
        
        .dish-name {
            font-weight: 500;
            color: #606266;
        }
        
        .dish-tags {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        
        .dish-tag {
            margin-right: 0 !important;
        }
        
        .menu-note {
            text-align: center;
            font-size: 12px;
            color: #909399;
            font-style: italic;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #f0f0f0;
        }
        
        /* 周菜单的迷你餐厅显示 */
        .mini-restaurant-menu {
            margin-bottom: 8px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            border: 1px solid #ebeef5;
        }
        
        .mini-restaurant-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .mini-restaurant-name {
            font-weight: bold;
            font-size: 14px;
            color: #303133;
        }
        
        .mini-restaurant-dishes {
            font-size: 12px;
            color: #606266;
            line-height: 1.4;
        }
        
        .mini-dish-name {
            margin-right: 2px;
        }
        
        .more-dishes {
            color: #909399;
        }
        
        .mini-menu-note {
            font-size: 10px;
            color: #c0c4cc;
            font-style: italic;
            margin-top: 4px;
            text-align: center;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }
            .content-header > div {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 15px;
            }
            
            .daily-menu-cards .el-col {
                margin-bottom: 20px;
            }
            
            .weekly-menu {
                grid-template-columns: 1fr;
            }
            
            .dish-operations {
                flex-direction: column;
                gap: 5px;
            }
        }
        
        @media (max-width: 480px) {
            .dish-item {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .dish-operations {
                flex-direction: row;
                justify-content: center;
            }
        }
        
        /* 菜单编辑对话框样式 */
        .edit-meal-content {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .meal-dishes-list .dish-card {
            margin-bottom: 12px;
        }
        
        .meal-dishes-list .dish-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .meal-dishes-list .dish-info {
            flex: 1;
        }
        
        .meal-dishes-list .dish-name {
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .meal-dishes-list .restaurant-name {
            font-size: 12px;
            color: #999;
        }
        
        .empty-meal {
            text-align: center;
            padding: 40px 0;
        }
        
        /* 配置页面样式 */
        .config-form {
            margin-bottom: 20px;
        }
        
        .config-card {
            background: white;
            border: 1px solid #e6e6e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        
        .config-card h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }
        
        .config-info {
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="dashboard-container" style="display: flex; height: 100vh;">
            <!-- 左侧导航栏 -->
            <div class="sidebar" style="width: 250px; background: white; display: block;">
                <!-- 头部信息 -->
                <div class="sidebar-header">
                    <h2>🛠️ 管理员中心</h2>
                    <p>{{ formatTodayDate() }} {{ getDayName() }}</p>
                </div>
                
                <!-- 导航菜单 -->
                <div class="nav-menu">
                    <div class="nav-item" 
                         :class="{ active: currentPage === 'dishes' }"
                         @click="switchPage('dishes')">
                        <span class="icon">🍽️</span>
                        <span class="text">菜品管理</span>
                    </div>
                    
                    <div class="nav-item" 
                         :class="{ active: currentPage === 'orders' }"
                         @click="switchPage('orders')">
                        <span class="icon">📊</span>
                        <span class="text">点餐记录</span>
                    </div>
                    
                    <div class="nav-item" 
                         :class="{ active: currentPage === 'ratings' }"
                         @click="switchPage('ratings')">
                        <span class="icon">⭐</span>
                        <span class="text">菜品评价记录</span>
                    </div>
                    
                    <div class="nav-item" 
                         :class="{ active: currentPage === 'users' }"
                         @click="switchPage('users')">
                        <span class="icon">👥</span>
                        <span class="text">用户管理</span>
                    </div>
                    
                </div>
                
                <!-- 管理员信息 -->
                <div class="admin-info">
                    <div style="margin-bottom: 15px;">
                        <div style="font-weight: bold; font-size: 14px;">管理员</div>
                        <div style="font-size: 12px; color: #666;">系统管理权限</div>
                    </div>
                </div>
            </div>
            
            <!-- 主要内容区域 -->
            <div class="main-content">
                <!-- 内容头部 -->
                <div class="content-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h1 class="page-title">{{ getPageTitle() }}</h1>
                            <p class="page-subtitle">{{ getPageSubtitle() }}</p>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <el-button type="primary" @click="goToUserCenter" size="small">
                                👤 用户中心
                            </el-button>
                            <el-button type="success" @click="refreshData" size="small">
                                🔄 刷新数据
                            </el-button>
                        </div>
                    </div>
                </div>
                
                <!-- 内容主体 -->
                <div class="content-body">
                    <!-- 菜品管理页面 -->
                    <div v-if="currentPage === 'dishes'">
                        <!-- 统计卡片 -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number">{{ totalDishes }}</div>
                                <div class="stat-label">总菜品数</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #36d1dc 0%, #5b86e5 100%);">
                                <div class="stat-number">{{ totalRestaurants }}</div>
                                <div class="stat-label">合作餐厅</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                <div class="stat-number">{{ avgRating }}</div>
                                <div class="stat-label">平均评分</div>
                            </div>
                        </div>
                        
                        <!-- Current Menu Display -->
                        <div class="page-content" style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3>🍽️ 当前菜单 ({{ formatTodayDate() }})</h3>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <el-button type="primary" @click="loadCurrentMenu" :loading="loadingCurrentMenu" size="small">
                                        🔄 刷新菜单
                                    </el-button>
                                    <el-button type="warning" @click="editCurrentMenu" size="small" v-if="currentMenuData.hasMenu">
                                        ✏️ 编辑菜单
                                    </el-button>
                                </div>
                            </div>
                            
                            <!-- Current Menu Content -->
                            <div v-if="currentMenuData.hasMenu">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                    <!-- Lunch Menu -->
                                    <div class="menu-section">
                                        <h4 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                            <span>🌅 午餐</span>
                                            <el-button type="primary" size="small" @click="editMeal('lunch')" text>编辑</el-button>
                                        </h4>
                                        <div v-if="currentMenuData.lunch && currentMenuData.lunch.length > 0">
                                            <div class="dish-item" v-for="dish in currentMenuData.lunch" :key="dish.dishId" 
                                                 style="padding: 10px; border: 1px solid #e6e6e6; border-radius: 6px; margin-bottom: 8px;">
                                                <div style="font-weight: 500;">{{ dish.dishName }}</div>
                                                <div style="font-size: 12px; color: #666;">{{ dish.restaurantName }}</div>
                                            </div>
                                        </div>
                                        <div v-else style="text-align: center; color: #999; padding: 20px;">
                                            暂无午餐菜单
                                        </div>
                                    </div>
                                    
                                    <!-- Dinner Menu -->
                                    <div class="menu-section">
                                        <h4 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                            <span>🌙 晚餐</span>
                                            <el-button type="primary" size="small" @click="editMeal('dinner')" text>编辑</el-button>
                                        </h4>
                                        <div v-if="currentMenuData.dinner && currentMenuData.dinner.length > 0">
                                            <div class="dish-item" v-for="dish in currentMenuData.dinner" :key="dish.dishId" 
                                                 style="padding: 10px; border: 1px solid #e6e6e6; border-radius: 6px; margin-bottom: 8px;">
                                                <div style="font-weight: 500;">{{ dish.dishName }}</div>
                                                <div style="font-size: 12px; color: #666;">{{ dish.restaurantName }}</div>
                                            </div>
                                        </div>
                                        <div v-else style="text-align: center; color: #999; padding: 20px;">
                                            暂无晚餐菜单
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- No Menu State -->
                            <div v-else style="text-align: center; padding: 40px; color: #999;">
                                <p>📭 今日暂无菜单</p>
                                <p style="font-size: 12px;">请使用下方的菜单配置功能生成菜单</p>
                            </div>
                        </div>

                        <!-- Module 1: Daily Menu Configuration -->
                        <div class="page-content" style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3>📅 每日菜单配置</h3>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <el-radio-group v-model="selectedPeriod" @change="loadMenuForPeriod">
                                        <el-radio-button label="today">今天</el-radio-button>
                                        <el-radio-button label="thisWeek">本周</el-radio-button>
                                        <el-radio-button label="nextWeek">下周</el-radio-button>
                                    </el-radio-group>
                                    <el-button type="success" @click="generateRandomMenu" :loading="generatingMenu">
                                        🎲 随机生成菜单
                                    </el-button>
                                </div>
                            </div>
                            
                            <!-- Date Selector and Menu Display -->
                            <div v-if="selectedPeriod === 'today'">
                                <el-date-picker
                                    v-model="selectedDate"
                                    type="date"
                                    placeholder="选择日期"
                                    @change="loadMenuForDate"
                                    style="margin-bottom: 20px;"
                                    :disabled-date="(date) => date < new Date(Date.now() - 24*60*60*1000)"
                                >
                                </el-date-picker>
                                
                                <div class="daily-menu-cards">
                                    <el-row :gutter="20">
                                        <el-col :span="12">
                                            <el-card class="menu-card">
                                                <template #header>
                                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                                        <span>{{ formatDateDisplay(selectedDate) }} 午餐</span>
                                                        <div>
                                                            <el-button size="small" @click="addDishToMenu('lunch')" type="primary" plain>
                                                                ➕ 添加
                                                            </el-button>
                                                        </div>
                                                    </div>
                                                </template>
                                                <div class="dish-list">
                                                    <!-- 餐厅式菜单显示 -->
                                                    <div v-for="(restaurantMenu, index) in dailyMenu.lunch" :key="`lunch-${index}`" class="restaurant-menu-item">
                                                        <div v-if="restaurantMenu.isRestaurantMenu" class="restaurant-header">
                                                            <h4 class="restaurant-name">{{ restaurantMenu.restaurantName }}</h4>
                                                            <div class="restaurant-operations">
                                                                <el-button size="small" @click="replaceDish('lunch', index)" type="warning" plain>替换餐厅</el-button>
                                                                <el-button size="small" @click="removeDish('lunch', index)" type="danger" plain>删除</el-button>
                                                            </div>
                                                        </div>
                                                        <div v-if="restaurantMenu.isRestaurantMenu" class="restaurant-dishes">
                                                            <div v-for="dish in restaurantMenu.dishes" :key="dish.id" class="restaurant-dish-item">
                                                                <span class="dish-name">{{ dish.name }}</span>
                                                                <div v-if="dish.tags && dish.tags.length > 0" class="dish-tags">
                                                                    <el-tag v-for="tag in dish.tags" :key="tag" size="small" :type="getTagType(tag)" class="dish-tag">
                                                                        {{ getTagLabel(tag) }}
                                                                    </el-tag>
                                                                </div>
                                                            </div>
                                                            <div class="menu-note">菜品供参考</div>
                                                        </div>
                                                        <!-- 兼容原有菜品显示方式 -->
                                                        <div v-else class="dish-item">
                                                            <span>{{ restaurantMenu.restaurantName }} - {{ restaurantMenu.name }}</span>
                                                            <div class="dish-operations">
                                                                <el-button size="small" @click="replaceDish('lunch', index)" type="warning" plain>替换</el-button>
                                                                <el-button size="small" @click="removeDish('lunch', index)" type="danger" plain>删除</el-button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div v-if="dailyMenu.lunch.length === 0" class="empty-menu">
                                                        <span>暂无菜品</span>
                                                    </div>
                                                </div>
                                            </el-card>
                                        </el-col>
                                        <el-col :span="12">
                                            <el-card class="menu-card">
                                                <template #header>
                                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                                        <span>{{ formatDateDisplay(selectedDate) }} 晚餐</span>
                                                        <div>
                                                            <el-button size="small" @click="addDishToMenu('dinner')" type="primary" plain>
                                                                ➕ 添加
                                                            </el-button>
                                                        </div>
                                                    </div>
                                                </template>
                                                <div class="dish-list">
                                                    <!-- 餐厅式菜单显示 -->
                                                    <div v-for="(restaurantMenu, index) in dailyMenu.dinner" :key="`dinner-${index}`" class="restaurant-menu-item">
                                                        <div v-if="restaurantMenu.isRestaurantMenu" class="restaurant-header">
                                                            <h4 class="restaurant-name">{{ restaurantMenu.restaurantName }}</h4>
                                                            <div class="restaurant-operations">
                                                                <el-button size="small" @click="replaceDish('dinner', index)" type="warning" plain>替换餐厅</el-button>
                                                                <el-button size="small" @click="removeDish('dinner', index)" type="danger" plain>删除</el-button>
                                                            </div>
                                                        </div>
                                                        <div v-if="restaurantMenu.isRestaurantMenu" class="restaurant-dishes">
                                                            <div v-for="dish in restaurantMenu.dishes" :key="dish.id" class="restaurant-dish-item">
                                                                <span class="dish-name">{{ dish.name }}</span>
                                                                <div v-if="dish.tags && dish.tags.length > 0" class="dish-tags">
                                                                    <el-tag v-for="tag in dish.tags" :key="tag" size="small" :type="getTagType(tag)" class="dish-tag">
                                                                        {{ getTagLabel(tag) }}
                                                                    </el-tag>
                                                                </div>
                                                            </div>
                                                            <div class="menu-note">菜品供参考</div>
                                                        </div>
                                                        <!-- 兼容原有菜品显示方式 -->
                                                        <div v-else class="dish-item">
                                                            <span>{{ restaurantMenu.restaurantName }} - {{ restaurantMenu.name }}</span>
                                                            <div class="dish-operations">
                                                                <el-button size="small" @click="replaceDish('dinner', index)" type="warning" plain>替换</el-button>
                                                                <el-button size="small" @click="removeDish('dinner', index)" type="danger" plain>删除</el-button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div v-if="dailyMenu.dinner.length === 0" class="empty-menu">
                                                        <span>暂无菜品</span>
                                                    </div>
                                                </div>
                                            </el-card>
                                        </el-col>
                                    </el-row>
                                </div>
                            </div>
                            
                            <!-- Weekly Menu Display -->
                            <div v-else>
                                <div class="weekly-menu">
                                    <div v-for="day in weekDays" :key="day.key" class="week-day-menu">
                                        <h4>{{ day.label }}</h4>
                                        <el-row :gutter="10">
                                            <el-col :span="12">
                                                <el-card size="small" class="meal-card">
                                                    <template #header>
                                                        <span>午餐</span>
                                                        <el-button size="small" @click="addDishToWeeklyMenu(day.key, 'lunch')" type="primary" plain>➕</el-button>
                                                    </template>
                                                    <div class="mini-dish-list">
                                                        <div v-for="(restaurantMenu, index) in weeklyMenu[day.key]?.lunch || []" :key="`${day.key}-lunch-${index}`" class="mini-restaurant-menu">
                                                            <div v-if="restaurantMenu.isRestaurantMenu" class="mini-restaurant-header">
                                                                <span class="mini-restaurant-name">{{ restaurantMenu.restaurantName }}</span>
                                                                <el-button size="small" @click="removeWeeklyDish(day.key, 'lunch', index)" type="danger" plain circle>✕</el-button>
                                                            </div>
                                                            <div v-if="restaurantMenu.isRestaurantMenu" class="mini-restaurant-dishes">
                                                                <span v-for="(dish, dishIndex) in restaurantMenu.dishes.slice(0, 3)" :key="dish.id" class="mini-dish-name">
                                                                    {{ dish.name }}<span v-if="dishIndex < Math.min(2, restaurantMenu.dishes.length - 1)">、</span>
                                                                </span>
                                                                <span v-if="restaurantMenu.dishes.length > 3" class="more-dishes">等{{ restaurantMenu.dishes.length }}道菜</span>
                                                                <div class="mini-menu-note">菜品供参考</div>
                                                            </div>
                                                            <!-- 兼容原有格式 -->
                                                            <div v-else class="mini-dish-item">
                                                                <span>{{ restaurantMenu.restaurantName }} - {{ restaurantMenu.name }}</span>
                                                                <el-button size="small" @click="removeWeeklyDish(day.key, 'lunch', index)" type="danger" plain circle>✕</el-button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </el-card>
                                            </el-col>
                                            <el-col :span="12">
                                                <el-card size="small" class="meal-card">
                                                    <template #header>
                                                        <span>晚餐</span>
                                                        <el-button size="small" @click="addDishToWeeklyMenu(day.key, 'dinner')" type="primary" plain>➕</el-button>
                                                    </template>
                                                    <div class="mini-dish-list">
                                                        <div v-for="(restaurantMenu, index) in weeklyMenu[day.key]?.dinner || []" :key="`${day.key}-dinner-${index}`" class="mini-restaurant-menu">
                                                            <div v-if="restaurantMenu.isRestaurantMenu" class="mini-restaurant-header">
                                                                <span class="mini-restaurant-name">{{ restaurantMenu.restaurantName }}</span>
                                                                <el-button size="small" @click="removeWeeklyDish(day.key, 'dinner', index)" type="danger" plain circle>✕</el-button>
                                                            </div>
                                                            <div v-if="restaurantMenu.isRestaurantMenu" class="mini-restaurant-dishes">
                                                                <span v-for="(dish, dishIndex) in restaurantMenu.dishes.slice(0, 3)" :key="dish.id" class="mini-dish-name">
                                                                    {{ dish.name }}<span v-if="dishIndex < Math.min(2, restaurantMenu.dishes.length - 1)">、</span>
                                                                </span>
                                                                <span v-if="restaurantMenu.dishes.length > 3" class="more-dishes">等{{ restaurantMenu.dishes.length }}道菜</span>
                                                                <div class="mini-menu-note">菜品供参考</div>
                                                            </div>
                                                            <!-- 兼容原有格式 -->
                                                            <div v-else class="mini-dish-item">
                                                                <span>{{ restaurantMenu.restaurantName }} - {{ restaurantMenu.name }}</span>
                                                                <el-button size="small" @click="removeWeeklyDish(day.key, 'dinner', index)" type="danger" plain circle>✕</el-button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </el-card>
                                            </el-col>
                                        </el-row>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Menu Action Buttons -->
                            <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                                <el-button @click="saveMenu" :loading="savingMenu" size="large">
                                    💾 保存草稿
                                </el-button>
                                <el-button type="primary" @click="publishMenu" :loading="publishingMenu" size="large">
                                    🚀 发布菜单
                                </el-button>
                            </div>
                        </div>
                        
                        <!-- Module 3: Dish Library Management -->
                        <div class="page-content">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3>📚 菜品库管理</h3>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <el-button type="primary" @click="showAddDishDialog">
                                        ➕ 添加新菜品
                                    </el-button>
                                    <el-button 
                                        v-if="selectedDishes.length > 0" 
                                        @click="batchDisableDishes" 
                                        type="warning"
                                    >
                                        批量禁用 ({{ selectedDishes.length }})
                                    </el-button>
                                    <el-button 
                                        v-if="selectedDishes.length > 0" 
                                        @click="batchDeleteDishes" 
                                        type="danger"
                                    >
                                        批量删除 ({{ selectedDishes.length }})
                                    </el-button>
                                </div>
                            </div>
                            
                            <!-- Search and Filter -->
                            <div style="margin-bottom: 20px; padding: 20px; background: #fafafa; border-radius: 8px;">
                                <el-row :gutter="20">
                                    <el-col :span="8">
                                        <el-input
                                            v-model="dishSearch"
                                            placeholder="搜索菜品名称"
                                            clearable
                                            @input="filterDishes"
                                        >
                                            <template #prefix>
                                                🔍
                                            </template>
                                        </el-input>
                                    </el-col>
                                    <el-col :span="6">
                                        <el-select v-model="restaurantFilter" placeholder="筛选餐厅" clearable @change="filterDishes">
                                            <el-option
                                                v-for="restaurant in uniqueRestaurants"
                                                :key="restaurant"
                                                :label="restaurant"
                                                :value="restaurant">
                                            </el-option>
                                        </el-select>
                                    </el-col>
                                    <el-col :span="6">
                                        <el-select v-model="tagFilter" placeholder="筛选标签" clearable @change="filterDishes">
                                            <el-option label="荤菜" value="meat"></el-option>
                                            <el-option label="素食" value="vegetarian"></el-option>
                                            <el-option label="辛辣" value="spicy"></el-option>
                                            <el-option label="清淡" value="mild"></el-option>
                                            <el-option label="招牌" value="specialty"></el-option>
                                        </el-select>
                                    </el-col>
                                    <el-col :span="4">
                                        <el-select v-model="statusFilter" placeholder="状态" clearable @change="filterDishes">
                                            <el-option label="启用" value="active"></el-option>
                                            <el-option label="禁用" value="inactive"></el-option>
                                        </el-select>
                                    </el-col>
                                </el-row>
                            </div>
                            
                            <!-- Dish Library Table -->
                            <div class="table-container">
                                <el-table 
                                    :data="paginatedDishes" 
                                    style="width: 100%" 
                                    stripe
                                    @selection-change="handleSelectionChange"
                                    v-loading="loadingDishes"
                                >
                                    <el-table-column type="selection" width="55"></el-table-column>
                                    <el-table-column prop="restaurantName" label="餐厅" width="150"></el-table-column>
                                    <el-table-column prop="name" label="菜品名称" width="200"></el-table-column>
                                    <el-table-column label="标签" width="200">
                                        <template #default="scope">
                                            <el-tag 
                                                v-for="tag in scope.row.tags" 
                                                :key="tag" 
                                                size="small" 
                                                :type="getTagType(tag)"
                                                style="margin-right: 5px;"
                                            >
                                                {{ getTagLabel(tag) }}
                                            </el-tag>
                                        </template>
                                    </el-table-column>
                                    <el-table-column label="状态" width="100">
                                        <template #default="scope">
                                            <el-tag :type="scope.row.status === 'active' ? 'success' : 'danger'">
                                                {{ scope.row.status === 'active' ? '启用' : '禁用' }}
                                            </el-tag>
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="rating" label="评分" width="100">
                                        <template #default="scope">
                                            <span v-if="scope.row.rating">⭐ {{ scope.row.rating.toFixed(1) }}</span>
                                            <span v-else>暂无评分</span>
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="ratingCount" label="评价数" width="100"></el-table-column>
                                    <el-table-column label="操作" width="200">
                                        <template #default="scope">
                                            <el-button size="small" @click="editDish(scope.row)">
                                                编辑
                                            </el-button>
                                            <el-button 
                                                size="small" 
                                                :type="scope.row.status === 'active' ? 'warning' : 'success'"
                                                @click="toggleDishStatus(scope.row)"
                                            >
                                                {{ scope.row.status === 'active' ? '禁用' : '启用' }}
                                            </el-button>
                                            <el-button size="small" type="danger" @click="deleteDish(scope.row)">
                                                删除
                                            </el-button>
                                        </template>
                                    </el-table-column>
                                </el-table>
                            </div>
                            
                            <!-- Pagination -->
                            <div style="text-align: center; margin-top: 20px;">
                                <el-pagination
                                    v-model:current-page="tablePage"
                                    v-model:page-size="pageSize"
                                    :page-sizes="[10, 20, 50, 100]"
                                    :small="false"
                                    :total="totalFilteredDishes"
                                    layout="total, sizes, prev, pager, next, jumper"
                                    @size-change="handleSizeChange"
                                    @current-change="handleCurrentChange"
                                />
                            </div>
                        </div>
                        
                        <!-- Module 2: Add New Dish Modal -->
                        <el-dialog
                            v-model="showAddDishModal"
                            title="添加新菜品"
                            width="600px"
                            :before-close="handleAddDishClose"
                        >
                            <el-form :model="newDishForm" :rules="dishFormRules" ref="dishForm" label-width="100px">
                                <el-form-item label="餐厅名称" prop="restaurantName">
                                    <el-input v-model="newDishForm.restaurantName" placeholder="请输入餐厅名称"></el-input>
                                </el-form-item>
                                <el-form-item label="菜品名称" prop="name">
                                    <el-input v-model="newDishForm.name" placeholder="请输入菜品名称"></el-input>
                                </el-form-item>
                                <el-form-item label="菜品标签">
                                    <el-checkbox-group v-model="newDishForm.tags">
                                        <el-checkbox label="meat">荤菜</el-checkbox>
                                        <el-checkbox label="vegetarian">素食</el-checkbox>
                                        <el-checkbox label="spicy">辛辣</el-checkbox>
                                        <el-checkbox label="mild">清淡</el-checkbox>
                                        <el-checkbox label="specialty">招牌</el-checkbox>
                                    </el-checkbox-group>
                                </el-form-item>
                                <el-form-item label="菜品图片">
                                    <el-upload
                                        class="dish-image-uploader"
                                        :action="'/api/admin/dishes/upload-image'"
                                        :show-file-list="false"
                                        :on-success="handleImageUploadSuccess"
                                        :before-upload="beforeImageUpload"
                                        :headers="{ 'Authorization': 'Bearer ' + token }"
                                    >
                                        <img v-if="newDishForm.imageUrl" :src="newDishForm.imageUrl" class="dish-image" />
                                        <el-icon v-else class="dish-image-uploader-icon"><Plus /></el-icon>
                                    </el-upload>
                                    <div style="margin-top: 10px; color: #999; font-size: 12px;">
                                        支持 JPG、PNG 格式，文件大小不超过 2MB
                                    </div>
                                </el-form-item>
                            </el-form>
                            
                            <template #footer>
                                <span class="dialog-footer">
                                    <el-button @click="handleAddDishClose">取消</el-button>
                                    <el-button type="primary" @click="submitAddDish" :loading="addingDish">
                                        确定添加
                                    </el-button>
                                </span>
                            </template>
                        </el-dialog>
                        
                        <!-- Dish Selection Modal for Menu -->
                        <el-dialog
                            v-model="showDishSelectionModal"
                            title="选择菜品"
                            width="800px"
                            :before-close="handleDishSelectionClose"
                        >
                            <div style="margin-bottom: 20px;">
                                <el-input
                                    v-model="dishSelectionSearch"
                                    placeholder="搜索菜品"
                                    clearable
                                    @input="filterSelectionDishes"
                                >
                                    <template #prefix>🔍</template>
                                </el-input>
                            </div>
                            
                            <el-table 
                                :data="selectionFilteredDishes" 
                                max-height="400px"
                                @row-click="selectDishForMenu"
                                style="cursor: pointer;"
                            >
                                <el-table-column prop="restaurantName" label="餐厅" width="150"></el-table-column>
                                <el-table-column prop="name" label="菜品名称" width="200"></el-table-column>
                                <el-table-column label="标签" width="200">
                                    <template #default="scope">
                                        <el-tag 
                                            v-for="tag in scope.row.tags" 
                                            :key="tag" 
                                            size="small" 
                                            :type="getTagType(tag)"
                                            style="margin-right: 5px;"
                                        >
                                            {{ getTagLabel(tag) }}
                                        </el-tag>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="rating" label="评分" width="100">
                                    <template #default="scope">
                                        <span v-if="scope.row.rating">⭐ {{ scope.row.rating.toFixed(1) }}</span>
                                        <span v-else>暂无评分</span>
                                    </template>
                                </el-table-column>
                            </el-table>
                            
                            <template #footer>
                                <span class="dialog-footer">
                                    <el-button @click="handleDishSelectionClose">取消</el-button>
                                </span>
                            </template>
                        </el-dialog>
                        
                        <!-- 编辑菜单对话框 -->
                        <el-dialog 
                            v-model="showEditMealDialog" 
                            :title="`编辑${editingMealType === 'lunch' ? '午餐' : '晚餐'}菜单`"
                            width="50%">
                            <div class="edit-meal-content">
                                <div class="meal-dishes-list">
                                    <div v-if="editingMealDishes.length === 0" class="empty-meal">
                                        <el-empty description="暂无菜品" />
                                    </div>
                                    <div v-else>
                                        <el-card v-for="(dish, index) in editingMealDishes" :key="index" class="dish-card">
                                            <div class="dish-item">
                                                <div class="dish-info">
                                                    <div class="dish-name">{{ dish.dishName }}</div>
                                                    <div class="restaurant-name">{{ dish.restaurantName }}</div>
                                                </div>
                                                <el-button 
                                                    type="danger" 
                                                    size="small" 
                                                    @click="removeDishFromEditing(index)">
                                                    移除
                                                </el-button>
                                            </div>
                                        </el-card>
                                    </div>
                                </div>
                            </div>
                            <template #footer>
                                <span class="dialog-footer">
                                    <el-button @click="showEditMealDialog = false">取消</el-button>
                                    <el-button type="primary" @click="saveCurrentMenuChanges">保存</el-button>
                                </span>
                            </template>
                        </el-dialog>
                    </div>
                    
                    <!-- 点餐记录页面 -->
                    <div v-if="currentPage === 'orders'">
                        <!-- 统计卡片 -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number">{{ systemConfig.totalEmployees }}</div>
                                <div class="stat-label">当前总人数</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #36d1dc 0%, #5b86e5 100%);">
                                <div class="stat-number">{{ todayLunchOrderCount }}</div>
                                <div class="stat-label">今日中午点餐数量</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                <div class="stat-number">{{ todayDinnerOrderCount }}</div>
                                <div class="stat-label">今日晚饭点餐数量</div>
                            </div>
                        </div>
                        
                        <div class="page-content">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3>📊 点餐记录管理</h3>
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span>总人数:</span>
                                        <el-input-number 
                                            v-model="systemConfig.totalEmployees" 
                                            :min="1" 
                                            :max="1000"
                                            size="small"
                                            style="width: 100px"
                                            @change="updateTotalEmployees">
                                        </el-input-number>
                                    </div>
                                    <el-button type="success" @click="exportOrderData">
                                        📥 导出数据
                                    </el-button>
                                </div>
                            </div>
                            
                            <!-- 日期筛选控件 -->
                            <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                                    <span style="font-weight: 500;">📅 查询时间范围:</span>
                                    
                                    <!-- 快捷选择 -->
                                    <el-radio-group v-model="orderDateQuickSelect" size="small">
                                        <el-radio-button label="default">默认范围</el-radio-button>
                                        <el-radio-button label="today">今天</el-radio-button>
                                        <el-radio-button label="week">本周</el-radio-button>
                                        <el-radio-button label="month">本月</el-radio-button>
                                        <el-radio-button label="custom">自定义</el-radio-button>
                                    </el-radio-group>
                                    
                                    <!-- 自定义日期选择器 -->
                                    <el-date-picker
                                        v-if="orderDateQuickSelect === 'custom'"
                                        v-model="orderDateRange"
                                        type="daterange"
                                        range-separator="至"
                                        start-placeholder="开始日期"
                                        end-placeholder="结束日期"
                                        format="YYYY-MM-DD"
                                        value-format="YYYY-MM-DD"
                                        @change="onCustomDateRangeChange"
                                        size="small">
                                    </el-date-picker>
                                    
                                    <!-- 查询按钮 -->
                                    <el-button type="primary" @click="loadOrdersData" size="small">
                                        🔍 查询
                                    </el-button>
                                    
                                    <!-- 重置按钮 -->
                                    <el-button @click="resetDateFilter" size="small">
                                        🔄 重置
                                    </el-button>
                                </div>
                            </div>
                            
                            <div class="table-container">
                                <el-table :data="ordersData" style="width: 100%" stripe>
                                    <el-table-column prop="dateWithWeekday" label="日期" width="150">
                                    </el-table-column>
                                    <el-table-column prop="mealTypeText" label="餐次" width="100">
                                    </el-table-column>
                                    <el-table-column prop="totalPeople" label="总人数" width="100">
                                        <template #default="scope">
                                            {{ systemConfig.totalEmployees }}
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="noEatCount" label="不吃人数" width="100">
                                    </el-table-column>
                                    <el-table-column prop="orderCount" label="点餐人数" width="100">
                                        <template #default="scope">
                                            <span style="font-weight: bold; color: #67c23a;">{{ scope.row.orderCount }}</span>
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="statusText" label="状态" width="100">
                                        <template #default="scope">
                                            <el-tag :type="scope.row.status === 'open' ? 'success' : 'info'">
                                                {{ scope.row.statusText }}
                                            </el-tag>
                                        </template>
                                    </el-table-column>
                                    <el-table-column label="操作" width="200">
                                        <template #default="scope">
                                            <el-button 
                                                size="small" 
                                                :type="scope.row.status === 'open' ? 'warning' : 'success'"
                                                @click="toggleOrderStatus(scope.row)"
                                                :loading="scope.row.loading"
                                            >
                                                {{ scope.row.status === 'open' ? '关闭点餐' : '开放点餐' }}
                                            </el-button>
                                            <el-button 
                                                size="small" 
                                                type="warning"
                                                @click="clearNoEatCount(scope.row)"
                                                :loading="scope.row.clearLoading"
                                            >
                                                清零不吃
                                            </el-button>
                                        </template>
                                    </el-table-column>
                                </el-table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 菜品评价记录页面 -->
                    <div v-if="currentPage === 'ratings'">
                        <!-- 统计卡片 -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number">{{ weeklyAvgRating }}</div>
                                <div class="stat-label">本周平均评分</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #36d1dc 0%, #5b86e5 100%);">
                                <div class="stat-number">{{ weeklyNewRatings }}</div>
                                <div class="stat-label">本周新增评价</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                <div class="stat-number">{{ poorRatingPercentage }}%</div>
                                <div class="stat-label">差评占比(1-2星)</div>
                            </div>
                        </div>
                        
                        <div class="page-content">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3>⭐ 餐厅评价记录</h3>
                                <div>
                                    <el-button type="success" @click="exportRatingData">
                                        📥 导出评价数据
                                    </el-button>
                                </div>
                            </div>
                            
                            <!-- 搜索和筛选区域 -->
                            <div class="filter-section" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                                    <!-- 搜索框 -->
                                    <div style="flex: 1; min-width: 200px;">
                                        <el-input
                                            v-model="ratingSearchKeyword"
                                            placeholder="搜索菜品名、餐厅名、用户名..."
                                            @input="searchRatings"
                                            clearable
                                        >
                                            <template #prefix>
                                                <span>🔍</span>
                                            </template>
                                        </el-input>
                                    </div>
                                    
                                    <!-- 时间筛选 -->
                                    <el-select v-model="ratingTimeFilter" @change="filterRatings" placeholder="时间范围">
                                        <el-option label="全部时间" value="all"></el-option>
                                        <el-option label="今天" value="today"></el-option>
                                        <el-option label="本周" value="week"></el-option>
                                        <el-option label="本月" value="month"></el-option>
                                        <el-option label="自定义" value="custom"></el-option>
                                    </el-select>
                                    
                                    <!-- 自定义时间范围 -->
                                    <el-date-picker
                                        v-if="ratingTimeFilter === 'custom'"
                                        v-model="ratingDateRange"
                                        type="daterange"
                                        range-separator="至"
                                        start-placeholder="开始日期"
                                        end-placeholder="结束日期"
                                        @change="filterRatings"
                                    >
                                    </el-date-picker>
                                    
                                    <!-- 评分筛选 -->
                                    <el-select v-model="ratingScoreFilter" @change="filterRatings" placeholder="评分范围">
                                        <el-option label="全部评分" value="all"></el-option>
                                        <el-option label="1-2星 (差评)" value="1-2"></el-option>
                                        <el-option label="3星 (中评)" value="3"></el-option>
                                        <el-option label="4-5星 (好评)" value="4-5"></el-option>
                                    </el-select>
                                    
                                    <!-- 点赞数筛选 -->
                                    <el-select v-model="ratingLikesFilter" @change="filterRatings" placeholder="点赞数">
                                        <el-option label="全部" value="all"></el-option>
                                        <el-option label="高点赞 (≥10)" value="high"></el-option>
                                        <el-option label="低点赞 (<10)" value="low"></el-option>
                                    </el-select>
                                    
                                    <!-- 排序 -->
                                    <el-select v-model="ratingSortBy" @change="sortRatings" placeholder="排序方式">
                                        <el-option label="时间倒序 (最新)" value="time_desc"></el-option>
                                        <el-option label="时间正序 (最早)" value="time_asc"></el-option>
                                        <el-option label="热度排序 (点赞数)" value="likes_desc"></el-option>
                                        <el-option label="评分高到低" value="rating_desc"></el-option>
                                        <el-option label="评分低到高" value="rating_asc"></el-option>
                                    </el-select>
                                    
                                    <!-- 重置按钮 -->
                                    <el-button @click="resetFilters">重置筛选</el-button>
                                </div>
                            </div>
                            
                            <div class="table-container">
                                <el-table :data="filteredRatingsData" style="width: 100%" stripe>
                                    <el-table-column prop="userName" label="用户名" width="120">
                                        <template #default="scope">
                                            <span>{{ scope.row.userName || '匿名用户' }}</span>
                                        </template>
                                    </el-table-column>
                                    <el-table-column label="餐厅 + 菜品" width="280">
                                        <template #default="scope">
                                            <div>
                                                <div style="font-weight: bold; color: #409eff;">{{ scope.row.restaurantName }}</div>
                                                <div style="font-size: 12px; color: #666;">{{ scope.row.dishName }}</div>
                                            </div>
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="rating" label="评分" width="120">
                                        <template #default="scope">
                                            <div style="display: flex; align-items: center;">
                                                <span style="font-size: 16px; margin-right: 5px;">{{ generateStars(scope.row.rating) }}</span>
                                                <span style="color: #666; font-size: 14px;">({{ scope.row.rating }})</span>
                                            </div>
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="comment" label="评价内容" min-width="250">
                                        <template #default="scope">
                                            <div v-if="scope.row.comment && scope.row.comment.trim()" style="max-height: 60px; overflow-y: auto;">
                                                {{ scope.row.comment }}
                                            </div>
                                            <span v-else style="color: #999; font-style: italic;">无评价内容</span>
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="likesCount" label="点赞数" width="80">
                                        <template #default="scope">
                                            <el-tag size="small" type="success">{{ scope.row.likesCount || 0 }}</el-tag>
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="createdAt" label="发布时间" width="160">
                                        <template #default="scope">
                                            <div style="font-size: 12px;">
                                                <div>{{ formatDate(scope.row.createdAt) }}</div>
                                                <div style="color: #666;">{{ formatTime(scope.row.createdAt) }}</div>
                                            </div>
                                        </template>
                                    </el-table-column>
                                    <el-table-column label="操作" width="160">
                                        <template #default="scope">
                                            <el-button size="small" @click="viewRatingDetail(scope.row)">
                                                查看详情
                                            </el-button>
                                            <el-button size="small" type="danger" @click="confirmDeleteRating(scope.row)">
                                                删除
                                            </el-button>
                                        </template>
                                    </el-table-column>
                                </el-table>
                            </div>
                            
                            <!-- 分页 -->
                            <div style="margin-top: 20px; text-align: center;">
                                <el-pagination
                                    v-model:current-page="ratingCurrentPage"
                                    v-model:page-size="ratingPageSize"
                                    :page-sizes="[10, 20, 50, 100]"
                                    :total="totalFilteredRatings"
                                    layout="total, sizes, prev, pager, next, jumper"
                                    @size-change="handleRatingPageSizeChange"
                                    @current-change="handleRatingCurrentChange"
                                />
                            </div>
                        </div>
                    </div>
                    
                    <!-- 用户管理页面 -->
                    <div v-if="currentPage === 'users'">
                        <!-- 统计卡片 -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number">{{ totalUsers }}</div>
                                <div class="stat-label">系统用户总数</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #36d1dc 0%, #5b86e5 100%);">
                                <div class="stat-number">{{ totalEmployees }}</div>
                                <div class="stat-label">员工用户数</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                <div class="stat-number">{{ activeUsersToday }}</div>
                                <div class="stat-label">今日活跃用户</div>
                            </div>
                        </div>
                        
                        <div class="page-content">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3>👥 用户管理</h3>
                                <div>
                                    <el-button type="primary" @click="showAddEmployeeDialog">
                                        ➕ 添加员工
                                    </el-button>
                                    <el-button type="success" @click="exportUserData">
                                        📥 导出用户数据
                                    </el-button>
                                </div>
                            </div>
                            
                            <div class="table-container">
                                <el-table :data="usersData" style="width: 100%" stripe>
                                    <el-table-column prop="name" label="姓名" width="120">
                                    </el-table-column>
                                    <el-table-column prop="open_id" label="用户ID" width="120">
                                        <template #default="scope">
                                            <span style="font-family: monospace; font-size: 12px;">
                                                {{ scope.row.open_id ? scope.row.open_id.substring(0, 8) + '...' : 'N/A' }}
                                            </span>
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="department" label="部门" width="120">
                                    </el-table-column>
                                    <el-table-column label="登录方式" width="100">
                                        <template #default="scope">
                                            <el-tag type="primary">
                                                {{ scope.row.loginMethod || '飞书登录' }}
                                            </el-tag>
                                        </template>
                                    </el-table-column>
                                    <el-table-column label="用户角色" width="120">
                                        <template #default="scope">
                                            <el-tag :type="scope.row.role === 'admin' ? 'danger' : 'success'">
                                                {{ scope.row.role === 'admin' ? '管理员' : '普通用户' }}
                                            </el-tag>
                                            <el-tag type="warning" size="small" v-if="scope.row.isDefaultAdmin" style="margin-left: 5px;">
                                                默认
                                            </el-tag>
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="ratingCount" label="评价次数" width="100">
                                    </el-table-column>
                                    <el-table-column prop="registerTimeFormatted" label="注册时间" width="120">
                                    </el-table-column>
                                    <el-table-column prop="lastLoginFormatted" label="最后登录" width="120">
                                    </el-table-column>
                                    <el-table-column label="操作" width="260">
                                        <template #default="scope">
                                            <el-button size="small" @click="viewUserDetail(scope.row)">
                                                查看详情
                                            </el-button>
                                            <el-button size="small" type="primary" @click="showSetRoleDialog(scope.row)" 
                                                       :disabled="scope.row.isDefaultAdmin">
                                                设置角色
                                            </el-button>
                                            <el-button size="small" type="warning" @click="editUser(scope.row)" v-if="scope.row.isEmployee">
                                                编辑
                                            </el-button>
                                        </template>
                                    </el-table-column>
                                </el-table>
                            </div>
                        </div>
                    </div>
                    
                </div>
                
                <!-- 设置用户角色对话框 -->
                <el-dialog 
                    title="设置用户角色" 
                    v-model="showRoleDialog" 
                    width="500px"
                    :close-on-click-modal="false">
                    <div v-if="selectedUser">
                        <div style="margin-bottom: 20px;">
                            <strong>用户信息：</strong>
                            <div style="margin-top: 10px; padding: 15px; background: #f5f7fa; border-radius: 8px;">
                                <div><strong>姓名：</strong>{{ selectedUser.name }}</div>
                                <div><strong>用户ID：</strong>{{ selectedUser.id }}</div>
                                <div><strong>登录方式：</strong>{{ selectedUser.loginMethod || '飞书登录' }}</div>
                                <div><strong>当前角色：</strong>
                                    <el-tag :type="selectedUser.role === 'admin' ? 'danger' : 'success'">
                                        {{ selectedUser.role === 'admin' ? '管理员' : '普通用户' }}
                                    </el-tag>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <strong>选择新角色：</strong>
                            <el-radio-group v-model="newUserRole" style="margin-top: 10px;">
                                <el-radio value="user">
                                    <div style="display: flex; flex-direction: column; margin-left: 10px;">
                                        <span style="font-weight: bold;">普通用户</span>
                                        <span style="color: #666; font-size: 12px;">仅能访问用户中心页面，拥有点餐、评价和投稿功能</span>
                                    </div>
                                </el-radio>
                                <el-radio value="admin" style="margin-top: 15px;">
                                    <div style="display: flex; flex-direction: column; margin-left: 10px;">
                                        <span style="font-weight: bold;">管理员</span>
                                        <span style="color: #666; font-size: 12px;">拥有管理员页面和用户页面的查看编辑权限</span>
                                    </div>
                                </el-radio>
                            </el-radio-group>
                        </div>
                        
                        <div v-if="selectedUser.isDefaultAdmin" style="padding: 10px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; color: #856404;">
                            <i class="el-icon-warning" style="margin-right: 5px;"></i>
                            <strong>注意：</strong>此用户为系统默认管理员，无法修改角色。
                        </div>
                    </div>
                    
                    <template #footer>
                        <span class="dialog-footer">
                            <el-button @click="showRoleDialog = false">取消</el-button>
                            <el-button type="primary" @click="confirmSetUserRole" :loading="settingRole" 
                                       :disabled="selectedUser && selectedUser.isDefaultAdmin">
                                确定设置
                            </el-button>
                        </span>
                    </template>
                </el-dialog>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.8/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/element-plus@2.4.4/dist/index.full.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@element-plus/icons-vue@2.1.0/dist/index.iife.min.js"></script>
    <script>
        const { createApp } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;
        const { Plus } = ElementPlusIconsVue;

        createApp({
            data() {
                return {
                    currentPage: 'dishes', // 默认进入菜品管理页面
                    
                    // 菜品数据
                    dishesData: [],
                    totalDishes: 0,
                    totalRestaurants: 0,
                    avgRating: 0,
                    
                    // 菜单管理数据
                    selectedPeriod: 'today',
                    selectedDate: new Date(),
                    dailyMenu: {
                        lunch: [],
                        dinner: []
                    },
                    
                    // 当前菜单显示数据
                    currentMenuData: {
                        hasMenu: false,
                        lunch: [],
                        dinner: [],
                        date: null
                    },
                    loadingCurrentMenu: false,
                    
                    // 菜单编辑对话框
                    showEditMealDialog: false,
                    editingMealType: '', // 'lunch' or 'dinner'
                    editingMealDishes: [],
                    weeklyMenu: {
                        monday: { lunch: [], dinner: [] },
                        tuesday: { lunch: [], dinner: [] },
                        wednesday: { lunch: [], dinner: [] },
                        thursday: { lunch: [], dinner: [] },
                        friday: { lunch: [], dinner: [] },
                        saturday: { lunch: [], dinner: [] },
                        sunday: { lunch: [], dinner: [] }
                    },
                    // 营业日：周一-周五 + 周日 (6天)
                    weekDays: [
                        { key: 'monday', label: '周一' },
                        { key: 'tuesday', label: '周二' },
                        { key: 'wednesday', label: '周三' },
                        { key: 'thursday', label: '周四' },
                        { key: 'friday', label: '周五' },
                        { key: 'sunday', label: '周日' }
                    ],
                    
                    // 菜单生成历史记录（用于3天不重复规则）
                    menuHistory: [],
                    
                    // 放纵餐标签
                    indulgentTags: ['放纵餐'],
                    
                    // 菜单操作状态
                    generatingMenu: false,
                    savingMenu: false,
                    publishingMenu: false,
                    
                    // 菜品库管理
                    selectedDishes: [],
                    dishSearch: '',
                    restaurantFilter: '',
                    tagFilter: '',
                    statusFilter: '',
                    filteredDishes: [],
                    loadingDishes: false,
                    
                    // 分页
                    tablePage: 1,
                    pageSize: 20,
                    totalFilteredDishes: 0,
                    
                    // 添加菜品弹窗
                    showAddDishModal: false,
                    isEditMode: false, // 标识是否为编辑模式
                    newDishForm: {
                        id: null, // 编辑时存储菜品ID
                        restaurantName: '',
                        name: '',
                        tags: [],
                        imageUrl: ''
                    },
                    dishFormRules: {
                        restaurantName: [
                            { required: true, message: '请输入餐厅名称', trigger: 'blur' }
                        ],
                        name: [
                            { required: true, message: '请输入菜品名称', trigger: 'blur' }
                        ]
                    },
                    addingDish: false,
                    token: localStorage.getItem('adminToken') || '',
                    
                    // 菜品选择弹窗
                    showDishSelectionModal: false,
                    dishSelectionSearch: '',
                    selectionFilteredDishes: [],
                    currentMenuAction: null, // { type: 'add'|'replace', mealType: 'lunch'|'dinner', index?: number }
                    
                    // 点餐记录相关数据
                    ordersData: [],
                    totalOrderRecords: 0,
                    todayOrderRecords: 0,
                    totalOrderCount: 0,
                    todayLunchOrderCount: 0,
                    todayDinnerOrderCount: 0,
                    
                    // 日期筛选相关
                    orderDateRange: null,
                    orderDateQuickSelect: 'default', // 'default', 'today', 'week', 'month', 'custom'
                    
                    // 菜品评价相关数据
                    ratingsData: [],
                    filteredRatingsData: [],
                    totalRatings: 0,
                    todayRatings: 0,
                    avgOverallRating: 0,
                    // 新的统计数据
                    weeklyAvgRating: 0,
                    weeklyNewRatings: 0,
                    poorRatingPercentage: 0,
                    // 筛选和搜索参数
                    ratingSearchKeyword: '',
                    ratingTimeFilter: 'all',
                    ratingDateRange: null,
                    ratingScoreFilter: 'all',
                    ratingLikesFilter: 'all',
                    ratingSortBy: 'time_desc',
                    // 分页参数
                    ratingCurrentPage: 1,
                    ratingPageSize: 20,
                    totalFilteredRatings: 0,
                    
                    // 用户管理相关数据
                    usersData: [],
                    totalUsers: 0,
                    totalEmployees: 0,
                    activeUsersToday: 0,
                    
                    // 用户角色管理相关数据
                    showRoleDialog: false,
                    selectedUser: null,
                    newUserRole: 'user',
                    settingRole: false,
                    
                    // 系统配置相关数据
                    systemConfig: {
                        totalPeople: {
                            lunch: 50,
                            dinner: 45
                        },
                        totalEmployees: 100,
                        createdAt: null,
                        updatedAt: null
                    }
                };
            },
            computed: {
                uniqueRestaurants() {
                    const restaurants = [...new Set(this.dishesData.map(dish => dish.restaurantName))];
                    return restaurants.sort();
                },
                
                paginatedDishes() {
                    const start = (this.tablePage - 1) * this.pageSize;
                    const end = start + this.pageSize;
                    return this.filteredDishes.slice(start, end);
                }
            },
            mounted() {
                this.loadDishesData();
                this.loadMenuForPeriod(); // 初始化菜单数据
                this.loadCurrentMenu(); // 加载当前菜单显示
                
                // 检查URL参数确定当前页面
                const urlParams = new URLSearchParams(window.location.search);
                const page = urlParams.get('page');
                if (page && ['dishes', 'orders', 'ratings', 'users'].includes(page)) {
                    this.currentPage = page;
                }
                
                // 如果是点餐记录页面，加载设置数据
                if (this.currentPage === 'orders') {
                    this.loadSettings();
                }
            },
            methods: {
                switchPage(page) {
                    this.currentPage = page;
                    // 更新URL但不刷新页面
                    const newUrl = `${window.location.pathname}?page=${page}`;
                    window.history.pushState({ page }, '', newUrl);
                    
                    // 根据页面加载对应数据
                    if (page === 'dishes') {
                        this.loadDishesData();
                    } else if (page === 'orders') {
                        this.loadOrdersData();
                        this.loadSettings();
                    } else if (page === 'ratings') {
                        this.loadRatingsData();
                    } else if (page === 'users') {
                        this.loadUsersData();
                    }
                },
                
                getPageTitle() {
                    const titles = {
                        dishes: '菜品管理',
                        orders: '点餐记录管理', 
                        ratings: '菜品评价记录',
                        users: '用户管理'
                    };
                    return titles[this.currentPage] || '菜品管理';
                },
                
                getPageSubtitle() {
                    const subtitles = {
                        dishes: '管理系统菜品库，生成每日菜单',
                        orders: '查看和管理用户点餐记录',
                        ratings: '查看用户对菜品的评价反馈', 
                        users: '管理系统用户和权限'
                    };
                    return subtitles[this.currentPage] || '';
                },
                
                // === 当前菜单管理 ===
                async loadCurrentMenu() {
                    this.loadingCurrentMenu = true;
                    try {
                        const response = await fetch('/api/menu/today');
                        const result = await response.json();
                        
                        if (result.success && result.data) {
                            this.currentMenuData = {
                                hasMenu: true,
                                lunch: result.data.lunch || [],
                                dinner: result.data.dinner || [],
                                date: result.data.date
                            };
                        } else {
                            this.currentMenuData = {
                                hasMenu: false,
                                lunch: [],
                                dinner: [],
                                date: null
                            };
                        }
                    } catch (error) {
                        console.error('加载当前菜单失败:', error);
                        ElMessage.error('加载当前菜单失败');
                        this.currentMenuData.hasMenu = false;
                    }
                    this.loadingCurrentMenu = false;
                },
                
                editMeal(mealType) {
                    // 准备编辑对话框的数据
                    this.editingMealType = mealType;
                    this.editingMealDishes = [...this.currentMenuData[mealType]];
                    this.showEditMealDialog = true;
                },
                
                async saveCurrentMenuChanges() {
                    try {
                        const menuData = {
                            lunch: this.editingMealType === 'lunch' ? this.editingMealDishes : this.currentMenuData.lunch,
                            dinner: this.editingMealType === 'dinner' ? this.editingMealDishes : this.currentMenuData.dinner,
                            date: new Date().toISOString().split('T')[0]
                        };
                        
                        const response = await fetch('/api/admin/menu/update', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(menuData)
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            ElMessage.success('菜单更新成功');
                            this.showEditMealDialog = false;
                            this.loadCurrentMenu(); // 重新加载当前菜单
                        } else {
                            ElMessage.error(result.message || '菜单更新失败');
                        }
                    } catch (error) {
                        console.error('保存菜单失败:', error);
                        ElMessage.error('保存菜单失败');
                    }
                },
                
                removeDishFromEditing(index) {
                    this.editingMealDishes.splice(index, 1);
                },
                
                // === 菜品数据管理 ===
                async loadDishesData() {
                    this.loadingDishes = true;
                    try {
                        const response = await fetch('/api/admin/dishes');
                        const result = await response.json();
                        if (result.success) {
                            this.dishesData = result.data.map(dish => ({
                                ...dish,
                                tags: dish.tags || [],
                                status: dish.status || 'active'
                            }));
                            this.calculateStats();
                            this.filterDishes();
                        }
                    } catch (error) {
                        console.error('加载菜品数据失败:', error);
                        ElMessage.error('加载菜品数据失败');
                    }
                    this.loadingDishes = false;
                },
                
                calculateStats() {
                    this.totalDishes = this.dishesData.length;
                    
                    const restaurants = [...new Set(this.dishesData.map(dish => dish.restaurantName))];
                    this.totalRestaurants = restaurants.length;
                    
                    const ratedDishes = this.dishesData.filter(dish => dish.rating && dish.rating > 0);
                    if (ratedDishes.length > 0) {
                        const totalRating = ratedDishes.reduce((sum, dish) => sum + dish.rating, 0);
                        this.avgRating = (totalRating / ratedDishes.length).toFixed(1);
                    } else {
                        this.avgRating = '暂无';
                    }
                },
                
                // === 菜品库管理 ===
                filterDishes() {
                    let filtered = this.dishesData;
                    
                    // 按菜品名称搜索
                    if (this.dishSearch.trim()) {
                        filtered = filtered.filter(dish => 
                            dish.name.toLowerCase().includes(this.dishSearch.toLowerCase()) ||
                            dish.restaurantName.toLowerCase().includes(this.dishSearch.toLowerCase())
                        );
                    }
                    
                    // 按餐厅筛选
                    if (this.restaurantFilter) {
                        filtered = filtered.filter(dish => dish.restaurantName === this.restaurantFilter);
                    }
                    
                    // 按标签筛选
                    if (this.tagFilter) {
                        filtered = filtered.filter(dish => dish.tags && dish.tags.includes(this.tagFilter));
                    }
                    
                    // 按状态筛选
                    if (this.statusFilter) {
                        filtered = filtered.filter(dish => dish.status === this.statusFilter);
                    }
                    
                    this.filteredDishes = filtered;
                    this.totalFilteredDishes = filtered.length;
                    this.tablePage = 1; // 重置到第一页
                },
                
                handleSelectionChange(selection) {
                    this.selectedDishes = selection;
                },
                
                handleSizeChange(newSize) {
                    this.pageSize = newSize;
                    this.tablePage = 1;
                },
                
                handleCurrentChange(newPage) {
                    this.tablePage = newPage;
                },
                
                getTagType(tag) {
                    const typeMap = {
                        'meat': '',
                        'vegetarian': 'success',
                        'spicy': 'danger',
                        'mild': 'info',
                        'specialty': 'warning'
                    };
                    return typeMap[tag] || '';
                },
                
                getTagLabel(tag) {
                    const labelMap = {
                        'meat': '荤菜',
                        'vegetarian': '素食',
                        'spicy': '辛辣',
                        'mild': '清淡',
                        'specialty': '招牌'
                    };
                    return labelMap[tag] || tag;
                },
                
                // === 添加/编辑菜品 ===
                showAddDishDialog() {
                    this.showAddDishModal = true;
                    this.resetDishForm();
                },
                
                resetDishForm() {
                    this.isEditMode = false;
                    this.newDishForm = {
                        id: null,
                        restaurantName: '',
                        name: '',
                        tags: [],
                        imageUrl: ''
                    };
                },
                
                handleAddDishClose() {
                    this.showAddDishModal = false;
                    this.resetDishForm();
                },
                
                async submitAddDish() {
                    if (!this.$refs.dishForm) return;
                    
                    try {
                        await this.$refs.dishForm.validate();
                        
                        this.addingDish = true;
                        
                        let response;
                        if (this.isEditMode) {
                            // 编辑模式：使用PUT方法更新现有菜品
                            const { id, ...formData } = this.newDishForm; // 排除id字段
                            response = await fetch(`/api/admin/dishes/${id}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${this.token}`
                                },
                                body: JSON.stringify(formData)
                            });
                        } else {
                            // 添加模式：使用POST方法创建新菜品
                            const { id, ...formData } = this.newDishForm; // 排除id字段
                            response = await fetch('/api/admin/dishes', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${this.token}`
                                },
                                body: JSON.stringify(formData)
                            });
                        }
                        
                        const result = await response.json();
                        if (result.success) {
                            const successMessage = this.isEditMode ? '菜品修改成功' : '菜品添加成功';
                            ElMessage.success(successMessage);
                            this.handleAddDishClose();
                            await this.loadDishesData();
                        } else {
                            const errorMessage = this.isEditMode ? '修改失败' : '添加失败';
                            ElMessage.error(result.message || errorMessage);
                        }
                    } catch (error) {
                        if (error.message) {
                            const errorMessage = this.isEditMode ? '修改菜品失败' : '添加菜品失败';
                            console.error(errorMessage + ':', error);
                            ElMessage.error(errorMessage);
                        }
                    }
                    this.addingDish = false;
                },
                
                beforeImageUpload(file) {
                    const isJPGorPNG = file.type === 'image/jpeg' || file.type === 'image/png';
                    const isLt2M = file.size / 1024 / 1024 < 2;
                    
                    if (!isJPGorPNG) {
                        ElMessage.error('图片只能是 JPG/PNG 格式!');
                    }
                    if (!isLt2M) {
                        ElMessage.error('图片大小不能超过 2MB!');
                    }
                    return isJPGorPNG && isLt2M;
                },
                
                handleImageUploadSuccess(response) {
                    if (response.success) {
                        this.newDishForm.imageUrl = response.data.url;
                        ElMessage.success('图片上传成功');
                    } else {
                        ElMessage.error('图片上传失败');
                    }
                },
                
                editDish(dish) {
                    this.isEditMode = true;
                    this.newDishForm = {
                        ...dish,
                        tags: dish.tags || []
                    };
                    this.showAddDishModal = true;
                },
                
                async toggleDishStatus(dish) {
                    try {
                        const newStatus = dish.status === 'active' ? 'inactive' : 'active';
                        const statusText = newStatus === 'active' ? '启用' : '禁用';
                        
                        const response = await fetch(`/api/admin/dishes/${dish.id}/status`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.token}`
                            },
                            body: JSON.stringify({ status: newStatus })
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            ElMessage.success(`${statusText}成功`);
                            await this.loadDishesData();
                        } else {
                            ElMessage.error(result.message || `${statusText}失败`);
                        }
                    } catch (error) {
                        console.error('更新菜品状态失败:', error);
                        ElMessage.error('操作失败');
                    }
                },
                
                async deleteDish(dish) {
                    try {
                        await ElMessageBox.confirm('确定要删除这个菜品吗？删除后无法恢复。', '确认删除', {
                            confirmButtonText: '确定删除',
                            cancelButtonText: '取消',
                            type: 'warning'
                        });
                        
                        const response = await fetch(`/api/admin/dishes/${dish.id}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${this.token}`
                            }
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            ElMessage.success('删除成功');
                            await this.loadDishesData();
                        } else {
                            ElMessage.error(result.message || '删除失败');
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('删除菜品失败:', error);
                            ElMessage.error('删除失败');
                        }
                    }
                },
                
                async batchDisableDishes() {
                    try {
                        await ElMessageBox.confirm(`确定要批量禁用选中的 ${this.selectedDishes.length} 个菜品吗？`, '批量禁用', {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning'
                        });
                        
                        const dishIds = this.selectedDishes.map(dish => dish.id);
                        const response = await fetch('/api/admin/dishes/batch-disable', {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.token}`
                            },
                            body: JSON.stringify({ dishIds })
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            ElMessage.success(`成功禁用 ${dishIds.length} 个菜品`);
                            await this.loadDishesData();
                        } else {
                            ElMessage.error(result.message || '批量禁用失败');
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('批量禁用失败:', error);
                            ElMessage.error('批量禁用失败');
                        }
                    }
                },
                
                async batchDeleteDishes() {
                    try {
                        await ElMessageBox.confirm(`确定要批量删除选中的 ${this.selectedDishes.length} 个菜品吗？删除后无法恢复！`, '批量删除', {
                            confirmButtonText: '确定删除',
                            cancelButtonText: '取消',
                            type: 'danger'
                        });
                        
                        const dishIds = this.selectedDishes.map(dish => dish.id);
                        const response = await fetch('/api/admin/dishes/batch-delete', {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.token}`
                            },
                            body: JSON.stringify({ dishIds })
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            ElMessage.success(`成功删除 ${dishIds.length} 个菜品`);
                            await this.loadDishesData();
                        } else {
                            ElMessage.error(result.message || '批量删除失败');
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('批量删除失败:', error);
                            ElMessage.error('批量删除失败');
                        }
                    }
                },
                
                // === 菜单管理 ===
                formatDateDisplay(date) {
                    if (!date) return '';
                    const d = new Date(date);
                    const month = d.getMonth() + 1;
                    const day = d.getDate();
                    const weekDay = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'][d.getDay()];
                    return `${month}月${day}日 ${weekDay}`;
                },
                
                async loadMenuForPeriod() {
                    if (this.selectedPeriod === 'today') {
                        await this.loadMenuForDate();
                    } else {
                        await this.loadWeeklyMenu();
                    }
                },
                
                async loadMenuForDate() {
                    try {
                        const dateStr = this.selectedDate.toISOString().split('T')[0];
                        const todayStr = new Date().toISOString().split('T')[0];
                        
                        // 始终使用今日菜单API，因为目前只支持当日菜单编辑
                        const response = await fetch('/api/menu/today');
                        const result = await response.json();
                        
                        if (result.success && result.data) {
                            // 转换菜单数据格式为餐厅式显示
                            this.dailyMenu = {
                                lunch: this.convertToRestaurantFormat(result.data.lunch || []),
                                dinner: this.convertToRestaurantFormat(result.data.dinner || [])
                            };
                        } else {
                            this.dailyMenu = { lunch: [], dinner: [] };
                        }
                        
                        // 加载草稿菜单（如果存在）
                        await this.loadMenuDraft();
                    } catch (error) {
                        console.error('加载日菜单失败:', error);
                        this.dailyMenu = { lunch: [], dinner: [] };
                    }
                },
                
                // 转换菜单格式为餐厅式显示格式
                convertToRestaurantFormat(dishes) {
                    if (!Array.isArray(dishes) || dishes.length === 0) {
                        return [];
                    }
                    
                    // 按餐厅分组
                    const restaurantGroups = {};
                    dishes.forEach(dish => {
                        if (!restaurantGroups[dish.restaurantName]) {
                            restaurantGroups[dish.restaurantName] = [];
                        }
                        restaurantGroups[dish.restaurantName].push({
                            id: dish.dishId,
                            name: dish.dishName,
                            tags: dish.tags || []
                        });
                    });
                    
                    // 转换为餐厅式菜单格式
                    return Object.keys(restaurantGroups).map(restaurantName => ({
                        isRestaurantMenu: true,
                        restaurantName: restaurantName,
                        dishes: restaurantGroups[restaurantName]
                    }));
                },
                
                async loadWeeklyMenu() {
                    try {
                        const weekStart = this.getWeekStart(this.selectedPeriod);
                        const response = await fetch('/api/menu/week');
                        
                        const result = await response.json();
                        if (result.success && result.data) {
                            // 转换API返回的数字索引格式为前端期望的命名天格式
                            const dayNames = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                            const convertedData = {};
                            
                            // 只处理工作日 + 周日（0-4, 6）
                            dayNames.forEach((dayName, index) => {
                                if (index === 5) return; // 跳过周六
                                
                                const apiIndex = index === 6 ? 5 : index; // 周日在API中是索引5
                                const dayData = result.data[apiIndex.toString()];
                                
                                if (dayData) {
                                    // 转换菜单数据格式为餐厅式显示
                                    convertedData[dayName] = {
                                        lunch: this.convertToRestaurantFormat(dayData.lunch || []),
                                        dinner: this.convertToRestaurantFormat(dayData.dinner || [])
                                    };
                                } else {
                                    convertedData[dayName] = { lunch: [], dinner: [] };
                                }
                            });
                            
                            this.weeklyMenu = convertedData;
                        } else {
                            this.weeklyMenu = this.getEmptyWeeklyMenu();
                        }
                        
                        // 加载草稿菜单（如果存在）
                        await this.loadMenuDraft();
                    } catch (error) {
                        console.error('加载周菜单失败:', error);
                        this.weeklyMenu = this.getEmptyWeeklyMenu();
                    }
                },
                
                getWeekStart(period) {
                    const today = new Date();
                    const day = today.getDay(); // 0=周日, 1=周一...6=周六
                    let weekStart;
                    
                    if (day === 6) { // 如果今天是周六
                        // 从明天(周日)开始的一周
                        weekStart = new Date(today);
                        weekStart.setDate(today.getDate() + 1);
                        // 调整到周日（如果明天不是周日的话）
                        const nextDay = weekStart.getDay();
                        if (nextDay !== 0) {
                            weekStart.setDate(weekStart.getDate() - nextDay);
                        }
                    } else {
                        // 周日到周五：显示本周的周日开始
                        const diff = today.getDate() - day;
                        weekStart = new Date(today.setDate(diff));
                    }
                    
                    if (period === 'nextWeek') {
                        weekStart.setDate(weekStart.getDate() + 7);
                    }
                    
                    return weekStart.toISOString().split('T')[0];
                },
                
                getEmptyWeeklyMenu() {
                    return {
                        monday: { lunch: [], dinner: [] },
                        tuesday: { lunch: [], dinner: [] },
                        wednesday: { lunch: [], dinner: [] },
                        thursday: { lunch: [], dinner: [] },
                        friday: { lunch: [], dinner: [] },
                        sunday: { lunch: [], dinner: [] }
                    };
                },
                
                async generateRandomMenu() {
                    try {
                        this.generatingMenu = true;
                        
                        // 如果是本地生成，使用新的算法
                        if (this.selectedPeriod === 'today') {
                            await this.generateDailyRestaurantMenu();
                        } else {
                            await this.generateWeeklyRestaurantMenu();
                        }
                        
                        ElMessage.success('随机菜单生成成功');
                    } catch (error) {
                        console.error('生成随机菜单失败:', error);
                        ElMessage.error('生成随机菜单失败');
                    }
                    this.generatingMenu = false;
                },
                
                // 生成基于餐厅的每日菜单
                async generateDailyRestaurantMenu() {
                    const selectedDate = this.selectedDate;
                    const dayOfWeek = selectedDate.getDay();
                    
                    // 获取可用餐厅列表
                    const restaurants = this.getAvailableRestaurants();
                    
                    // 生成午餐菜单
                    const lunchRestaurant = this.selectRestaurantForMeal(restaurants, selectedDate, 'lunch');
                    this.dailyMenu.lunch = lunchRestaurant ? this.getRestaurantMenuData(lunchRestaurant) : [];
                    
                    // 生成晚餐菜单
                    const dinnerRestaurant = this.selectRestaurantForMeal(restaurants, selectedDate, 'dinner', lunchRestaurant);
                    this.dailyMenu.dinner = dinnerRestaurant ? this.getRestaurantMenuData(dinnerRestaurant) : [];
                    
                    // 更新菜单历史
                    this.updateMenuHistory(selectedDate, {
                        lunch: lunchRestaurant ? [lunchRestaurant] : [],
                        dinner: dinnerRestaurant ? [dinnerRestaurant] : []
                    });
                },
                
                // 生成基于餐厅的周菜单
                async generateWeeklyRestaurantMenu() {
                    const weekStart = new Date(this.getWeekStart(this.selectedPeriod));
                    const restaurants = this.getAvailableRestaurants();
                    const weekMenu = {};
                    
                    // 为每一天生成菜单
                    for (const day of this.weekDays) {
                        const dayDate = new Date(weekStart);
                        const dayIndex = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'].indexOf(day.key);
                        dayDate.setDate(weekStart.getDate() + dayIndex);
                        
                        // 生成午餐菜单
                        const lunchRestaurant = this.selectRestaurantForMeal(restaurants, dayDate, 'lunch');
                        
                        // 生成晚餐菜单
                        const dinnerRestaurant = this.selectRestaurantForMeal(restaurants, dayDate, 'dinner', lunchRestaurant);
                        
                        weekMenu[day.key] = {
                            lunch: lunchRestaurant ? this.getRestaurantMenuData(lunchRestaurant) : [],
                            dinner: dinnerRestaurant ? this.getRestaurantMenuData(dinnerRestaurant) : []
                        };
                        
                        // 更新菜单历史
                        this.updateMenuHistory(dayDate, {
                            lunch: lunchRestaurant ? [lunchRestaurant] : [],
                            dinner: dinnerRestaurant ? [dinnerRestaurant] : []
                        });
                    }
                    
                    this.weeklyMenu = weekMenu;
                    
                    // 生成后自动保存为草稿
                    await this.autoSaveMenuDraft();
                },
                
                // 获取可用餐厅列表
                getAvailableRestaurants() {
                    // 按餐厅分组菜品
                    const restaurantMap = {};
                    
                    this.dishesData
                        .filter(dish => dish.status === 'active')
                        .forEach(dish => {
                            if (!restaurantMap[dish.restaurantName]) {
                                restaurantMap[dish.restaurantName] = {
                                    name: dish.restaurantName,
                                    dishes: [],
                                    avgRating: 0,
                                    totalRatingCount: 0,
                                    hasIndulgent: false,
                                    isNew: false
                                };
                            }
                            
                            const restaurant = restaurantMap[dish.restaurantName];
                            restaurant.dishes.push(dish);
                            
                            // 计算平均评分
                            if (dish.rating && dish.ratingCount) {
                                restaurant.totalRatingCount += dish.ratingCount;
                                restaurant.avgRating += dish.rating * dish.ratingCount;
                            }
                            
                            // 检查是否有放纵餐
                            if (dish.tags && dish.tags.some(tag => this.indulgentTags.includes(tag))) {
                                restaurant.hasIndulgent = true;
                            }
                            
                            // 检查是否是新菜品（最近7天添加）
                            if (dish.createdAt && new Date(dish.createdAt) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)) {
                                restaurant.isNew = true;
                            }
                        });
                    
                    // 计算最终平均评分
                    Object.values(restaurantMap).forEach(restaurant => {
                        if (restaurant.totalRatingCount > 0) {
                            restaurant.avgRating = restaurant.avgRating / restaurant.totalRatingCount;
                        } else {
                            restaurant.avgRating = 0;
                        }
                    });
                    
                    // 按优先级排序：新餐厅 > 高评分餐厅 > 其他
                    const restaurants = Object.values(restaurantMap);
                    return restaurants.sort((a, b) => {
                        // 新餐厅优先
                        if (a.isNew !== b.isNew) {
                            return a.isNew ? -1 : 1;
                        }
                        // 评分高的优先
                        return b.avgRating - a.avgRating;
                    });
                },
                
                // 为特定餐次选择餐厅
                selectRestaurantForMeal(restaurants, date, mealType, excludeRestaurant = null) {
                    const dayOfWeek = date.getDay();
                    const isFridayDinner = dayOfWeek === 5 && mealType === 'dinner';
                    
                    // 获取过去3天的餐厅历史
                    const recentRestaurants = this.getRecentRestaurants(date, 3);
                    
                    let availableRestaurants = restaurants.filter(restaurant => {
                        // 排除当前餐次已选择的餐厅
                        if (excludeRestaurant && restaurant.name === excludeRestaurant.name) {
                            return false;
                        }
                        
                        // 排除最近3天使用过的餐厅
                        if (recentRestaurants.includes(restaurant.name)) {
                            return false;
                        }
                        
                        // 如果不是周五晚餐，排除放纵餐餐厅
                        if (!isFridayDinner && restaurant.hasIndulgent) {
                            return false;
                        }
                        
                        // 如果是周五晚餐，优先选择放纵餐餐厅
                        return true;
                    });
                    
                    // 如果是周五晚餐，优先选择有放纵餐的餐厅
                    if (isFridayDinner) {
                        const indulgentRestaurants = availableRestaurants.filter(r => r.hasIndulgent);
                        if (indulgentRestaurants.length > 0) {
                            availableRestaurants = indulgentRestaurants;
                        }
                    }
                    
                    // 如果没有可用餐厅，放宽限制
                    if (availableRestaurants.length === 0) {
                        availableRestaurants = restaurants.filter(restaurant => {
                            return excludeRestaurant && restaurant.name !== excludeRestaurant.name;
                        });
                    }
                    
                    // 随机选择（已经按优先级排序）
                    if (availableRestaurants.length === 0) {
                        return null;
                    }
                    
                    // 从前30%的高优先级餐厅中随机选择
                    const topRestaurantsCount = Math.max(1, Math.ceil(availableRestaurants.length * 0.3));
                    const topRestaurants = availableRestaurants.slice(0, topRestaurantsCount);
                    
                    return topRestaurants[Math.floor(Math.random() * topRestaurants.length)];
                },
                
                // 获取最近几天使用过的餐厅
                getRecentRestaurants(currentDate, days) {
                    const recentRestaurants = [];
                    const startDate = new Date(currentDate);
                    startDate.setDate(startDate.getDate() - days);
                    
                    for (const entry of this.menuHistory) {
                        const entryDate = new Date(entry.date);
                        if (entryDate >= startDate && entryDate < currentDate) {
                            recentRestaurants.push(...entry.restaurants.lunch);
                            recentRestaurants.push(...entry.restaurants.dinner);
                        }
                    }
                    
                    return [...new Set(recentRestaurants)];
                },
                
                // 更新菜单历史
                updateMenuHistory(date, restaurantMenu) {
                    const dateStr = date.toISOString().split('T')[0];
                    const existingIndex = this.menuHistory.findIndex(entry => entry.date === dateStr);
                    
                    const historyEntry = {
                        date: dateStr,
                        restaurants: {
                            lunch: restaurantMenu.lunch.map(r => r.name || r),
                            dinner: restaurantMenu.dinner.map(r => r.name || r)
                        }
                    };
                    
                    if (existingIndex >= 0) {
                        this.menuHistory[existingIndex] = historyEntry;
                    } else {
                        this.menuHistory.push(historyEntry);
                    }
                    
                    // 只保留最近30天的历史
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    this.menuHistory = this.menuHistory.filter(entry => 
                        new Date(entry.date) >= thirtyDaysAgo
                    );
                },
                
                // 获取餐厅的菜单数据结构
                getRestaurantMenuData(restaurant) {
                    return [{
                        id: `restaurant_${restaurant.name}`,
                        restaurantName: restaurant.name,
                        name: '本日菜品',
                        dishes: restaurant.dishes.map(dish => ({
                            id: dish.id,
                            name: dish.name,
                            restaurantName: dish.restaurantName,
                            tags: dish.tags,
                            rating: dish.rating,
                            imageUrl: dish.imageUrl
                        })),
                        isRestaurantMenu: true,
                        rating: restaurant.avgRating
                    }];
                },
                
                addDishToMenu(mealType) {
                    this.currentMenuAction = { type: 'add', mealType };
                    this.showDishSelectionModal = true;
                    this.filterSelectionDishes();
                },
                
                replaceDish(mealType, index) {
                    this.currentMenuAction = { type: 'replace', mealType, index };
                    this.showDishSelectionModal = true;
                    this.filterSelectionDishes();
                },
                
                removeDish(mealType, index) {
                    this.dailyMenu[mealType].splice(index, 1);
                },
                
                addDishToWeeklyMenu(dayKey, mealType) {
                    this.currentMenuAction = { type: 'add', dayKey, mealType };
                    this.showDishSelectionModal = true;
                    this.filterSelectionDishes();
                },
                
                removeWeeklyDish(dayKey, mealType, index) {
                    if (!this.weeklyMenu[dayKey]) {
                        this.weeklyMenu[dayKey] = { lunch: [], dinner: [] };
                    }
                    this.weeklyMenu[dayKey][mealType].splice(index, 1);
                },
                
                handleDishSelectionClose() {
                    this.showDishSelectionModal = false;
                    this.dishSelectionSearch = '';
                    this.currentMenuAction = null;
                },
                
                filterSelectionDishes() {
                    let filtered = this.dishesData.filter(dish => dish.status === 'active');
                    
                    if (this.dishSelectionSearch.trim()) {
                        filtered = filtered.filter(dish => 
                            dish.name.toLowerCase().includes(this.dishSelectionSearch.toLowerCase()) ||
                            dish.restaurantName.toLowerCase().includes(this.dishSelectionSearch.toLowerCase())
                        );
                    }
                    
                    this.selectionFilteredDishes = filtered;
                },
                
                selectDishForMenu(dish) {
                    if (!this.currentMenuAction) return;
                    
                    const { type, mealType, index, dayKey } = this.currentMenuAction;
                    
                    if (dayKey) {
                        // 周菜单操作
                        if (!this.weeklyMenu[dayKey]) {
                            this.weeklyMenu[dayKey] = { lunch: [], dinner: [] };
                        }
                        
                        if (type === 'add') {
                            this.weeklyMenu[dayKey][mealType].push(dish);
                        } else if (type === 'replace' && index !== undefined) {
                            this.weeklyMenu[dayKey][mealType].splice(index, 1, dish);
                        }
                    } else {
                        // 日菜单操作
                        if (type === 'add') {
                            this.dailyMenu[mealType].push(dish);
                        } else if (type === 'replace' && index !== undefined) {
                            this.dailyMenu[mealType].splice(index, 1, dish);
                        }
                    }
                    
                    this.handleDishSelectionClose();
                    ElMessage.success('菜品添加成功');
                },
                
                async saveMenu() {
                    try {
                        this.savingMenu = true;
                        
                        const menuData = this.selectedPeriod === 'today' ? {
                            type: 'daily',
                            date: this.selectedDate.toISOString().split('T')[0],
                            menu: this.dailyMenu
                        } : {
                            type: 'weekly',
                            weekStart: this.getWeekStart(this.selectedPeriod),
                            menu: this.weeklyMenu
                        };
                        
                        const response = await fetch('/api/admin/menu/save', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.token}`
                            },
                            body: JSON.stringify(menuData)
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            ElMessage.success('菜单已保存为草稿');
                        } else {
                            ElMessage.error(result.message || '保存失败');
                        }
                    } catch (error) {
                        console.error('保存菜单失败:', error);
                        ElMessage.error('保存菜单失败');
                    }
                    this.savingMenu = false;
                },
                
                // 自动保存菜单草稿
                async autoSaveMenuDraft() {
                    try {
                        const menuData = this.selectedPeriod === 'today' ? {
                            type: 'daily',
                            date: this.selectedDate.toISOString().split('T')[0],
                            menu: this.dailyMenu
                        } : {
                            type: 'weekly',
                            weekStart: this.getWeekStart(this.selectedPeriod),
                            menu: this.weeklyMenu
                        };
                        
                        const response = await fetch('/api/admin/menu/save', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.token}`
                            },
                            body: JSON.stringify(menuData)
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            console.log('菜单草稿自动保存成功');
                        }
                    } catch (error) {
                        console.error('自动保存菜单草稿失败:', error);
                    }
                },
                
                // 加载菜单草稿
                async loadMenuDraft() {
                    try {
                        const params = new URLSearchParams();
                        if (this.selectedPeriod === 'today') {
                            params.append('type', 'daily');
                            params.append('date', this.selectedDate.toISOString().split('T')[0]);
                        } else {
                            params.append('type', 'weekly');
                            params.append('weekStart', this.getWeekStart(this.selectedPeriod));
                        }
                        
                        const response = await fetch(`/api/admin/menu/drafts?${params.toString()}`, {
                            headers: {
                                'Authorization': `Bearer ${this.token}`
                            }
                        });
                        
                        const result = await response.json();
                        if (result.success && result.data) {
                            if (this.selectedPeriod === 'today') {
                                this.dailyMenu = {
                                    lunch: result.data.lunch || [],
                                    dinner: result.data.dinner || []
                                };
                            } else {
                                this.weeklyMenu = result.data.menu || {};
                            }
                            console.log('菜单草稿加载成功');
                        }
                    } catch (error) {
                        console.error('加载菜单草稿失败:', error);
                    }
                },
                
                async publishMenu() {
                    try {
                        await ElMessageBox.confirm('确定要发布菜单吗？发布后用户将看到新菜单。', '确认发布', {
                            confirmButtonText: '确定发布',
                            cancelButtonText: '取消',
                            type: 'warning'
                        });
                        
                        this.publishingMenu = true;
                        
                        const menuData = this.selectedPeriod === 'today' ? {
                            type: 'daily',
                            date: this.selectedDate.toISOString().split('T')[0],
                            menu: this.dailyMenu
                        } : {
                            type: 'weekly',
                            weekStart: this.getWeekStart(this.selectedPeriod),
                            menu: this.weeklyMenu
                        };
                        
                        const response = await fetch('/api/admin/menu/publish', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.token}`
                            },
                            body: JSON.stringify(menuData)
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            ElMessage.success('菜单发布成功！用户现在可以看到新菜单了');
                        } else {
                            ElMessage.error(result.message || '发布失败');
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('发布菜单失败:', error);
                            ElMessage.error('发布菜单失败');
                        }
                    }
                    this.publishingMenu = false;
                },
                
                async refreshData() {
                    if (this.currentPage === 'dishes') {
                        await this.loadDishesData();
                        ElMessage.success('数据已刷新');
                    } else if (this.currentPage === 'orders') {
                        await this.loadOrdersData();
                        ElMessage.success('数据已刷新');
                    } else if (this.currentPage === 'ratings') {
                        await this.loadRatingsData();
                        ElMessage.success('数据已刷新');
                    } else if (this.currentPage === 'users') {
                        await this.loadUsersData();
                        ElMessage.success('数据已刷新');
                    }
                },
                
                // 点餐记录管理相关方法
                async loadOrdersData() {
                    try {
                        let url = '/api/admin/orders';
                        const dateRange = this.getDateRangeForQuery();
                        
                        if (dateRange.startDate && dateRange.endDate) {
                            url += `?startDate=${dateRange.startDate}&endDate=${dateRange.endDate}`;
                        }
                        const response = await fetch(url);
                        const result = await response.json();
                        if (result.success) {
                            this.ordersData = result.data;
                            this.calculateOrderStats();
                        }
                    } catch (error) {
                        console.error('加载点餐记录失败:', error);
                        ElMessage.error('加载点餐记录失败');
                    }
                },
                
                calculateOrderStats() {
                    this.totalOrderRecords = this.ordersData.length;
                    
                    // 计算今日记录数
                    const today = new Date().toISOString().split('T')[0];
                    this.todayOrderRecords = this.ordersData.filter(order => order.date === today).length;
                    
                    // 计算总点餐人数
                    this.totalOrderCount = this.ordersData.reduce((sum, order) => sum + (order.orderCount || 0), 0);
                    
                    // 计算今日中午和晚饭点餐数量 (总人数 - 不吃人数)
                    const todayOrders = this.ordersData.filter(order => order.date === today);
                    const todayLunch = todayOrders.find(order => order.mealType === 'lunch');
                    const todayDinner = todayOrders.find(order => order.mealType === 'dinner');
                    
                    const totalEmployees = this.systemConfig.totalEmployees || 0;
                    this.todayLunchOrderCount = todayLunch ? Math.max(0, totalEmployees - (todayLunch.noEatCount || 0)) : totalEmployees;
                    this.todayDinnerOrderCount = todayDinner ? Math.max(0, totalEmployees - (todayDinner.noEatCount || 0)) : totalEmployees;
                },
                
                async toggleOrderStatus(order) {
                    try {
                        // 设置loading状态
                        order.loading = true;
                        
                        const response = await fetch('/api/admin/orders/toggle-status', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                date: order.date,
                                mealType: order.mealType
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            // 更新本地数据
                            order.status = result.data.status;
                            order.statusText = order.status === 'open' ? '开放点餐' : '已关闭';
                            ElMessage.success(result.message);
                        } else {
                            ElMessage.error(result.message || '操作失败');
                        }
                    } catch (error) {
                        console.error('切换点餐状态失败:', error);
                        ElMessage.error('切换点餐状态失败');
                    } finally {
                        // 清除loading状态
                        order.loading = false;
                    }
                },

                exportOrderData() {
                    try {
                        const csvContent = [
                            ['日期', '餐次', '总人数', '不吃人数', '点餐人数', '状态'].join(','),
                            ...this.ordersData.map(order => [
                                order.dateFormatted,
                                order.mealTypeText,
                                this.systemConfig.totalEmployees || 0,
                                order.noEatCount || 0,
                                order.orderCount || 0,
                                order.statusText
                            ].join(','))
                        ].join('\n');
                        
                        const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                        const link = document.createElement('a');
                        const url = URL.createObjectURL(blob);
                        link.setAttribute('href', url);
                        link.setAttribute('download', `点餐记录_${new Date().toISOString().split('T')[0]}.csv`);
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        ElMessage.success('数据导出成功');
                    } catch (error) {
                        console.error('导出失败:', error);
                        ElMessage.error('导出失败');
                    }
                },
                
                // 日期筛选相关方法
                getDateRangeForQuery() {
                    const today = new Date();
                    const formatDate = (date) => {
                        return date.getFullYear() + '-' + 
                               String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                               String(date.getDate()).padStart(2, '0');
                    };
                    
                    switch (this.orderDateQuickSelect) {
                        case 'today':
                            return {
                                startDate: formatDate(today),
                                endDate: formatDate(today)
                            };
                        
                        case 'week':
                            const startOfWeek = new Date(today);
                            startOfWeek.setDate(today.getDate() - today.getDay()); // 本周日
                            const endOfWeek = new Date(startOfWeek);
                            endOfWeek.setDate(startOfWeek.getDate() + 6); // 本周六
                            return {
                                startDate: formatDate(startOfWeek),
                                endDate: formatDate(endOfWeek)
                            };
                            
                        case 'month':
                            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                            const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                            return {
                                startDate: formatDate(startOfMonth),
                                endDate: formatDate(endOfMonth)
                            };
                            
                        case 'custom':
                            if (this.orderDateRange && this.orderDateRange.length === 2) {
                                return {
                                    startDate: this.orderDateRange[0],
                                    endDate: this.orderDateRange[1]
                                };
                            }
                            break;
                            
                        default: // 'default'
                            return { startDate: null, endDate: null }; // 使用服务端默认范围
                    }
                    
                    return { startDate: null, endDate: null };
                },
                
                onDateQuickSelectChange(value) {
                    if (value !== 'custom') {
                        this.orderDateRange = null;
                    }
                    // 自动查询数据
                    this.loadOrdersData();
                },
                
                onCustomDateRangeChange(dateRange) {
                    // 当自定义日期范围改变时，自动查询数据
                    if (dateRange && dateRange.length === 2) {
                        this.loadOrdersData();
                    }
                },
                
                resetDateFilter() {
                    this.orderDateQuickSelect = 'default';
                    this.orderDateRange = null;
                    this.loadOrdersData();
                },
                
                // 菜品评价记录相关方法
                async loadRatingsData() {
                    try {
                        const response = await fetch('/api/ratings');
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        const result = await response.json();
                        if (result.success) {
                            this.ratingsData = result.data || [];
                            this.calculateRatingStats();
                            this.filterRatings();
                        } else {
                            throw new Error(result.message || '服务器返回错误');
                        }
                    } catch (error) {
                        console.error('加载评价记录失败:', error);
                        ElMessage.error('加载评价记录失败: ' + error.message);
                        this.ratingsData = [];
                    }
                },
                
                calculateRatingStats() {
                    this.totalRatings = this.ratingsData.length;
                    
                    // 计算今日评价数
                    const today = new Date().toISOString().split('T')[0];
                    this.todayRatings = this.ratingsData.filter(rating => rating.date === today).length;
                    
                    // 计算总体平均评分
                    if (this.ratingsData.length > 0) {
                        const totalRating = this.ratingsData.reduce((sum, rating) => sum + (rating.rating || 0), 0);
                        this.avgOverallRating = (totalRating / this.ratingsData.length).toFixed(1);
                    } else {
                        this.avgOverallRating = '暂无';
                    }
                },
                
                viewRatingDetail(rating) {
                    const comment = rating.comment && rating.comment.trim() ? rating.comment : '无评价内容';
                    ElMessage.info(`${rating.employeeName} 对 ${rating.name} 的评价：${rating.rating}分 - ${comment}`);
                },
                
                exportRatingData() {
                    try {
                        const csvContent = [
                            ['评价日期', '时间', '评价者', '菜品名称', '餐次', '评分', '评价内容'].join(','),
                            ...this.ratingsData.map(rating => [
                                rating.dateFormatted,
                                rating.timeFormatted,
                                rating.employeeName,
                                rating.name,
                                rating.mealTypeText,
                                rating.rating,
                                (rating.comment || '').replace(/,/g, '，') // 替换逗号避免CSV格式问题
                            ].join(','))
                        ].join('\n');
                        
                        const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                        const link = document.createElement('a');
                        const url = URL.createObjectURL(blob);
                        link.setAttribute('href', url);
                        link.setAttribute('download', `菜品评价记录_${new Date().toISOString().split('T')[0]}.csv`);
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        ElMessage.success('评价数据导出成功');
                    } catch (error) {
                        console.error('导出失败:', error);
                        ElMessage.error('导出失败');
                    }
                },
                
                // 用户管理相关方法
                async loadUsersData() {
                    try {
                        const response = await fetch('/api/admin/users');
                        const result = await response.json();
                        if (result.success) {
                            this.usersData = result.data;
                            this.calculateUserStats();
                        }
                    } catch (error) {
                        console.error('加载用户数据失败:', error);
                        ElMessage.error('加载用户数据失败');
                    }
                },
                
                calculateUserStats() {
                    this.totalUsers = this.usersData.length;
                    this.totalEmployees = this.usersData.filter(user => user.isEmployee).length;
                    
                    // 计算今日活跃用户数（今日登录的用户）
                    const today = new Date().toISOString().split('T')[0];
                    this.activeUsersToday = this.usersData.filter(user => {
                        if (!user.lastLogin) return false;
                        return new Date(user.lastLogin).toISOString().split('T')[0] === today;
                    }).length;
                },
                
                viewUserDetail(user) {
                    const status = user.isEmployee ? '员工' : '访客';
                    const loginInfo = user.lastLoginFormatted !== '从未登录' ? 
                        `，最后登录：${user.lastLoginFormatted}` : '，从未登录';
                    ElMessage.info(`用户详情：${user.name}（${status}），评价次数：${user.ratingCount}次${loginInfo}`);
                },
                
                editUser(user) {
                    ElMessage.info('编辑用户功能开发中');
                    // TODO: 实现编辑用户弹窗
                },
                
                showAddEmployeeDialog() {
                    ElMessage.info('添加员工功能开发中');
                    // TODO: 实现添加员工弹窗
                },
                
                exportUserData() {
                    try {
                        const csvContent = [
                            ['姓名', '用户ID', '部门', '员工状态', '评价次数', '注册时间', '最后登录'].join(','),
                            ...this.usersData.map(user => [
                                user.name,
                                user.open_id ? user.open_id.substring(0, 12) + '...' : 'N/A',
                                user.department,
                                user.isEmployee ? '员工' : '访客',
                                user.ratingCount,
                                user.registerTimeFormatted,
                                user.lastLoginFormatted
                            ].join(','))
                        ].join('\n');
                        
                        const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                        const link = document.createElement('a');
                        const url = URL.createObjectURL(blob);
                        link.setAttribute('href', url);
                        link.setAttribute('download', `用户数据_${new Date().toISOString().split('T')[0]}.csv`);
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        ElMessage.success('用户数据导出成功');
                    } catch (error) {
                        console.error('导出失败:', error);
                        ElMessage.error('导出失败');
                    }
                },
                
                // 用户角色管理相关方法
                showSetRoleDialog(user) {
                    this.selectedUser = user;
                    this.newUserRole = user.role || 'user';
                    this.showRoleDialog = true;
                },
                
                async confirmSetUserRole() {
                    if (!this.selectedUser) return;
                    
                    try {
                        this.settingRole = true;
                        
                        const response = await fetch(`/api/admin/users/${this.selectedUser.id}/role`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.token}`
                            },
                            body: JSON.stringify({
                                role: this.newUserRole
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            ElMessage.success('用户角色设置成功');
                            this.showRoleDialog = false;
                            this.selectedUser = null;
                            await this.loadUsersData(); // 重新加载用户数据
                        } else {
                            ElMessage.error(result.message || '设置失败');
                        }
                    } catch (error) {
                        console.error('设置用户角色失败:', error);
                        ElMessage.error('设置失败');
                    } finally {
                        this.settingRole = false;
                    }
                },
                
                goToUserCenter() {
                    window.location.href = '/user-dashboard.html';
                },
                
                
                formatTodayDate() {
                    const today = new Date();
                    return today.toLocaleDateString('zh-CN');
                },
                
                getDayName() {
                    const days = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
                    return days[new Date().getDay()];
                },
                
                // 清零不吃人数
                async clearNoEatCount(order) {
                    try {
                        console.log('清零不吃人数 - 开始:', order);
                        order.clearLoading = true;
                        
                        const requestData = {
                            date: order.date,
                            mealType: order.mealType
                        };
                        console.log('发送请求数据:', requestData);
                        
                        const response = await fetch('/api/admin/orders/clear-no-eat', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.token}`
                            },
                            body: JSON.stringify(requestData)
                        });

                        console.log('响应状态:', response.status);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        const result = await response.json();
                        console.log('响应结果:', result);
                        
                        if (result.success) {
                            ElMessage.success(result.message);
                            // 更新本地数据
                            order.noEatCount = 0;
                        } else {
                            ElMessage.error(result.message || '操作失败');
                        }
                    } catch (error) {
                        console.error('清零不吃人数失败:', error);
                        ElMessage.error(`操作失败: ${error.message}`);
                    } finally {
                        order.clearLoading = false;
                    }
                },
                

                async loadSettings() {
                    try {
                        const response = await fetch('/api/admin/settings', {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${this.token}`
                            }
                        });

                        const result = await response.json();
                        
                        if (result.success) {
                            if (result.data && typeof result.data.totalEmployees !== 'undefined') {
                                this.systemConfig.totalEmployees = result.data.totalEmployees;
                            }
                        }
                    } catch (error) {
                        console.error('加载设置失败:', error);
                    }
                },

                // 筛选评价
                filterRatings() {
                    let filtered = [...this.ratingsData];

                    // 关键词搜索
                    if (this.ratingSearchKeyword.trim()) {
                        const keyword = this.ratingSearchKeyword.trim().toLowerCase();
                        filtered = filtered.filter(rating => 
                            rating.dishName.toLowerCase().includes(keyword) ||
                            rating.restaurantName.toLowerCase().includes(keyword) ||
                            rating.userName.toLowerCase().includes(keyword)
                        );
                    }

                    // 时间筛选
                    if (this.ratingTimeFilter !== 'all') {
                        const now = new Date();
                        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        
                        filtered = filtered.filter(rating => {
                            const ratingDate = new Date(rating.timestamp);
                            
                            switch (this.ratingTimeFilter) {
                                case 'today':
                                    return ratingDate >= today;
                                case 'week':
                                    const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                                    return ratingDate >= weekAgo;
                                case 'month':
                                    const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                                    return ratingDate >= monthAgo;
                                case 'custom':
                                    if (this.ratingDateRange && this.ratingDateRange.length === 2) {
                                        return ratingDate >= this.ratingDateRange[0] && ratingDate <= this.ratingDateRange[1];
                                    }
                                    return true;
                                default:
                                    return true;
                            }
                        });
                    }

                    // 评分筛选
                    if (this.ratingScoreFilter !== 'all') {
                        filtered = filtered.filter(rating => {
                            switch (this.ratingScoreFilter) {
                                case 'low':
                                    return rating.score >= 1 && rating.score <= 2;
                                case 'medium':
                                    return rating.score === 3;
                                case 'high':
                                    return rating.score >= 4 && rating.score <= 5;
                                default:
                                    return true;
                            }
                        });
                    }

                    // 点赞数筛选
                    if (this.ratingLikesFilter !== 'all') {
                        filtered = filtered.filter(rating => {
                            const likes = rating.likeCount || 0;
                            switch (this.ratingLikesFilter) {
                                case 'none':
                                    return likes === 0;
                                case 'few':
                                    return likes >= 1 && likes <= 5;
                                case 'many':
                                    return likes > 5;
                                default:
                                    return true;
                            }
                        });
                    }

                    // 排序
                    this.sortRatings(filtered);

                    // 更新分页信息
                    this.totalFilteredRatings = filtered.length;
                    
                    // 应用分页
                    const start = (this.ratingCurrentPage - 1) * this.ratingPageSize;
                    const end = start + this.ratingPageSize;
                    this.filteredRatings = filtered.slice(start, end);
                },

                // 关键词搜索
                searchRatings() {
                    this.ratingCurrentPage = 1; // 重置到第一页
                    this.filterRatings();
                },

                // 排序
                sortRatings(ratings) {
                    ratings.sort((a, b) => {
                        switch (this.ratingSortBy) {
                            case 'time_desc':
                                return new Date(b.timestamp) - new Date(a.timestamp);
                            case 'time_asc':
                                return new Date(a.timestamp) - new Date(b.timestamp);
                            case 'likes_desc':
                                return (b.likeCount || 0) - (a.likeCount || 0);
                            case 'likes_asc':
                                return (a.likeCount || 0) - (b.likeCount || 0);
                            case 'score_desc':
                                return b.score - a.score;
                            case 'score_asc':
                                return a.score - b.score;
                            default:
                                return new Date(b.timestamp) - new Date(a.timestamp);
                        }
                    });
                },

                // 删除评价确认
                confirmDeleteRating(rating) {
                    ElMessageBox.confirm(
                        `确定要删除用户「${rating.userName}」对「${rating.restaurantName} - ${rating.dishName}」的评价吗？`,
                        '删除确认',
                        {
                            confirmButtonText: '确定删除',
                            cancelButtonText: '取消',
                            type: 'warning',
                            confirmButtonClass: 'el-button--danger'
                        }
                    ).then(() => {
                        this.deleteRating(rating.id);
                    }).catch(() => {
                        // 用户取消删除
                    });
                },

                // 删除评价
                async deleteRating(ratingId) {
                    try {
                        const response = await fetch(`/api/admin/ratings/${ratingId}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${this.token}`
                            }
                        });

                        const result = await response.json();
                        
                        if (result.success) {
                            ElMessage.success('评价删除成功');
                            await this.loadRatingsData(); // 重新加载数据
                            this.filterRatings(); // 重新筛选
                        } else {
                            ElMessage.error(result.message || '删除失败');
                        }
                    } catch (error) {
                        console.error('删除评价失败:', error);
                        ElMessage.error('删除失败');
                    }
                },

                // 重置筛选
                resetFilters() {
                    this.ratingSearchKeyword = '';
                    this.ratingTimeFilter = 'all';
                    this.ratingDateRange = null;
                    this.ratingScoreFilter = 'all';
                    this.ratingLikesFilter = 'all';
                    this.ratingSortBy = 'time_desc';
                    this.ratingCurrentPage = 1;
                    this.filterRatings();
                },

                // 处理分页变化
                handleRatingPageChange(page) {
                    this.ratingCurrentPage = page;
                    this.filterRatings();
                },

                // 处理分页大小变化
                handleRatingPageSizeChange(size) {
                    this.ratingPageSize = size;
                    this.ratingCurrentPage = 1;
                    this.filterRatings();
                },

                // 生成星级显示
                generateStars(score) {
                    const stars = [];
                    for (let i = 1; i <= 5; i++) {
                        stars.push(i <= score ? '★' : '☆');
                    }
                    return stars.join('');
                },

                async updateTotalEmployees(value) {
                    try {
                        const response = await fetch('/api/admin/settings', {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.token}`
                            },
                            body: JSON.stringify({
                                totalEmployees: value
                            })
                        });

                        const result = await response.json();
                        
                        if (result.success) {
                            ElMessage.success('总人数更新成功');
                        } else {
                            ElMessage.error(result.message || '更新失败');
                        }
                    } catch (error) {
                        console.error('更新总人数失败:', error);
                        ElMessage.error('更新失败');
                    }
                },
                
                // 格式化日期时间
                formatDate(dateStr) {
                    if (!dateStr) return '未知';
                    return new Date(dateStr).toLocaleString('zh-CN');
                }
            },
            watch: {
                orderDateQuickSelect(newValue, oldValue) {
                    if (newValue !== oldValue) {
                        this.onDateQuickSelectChange(newValue);
                    }
                }
            }
        }).use(ElementPlus).component('Plus', Plus).mount('#app');
    </script>
</body>
</html>