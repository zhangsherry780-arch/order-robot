<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å‘˜ä¸­å¿ƒ - å…¬å¸è®¢é¤ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/element-plus@2.4.4/dist/index.css" rel="stylesheet">
    <style>
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
        }
        .dashboard-container {
            display: flex !important;
            height: 100vh;
            min-height: 100vh;
        }
        .sidebar {
            width: 250px;
            background: white;
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
            display: flex !important;
            flex-direction: column;
            flex-shrink: 0;
        }
        .sidebar-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #ebeef5;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .sidebar-header h2 {
            margin: 0;
            font-size: 18px;
        }
        .sidebar-header p {
            margin: 5px 0 0 0;
            font-size: 12px;
            opacity: 0.8;
        }
        .nav-menu {
            flex: 1;
            padding: 20px 0;
        }
        .nav-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }
        .nav-item:hover {
            background: #f5f7fa;
        }
        .nav-item.active {
            background: #fff2e6;
            border-left-color: #f56c6c;
            color: #f56c6c;
        }
        .nav-item .icon {
            margin-right: 12px;
            font-size: 18px;
            width: 20px;
            text-align: center;
        }
        .nav-item .text {
            font-weight: 500;
        }
        .admin-info {
            padding: 20px;
            border-top: 1px solid #ebeef5;
            background: #fafafa;
        }
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .content-header {
            background: white;
            padding: 20px 30px;
            border-bottom: 1px solid #ebeef5;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .content-body {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }
        .page-title {
            font-size: 24px;
            font-weight: bold;
            margin: 0;
            color: #303133;
        }
        .page-subtitle {
            margin: 5px 0 0 0;
            color: #909399;
            font-size: 14px;
        }
        .page-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* è¡¨æ ¼æ ·å¼ */
        .table-container {
            margin-top: 20px;
        }
        
        /* èœå•ç®¡ç†ç›¸å…³æ ·å¼ */
        .menu-card {
            margin-bottom: 20px;
        }
        
        .menu-card .el-card__header {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #ebeef5;
        }
        
        .dish-list {
            min-height: 200px;
            padding: 10px;
        }
        
        .dish-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #ebeef5;
        }
        
        .dish-item:hover {
            background: #ecf5ff;
            border-color: #409eff;
        }
        
        .dish-operations {
            display: flex;
            gap: 8px;
        }
        
        .empty-menu {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 150px;
            color: #909399;
            font-style: italic;
        }
        
        .weekly-menu {
            display: grid;
            gap: 20px;
        }
        
        .week-day-menu {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #ebeef5;
        }
        
        .week-day-menu h4 {
            margin: 0 0 15px 0;
            color: #303133;
            font-size: 16px;
        }
        
        .meal-card .el-card__header {
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .mini-dish-list {
            min-height: 80px;
            padding: 5px;
        }
        
        .mini-dish-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            background: white;
            border-radius: 4px;
            margin-bottom: 5px;
            font-size: 12px;
            border: 1px solid #ebeef5;
        }
        
        .mini-dish-item:hover {
            background: #f0f9ff;
        }
        
        /* æ·»åŠ èœå“å¼¹çª—æ ·å¼ */
        .dish-image-uploader {
            border: 1px dashed #d9d9d9;
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: border-color 0.3s;
            width: 148px;
            height: 148px;
            display: block;
        }
        
        .dish-image-uploader:hover {
            border-color: #409eff;
        }
        
        .dish-image-uploader-icon {
            font-size: 28px;
            color: #8c939d;
            width: 148px;
            height: 148px;
            line-height: 148px;
            text-align: center;
        }
        
        .dish-image {
            width: 148px;
            height: 148px;
            display: block;
            object-fit: cover;
        }
        
        /* èœå“åº“ç®¡ç†æ ·å¼ */
        .pagination-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        
        /* é¤å…å¼èœå•æ˜¾ç¤ºæ ·å¼ */
        .restaurant-menu-item {
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #ebeef5;
        }
        
        .restaurant-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #ddd;
        }
        
        .restaurant-name {
            margin: 0;
            font-size: 16px;
            font-weight: bold;
            color: #303133;
        }
        
        .restaurant-operations {
            display: flex;
            gap: 8px;
        }
        
        .restaurant-dishes {
            margin-top: 8px;
        }
        
        .restaurant-dish-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 4px 0;
            background: white;
            border-radius: 4px;
            border: 1px solid #e4e7ed;
        }
        
        .dish-name {
            font-weight: 500;
            color: #606266;
        }
        
        .dish-tags {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        
        .dish-tag {
            margin-right: 0 !important;
        }
        
        .menu-note {
            text-align: center;
            font-size: 12px;
            color: #909399;
            font-style: italic;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #f0f0f0;
        }
        
        /* å‘¨èœå•çš„è¿·ä½ é¤å…æ˜¾ç¤º */
        .mini-restaurant-menu {
            margin-bottom: 8px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            border: 1px solid #ebeef5;
        }
        
        .mini-restaurant-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .mini-restaurant-name {
            font-weight: bold;
            font-size: 14px;
            color: #303133;
        }
        
        .mini-restaurant-dishes {
            font-size: 12px;
            color: #606266;
            line-height: 1.4;
        }
        
        .mini-dish-name {
            margin-right: 2px;
        }
        
        .more-dishes {
            color: #909399;
        }
        
        .mini-menu-note {
            font-size: 10px;
            color: #c0c4cc;
            font-style: italic;
            margin-top: 4px;
            text-align: center;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }
            .content-header > div {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 15px;
            }
            
            .daily-menu-cards .el-col {
                margin-bottom: 20px;
            }
            
            .weekly-menu {
                grid-template-columns: 1fr;
            }
            
            .dish-operations {
                flex-direction: column;
                gap: 5px;
            }
        }
        
        @media (max-width: 480px) {
            .dish-item {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .dish-operations {
                flex-direction: row;
                justify-content: center;
            }
        }
        
        /* èœå•ç¼–è¾‘å¯¹è¯æ¡†æ ·å¼ */
        .edit-meal-content {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .meal-dishes-list .dish-card {
            margin-bottom: 12px;
        }
        
        .meal-dishes-list .dish-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .meal-dishes-list .dish-info {
            flex: 1;
        }
        
        .meal-dishes-list .dish-name {
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .meal-dishes-list .restaurant-name {
            font-size: 12px;
            color: #999;
        }
        
        .empty-meal {
            text-align: center;
            padding: 40px 0;
        }
        
        /* é…ç½®é¡µé¢æ ·å¼ */
        .config-form {
            margin-bottom: 20px;
        }
        
        .config-card {
            background: white;
            border: 1px solid #e6e6e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        
        .config-card h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }
        
        .config-info {
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="dashboard-container" style="display: flex; height: 100vh;">
            <!-- å·¦ä¾§å¯¼èˆªæ  -->
            <div class="sidebar" style="width: 250px; background: white; display: block;">
                <!-- å¤´éƒ¨ä¿¡æ¯ -->
                <div class="sidebar-header">
                    <h2>ğŸ› ï¸ ç®¡ç†å‘˜ä¸­å¿ƒ</h2>
                    <p>{{ formatTodayDate() }} {{ getDayName() }}</p>
                </div>
                
                <!-- å¯¼èˆªèœå• -->
                <div class="nav-menu">
                    <div class="nav-item" 
                         :class="{ active: currentPage === 'dishes' }"
                         @click="switchPage('dishes')">
                        <span class="icon">ğŸ½ï¸</span>
                        <span class="text">èœå“ç®¡ç†</span>
                    </div>
                    
                    <div class="nav-item" 
                         :class="{ active: currentPage === 'orders' }"
                         @click="switchPage('orders')">
                        <span class="icon">ğŸ“Š</span>
                        <span class="text">ç‚¹é¤è®°å½•</span>
                    </div>
                    
                    <div class="nav-item" 
                         :class="{ active: currentPage === 'ratings' }"
                         @click="switchPage('ratings')">
                        <span class="icon">â­</span>
                        <span class="text">èœå“è¯„ä»·è®°å½•</span>
                    </div>
                    
                    <div class="nav-item" 
                         :class="{ active: currentPage === 'users' }"
                         @click="switchPage('users')">
                        <span class="icon">ğŸ‘¥</span>
                        <span class="text">ç”¨æˆ·ç®¡ç†</span>
                    </div>
                    
                </div>
                
                <!-- ç®¡ç†å‘˜ä¿¡æ¯ -->
                <div class="admin-info">
                    <div style="margin-bottom: 15px;">
                        <div style="font-weight: bold; font-size: 14px;">ç®¡ç†å‘˜</div>
                        <div style="font-size: 12px; color: #666;">ç³»ç»Ÿç®¡ç†æƒé™</div>
                    </div>
                </div>
            </div>
            
            <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
            <div class="main-content">
                <!-- å†…å®¹å¤´éƒ¨ -->
                <div class="content-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h1 class="page-title">{{ getPageTitle() }}</h1>
                            <p class="page-subtitle">{{ getPageSubtitle() }}</p>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <el-button type="primary" @click="goToUserCenter" size="small">
                                ğŸ‘¤ ç”¨æˆ·ä¸­å¿ƒ
                            </el-button>
                            <el-button type="success" @click="refreshData" size="small">
                                ğŸ”„ åˆ·æ–°æ•°æ®
                            </el-button>
                        </div>
                    </div>
                </div>
                
                <!-- å†…å®¹ä¸»ä½“ -->
                <div class="content-body">
                    <!-- èœå“ç®¡ç†é¡µé¢ -->
                    <div v-if="currentPage === 'dishes'">
                        <!-- ç»Ÿè®¡å¡ç‰‡ -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number">{{ totalDishes }}</div>
                                <div class="stat-label">æ€»èœå“æ•°</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #36d1dc 0%, #5b86e5 100%);">
                                <div class="stat-number">{{ totalRestaurants }}</div>
                                <div class="stat-label">åˆä½œé¤å…</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                <div class="stat-number">{{ avgRating }}</div>
                                <div class="stat-label">å¹³å‡è¯„åˆ†</div>
                            </div>
                        </div>
                        
                        <!-- Current Menu Display -->
                        <div class="page-content" style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3>ğŸ½ï¸ å½“å‰èœå• ({{ formatTodayDate() }})</h3>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <el-button type="primary" @click="loadCurrentMenu" :loading="loadingCurrentMenu" size="small">
                                        ğŸ”„ åˆ·æ–°èœå•
                                    </el-button>
                                    <el-button type="warning" @click="editCurrentMenu" size="small" v-if="currentMenuData.hasMenu">
                                        âœï¸ ç¼–è¾‘èœå•
                                    </el-button>
                                </div>
                            </div>
                            
                            <!-- Current Menu Content -->
                            <div v-if="currentMenuData.hasMenu">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                    <!-- Lunch Menu -->
                                    <div class="menu-section">
                                        <h4 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                            <span>ğŸŒ… åˆé¤</span>
                                            <el-button type="primary" size="small" @click="editMeal('lunch')" text>ç¼–è¾‘</el-button>
                                        </h4>
                                        <div v-if="currentMenuData.lunch && currentMenuData.lunch.length > 0">
                                            <div class="dish-item" v-for="dish in currentMenuData.lunch" :key="dish.dishId" 
                                                 style="padding: 10px; border: 1px solid #e6e6e6; border-radius: 6px; margin-bottom: 8px;">
                                                <div style="font-weight: 500;">{{ dish.dishName }}</div>
                                                <div style="font-size: 12px; color: #666;">{{ dish.restaurantName }}</div>
                                            </div>
                                        </div>
                                        <div v-else style="text-align: center; color: #999; padding: 20px;">
                                            æš‚æ— åˆé¤èœå•
                                        </div>
                                    </div>
                                    
                                    <!-- Dinner Menu -->
                                    <div class="menu-section">
                                        <h4 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                            <span>ğŸŒ™ æ™šé¤</span>
                                            <el-button type="primary" size="small" @click="editMeal('dinner')" text>ç¼–è¾‘</el-button>
                                        </h4>
                                        <div v-if="currentMenuData.dinner && currentMenuData.dinner.length > 0">
                                            <div class="dish-item" v-for="dish in currentMenuData.dinner" :key="dish.dishId" 
                                                 style="padding: 10px; border: 1px solid #e6e6e6; border-radius: 6px; margin-bottom: 8px;">
                                                <div style="font-weight: 500;">{{ dish.dishName }}</div>
                                                <div style="font-size: 12px; color: #666;">{{ dish.restaurantName }}</div>
                                            </div>
                                        </div>
                                        <div v-else style="text-align: center; color: #999; padding: 20px;">
                                            æš‚æ— æ™šé¤èœå•
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- No Menu State -->
                            <div v-else style="text-align: center; padding: 40px; color: #999;">
                                <p>ğŸ“­ ä»Šæ—¥æš‚æ— èœå•</p>
                                <p style="font-size: 12px;">è¯·ä½¿ç”¨ä¸‹æ–¹çš„èœå•é…ç½®åŠŸèƒ½ç”Ÿæˆèœå•</p>
                            </div>
                        </div>

                        <!-- Module 1: Daily Menu Configuration -->
                        <div class="page-content" style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3>ğŸ“… æ¯æ—¥èœå•é…ç½®</h3>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <el-radio-group v-model="selectedPeriod" @change="loadMenuForPeriod">
                                        <el-radio-button label="today">ä»Šå¤©</el-radio-button>
                                        <el-radio-button label="thisWeek">æœ¬å‘¨</el-radio-button>
                                        <el-radio-button label="nextWeek">ä¸‹å‘¨</el-radio-button>
                                    </el-radio-group>
                                    <el-button type="success" @click="generateRandomMenu" :loading="generatingMenu">
                                        ğŸ² éšæœºç”Ÿæˆèœå•
                                    </el-button>
                                </div>
                            </div>
                            
                            <!-- Date Selector and Menu Display -->
                            <div v-if="selectedPeriod === 'today'">
                                <el-date-picker
                                    v-model="selectedDate"
                                    type="date"
                                    placeholder="é€‰æ‹©æ—¥æœŸ"
                                    @change="loadMenuForDate"
                                    style="margin-bottom: 20px;"
                                    :disabled-date="(date) => date < new Date(Date.now() - 24*60*60*1000)"
                                >
                                </el-date-picker>
                                
                                <div class="daily-menu-cards">
                                    <el-row :gutter="20">
                                        <el-col :span="12">
                                            <el-card class="menu-card">
                                                <template #header>
                                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                                        <span>{{ formatDateDisplay(selectedDate) }} åˆé¤</span>
                                                        <div>
                                                            <el-button size="small" @click="addDishToMenu('lunch')" type="primary" plain>
                                                                â• æ·»åŠ 
                                                            </el-button>
                                                        </div>
                                                    </div>
                                                </template>
                                                <div class="dish-list">
                                                    <!-- é¤å…å¼èœå•æ˜¾ç¤º -->
                                                    <div v-for="(restaurantMenu, index) in dailyMenu.lunch" :key="`lunch-${index}`" class="restaurant-menu-item">
                                                        <div v-if="restaurantMenu.isRestaurantMenu" class="restaurant-header">
                                                            <h4 class="restaurant-name">{{ restaurantMenu.restaurantName }}</h4>
                                                            <div class="restaurant-operations">
                                                                <el-button size="small" @click="replaceDish('lunch', index)" type="warning" plain>æ›¿æ¢é¤å…</el-button>
                                                                <el-button size="small" @click="removeDish('lunch', index)" type="danger" plain>åˆ é™¤</el-button>
                                                            </div>
                                                        </div>
                                                        <div v-if="restaurantMenu.isRestaurantMenu" class="restaurant-dishes">
                                                            <div v-for="dish in restaurantMenu.dishes" :key="dish.id" class="restaurant-dish-item">
                                                                <span class="dish-name">{{ dish.name }}</span>
                                                                <div v-if="dish.tags && dish.tags.length > 0" class="dish-tags">
                                                                    <el-tag v-for="tag in dish.tags" :key="tag" size="small" :type="getTagType(tag)" class="dish-tag">
                                                                        {{ getTagLabel(tag) }}
                                                                    </el-tag>
                                                                </div>
                                                            </div>
                                                            <div class="menu-note">èœå“ä¾›å‚è€ƒ</div>
                                                        </div>
                                                        <!-- å…¼å®¹åŸæœ‰èœå“æ˜¾ç¤ºæ–¹å¼ -->
                                                        <div v-else class="dish-item">
                                                            <span>{{ restaurantMenu.restaurantName }} - {{ restaurantMenu.name }}</span>
                                                            <div class="dish-operations">
                                                                <el-button size="small" @click="replaceDish('lunch', index)" type="warning" plain>æ›¿æ¢</el-button>
                                                                <el-button size="small" @click="removeDish('lunch', index)" type="danger" plain>åˆ é™¤</el-button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div v-if="dailyMenu.lunch.length === 0" class="empty-menu">
                                                        <span>æš‚æ— èœå“</span>
                                                    </div>
                                                </div>
                                            </el-card>
                                        </el-col>
                                        <el-col :span="12">
                                            <el-card class="menu-card">
                                                <template #header>
                                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                                        <span>{{ formatDateDisplay(selectedDate) }} æ™šé¤</span>
                                                        <div>
                                                            <el-button size="small" @click="addDishToMenu('dinner')" type="primary" plain>
                                                                â• æ·»åŠ 
                                                            </el-button>
                                                        </div>
                                                    </div>
                                                </template>
                                                <div class="dish-list">
                                                    <!-- é¤å…å¼èœå•æ˜¾ç¤º -->
                                                    <div v-for="(restaurantMenu, index) in dailyMenu.dinner" :key="`dinner-${index}`" class="restaurant-menu-item">
                                                        <div v-if="restaurantMenu.isRestaurantMenu" class="restaurant-header">
                                                            <h4 class="restaurant-name">{{ restaurantMenu.restaurantName }}</h4>
                                                            <div class="restaurant-operations">
                                                                <el-button size="small" @click="replaceDish('dinner', index)" type="warning" plain>æ›¿æ¢é¤å…</el-button>
                                                                <el-button size="small" @click="removeDish('dinner', index)" type="danger" plain>åˆ é™¤</el-button>
                                                            </div>
                                                        </div>
                                                        <div v-if="restaurantMenu.isRestaurantMenu" class="restaurant-dishes">
                                                            <div v-for="dish in restaurantMenu.dishes" :key="dish.id" class="restaurant-dish-item">
                                                                <span class="dish-name">{{ dish.name }}</span>
                                                                <div v-if="dish.tags && dish.tags.length > 0" class="dish-tags">
                                                                    <el-tag v-for="tag in dish.tags" :key="tag" size="small" :type="getTagType(tag)" class="dish-tag">
                                                                        {{ getTagLabel(tag) }}
                                                                    </el-tag>
                                                                </div>
                                                            </div>
                                                            <div class="menu-note">èœå“ä¾›å‚è€ƒ</div>
                                                        </div>
                                                        <!-- å…¼å®¹åŸæœ‰èœå“æ˜¾ç¤ºæ–¹å¼ -->
                                                        <div v-else class="dish-item">
                                                            <span>{{ restaurantMenu.restaurantName }} - {{ restaurantMenu.name }}</span>
                                                            <div class="dish-operations">
                                                                <el-button size="small" @click="replaceDish('dinner', index)" type="warning" plain>æ›¿æ¢</el-button>
                                                                <el-button size="small" @click="removeDish('dinner', index)" type="danger" plain>åˆ é™¤</el-button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div v-if="dailyMenu.dinner.length === 0" class="empty-menu">
                                                        <span>æš‚æ— èœå“</span>
                                                    </div>
                                                </div>
                                            </el-card>
                                        </el-col>
                                    </el-row>
                                </div>
                            </div>
                            
                            <!-- Weekly Menu Display -->
                            <div v-else>
                                <div class="weekly-menu">
                                    <div v-for="day in weekDays" :key="day.key" class="week-day-menu">
                                        <h4>{{ day.label }}</h4>
                                        <el-row :gutter="10">
                                            <el-col :span="12">
                                                <el-card size="small" class="meal-card">
                                                    <template #header>
                                                        <span>åˆé¤</span>
                                                        <el-button size="small" @click="addDishToWeeklyMenu(day.key, 'lunch')" type="primary" plain>â•</el-button>
                                                    </template>
                                                    <div class="mini-dish-list">
                                                        <div v-for="(restaurantMenu, index) in weeklyMenu[day.key]?.lunch || []" :key="`${day.key}-lunch-${index}`" class="mini-restaurant-menu">
                                                            <div v-if="restaurantMenu.isRestaurantMenu" class="mini-restaurant-header">
                                                                <span class="mini-restaurant-name">{{ restaurantMenu.restaurantName }}</span>
                                                                <el-button size="small" @click="removeWeeklyDish(day.key, 'lunch', index)" type="danger" plain circle>âœ•</el-button>
                                                            </div>
                                                            <div v-if="restaurantMenu.isRestaurantMenu" class="mini-restaurant-dishes">
                                                                <span v-for="(dish, dishIndex) in restaurantMenu.dishes.slice(0, 3)" :key="dish.id" class="mini-dish-name">
                                                                    {{ dish.name }}<span v-if="dishIndex < Math.min(2, restaurantMenu.dishes.length - 1)">ã€</span>
                                                                </span>
                                                                <span v-if="restaurantMenu.dishes.length > 3" class="more-dishes">ç­‰{{ restaurantMenu.dishes.length }}é“èœ</span>
                                                                <div class="mini-menu-note">èœå“ä¾›å‚è€ƒ</div>
                                                            </div>
                                                            <!-- å…¼å®¹åŸæœ‰æ ¼å¼ -->
                                                            <div v-else class="mini-dish-item">
                                                                <span>{{ restaurantMenu.restaurantName }} - {{ restaurantMenu.name }}</span>
                                                                <el-button size="small" @click="removeWeeklyDish(day.key, 'lunch', index)" type="danger" plain circle>âœ•</el-button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </el-card>
                                            </el-col>
                                            <el-col :span="12">
                                                <el-card size="small" class="meal-card">
                                                    <template #header>
                                                        <span>æ™šé¤</span>
                                                        <el-button size="small" @click="addDishToWeeklyMenu(day.key, 'dinner')" type="primary" plain>â•</el-button>
                                                    </template>
                                                    <div class="mini-dish-list">
                                                        <div v-for="(restaurantMenu, index) in weeklyMenu[day.key]?.dinner || []" :key="`${day.key}-dinner-${index}`" class="mini-restaurant-menu">
                                                            <div v-if="restaurantMenu.isRestaurantMenu" class="mini-restaurant-header">
                                                                <span class="mini-restaurant-name">{{ restaurantMenu.restaurantName }}</span>
                                                                <el-button size="small" @click="removeWeeklyDish(day.key, 'dinner', index)" type="danger" plain circle>âœ•</el-button>
                                                            </div>
                                                            <div v-if="restaurantMenu.isRestaurantMenu" class="mini-restaurant-dishes">
                                                                <span v-for="(dish, dishIndex) in restaurantMenu.dishes.slice(0, 3)" :key="dish.id" class="mini-dish-name">
                                                                    {{ dish.name }}<span v-if="dishIndex < Math.min(2, restaurantMenu.dishes.length - 1)">ã€</span>
                                                                </span>
                                                                <span v-if="restaurantMenu.dishes.length > 3" class="more-dishes">ç­‰{{ restaurantMenu.dishes.length }}é“èœ</span>
                                                                <div class="mini-menu-note">èœå“ä¾›å‚è€ƒ</div>
                                                            </div>
                                                            <!-- å…¼å®¹åŸæœ‰æ ¼å¼ -->
                                                            <div v-else class="mini-dish-item">
                                                                <span>{{ restaurantMenu.restaurantName }} - {{ restaurantMenu.name }}</span>
                                                                <el-button size="small" @click="removeWeeklyDish(day.key, 'dinner', index)" type="danger" plain circle>âœ•</el-button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </el-card>
                                            </el-col>
                                        </el-row>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Menu Action Buttons -->
                            <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                                <el-button @click="saveMenu" :loading="savingMenu" size="large">
                                    ğŸ’¾ ä¿å­˜è‰ç¨¿
                                </el-button>
                                <el-button type="primary" @click="publishMenu" :loading="publishingMenu" size="large">
                                    ğŸš€ å‘å¸ƒèœå•
                                </el-button>
                            </div>
                        </div>
                        
                        <!-- Module 3: Dish Library Management -->
                        <div class="page-content">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3>ğŸ“š èœå“åº“ç®¡ç†</h3>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <el-button type="primary" @click="showAddDishDialog">
                                        â• æ·»åŠ æ–°èœå“
                                    </el-button>
                                    <el-button 
                                        v-if="selectedDishes.length > 0" 
                                        @click="batchDisableDishes" 
                                        type="warning"
                                    >
                                        æ‰¹é‡ç¦ç”¨ ({{ selectedDishes.length }})
                                    </el-button>
                                    <el-button 
                                        v-if="selectedDishes.length > 0" 
                                        @click="batchDeleteDishes" 
                                        type="danger"
                                    >
                                        æ‰¹é‡åˆ é™¤ ({{ selectedDishes.length }})
                                    </el-button>
                                </div>
                            </div>
                            
                            <!-- Search and Filter -->
                            <div style="margin-bottom: 20px; padding: 20px; background: #fafafa; border-radius: 8px;">
                                <el-row :gutter="20">
                                    <el-col :span="8">
                                        <el-input
                                            v-model="dishSearch"
                                            placeholder="æœç´¢èœå“åç§°"
                                            clearable
                                            @input="filterDishes"
                                        >
                                            <template #prefix>
                                                ğŸ”
                                            </template>
                                        </el-input>
                                    </el-col>
                                    <el-col :span="6">
                                        <el-select v-model="restaurantFilter" placeholder="ç­›é€‰é¤å…" clearable @change="filterDishes">
                                            <el-option
                                                v-for="restaurant in uniqueRestaurants"
                                                :key="restaurant"
                                                :label="restaurant"
                                                :value="restaurant">
                                            </el-option>
                                        </el-select>
                                    </el-col>
                                    <el-col :span="6">
                                        <el-select v-model="tagFilter" placeholder="ç­›é€‰æ ‡ç­¾" clearable @change="filterDishes">
                                            <el-option label="è¤èœ" value="meat"></el-option>
                                            <el-option label="ç´ é£Ÿ" value="vegetarian"></el-option>
                                            <el-option label="è¾›è¾£" value="spicy"></el-option>
                                            <el-option label="æ¸…æ·¡" value="mild"></el-option>
                                            <el-option label="æ‹›ç‰Œ" value="specialty"></el-option>
                                        </el-select>
                                    </el-col>
                                    <el-col :span="4">
                                        <el-select v-model="statusFilter" placeholder="çŠ¶æ€" clearable @change="filterDishes">
                                            <el-option label="å¯ç”¨" value="active"></el-option>
                                            <el-option label="ç¦ç”¨" value="inactive"></el-option>
                                        </el-select>
                                    </el-col>
                                </el-row>
                            </div>
                            
                            <!-- Dish Library Table -->
                            <div class="table-container">
                                <el-table 
                                    :data="paginatedDishes" 
                                    style="width: 100%" 
                                    stripe
                                    @selection-change="handleSelectionChange"
                                    v-loading="loadingDishes"
                                >
                                    <el-table-column type="selection" width="55"></el-table-column>
                                    <el-table-column prop="restaurantName" label="é¤å…" width="150"></el-table-column>
                                    <el-table-column prop="name" label="èœå“åç§°" width="200"></el-table-column>
                                    <el-table-column label="æ ‡ç­¾" width="200">
                                        <template #default="scope">
                                            <el-tag 
                                                v-for="tag in scope.row.tags" 
                                                :key="tag" 
                                                size="small" 
                                                :type="getTagType(tag)"
                                                style="margin-right: 5px;"
                                            >
                                                {{ getTagLabel(tag) }}
                                            </el-tag>
                                        </template>
                                    </el-table-column>
                                    <el-table-column label="çŠ¶æ€" width="100">
                                        <template #default="scope">
                                            <el-tag :type="scope.row.status === 'active' ? 'success' : 'danger'">
                                                {{ scope.row.status === 'active' ? 'å¯ç”¨' : 'ç¦ç”¨' }}
                                            </el-tag>
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="rating" label="è¯„åˆ†" width="100">
                                        <template #default="scope">
                                            <span v-if="scope.row.rating">â­ {{ scope.row.rating.toFixed(1) }}</span>
                                            <span v-else>æš‚æ— è¯„åˆ†</span>
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="ratingCount" label="è¯„ä»·æ•°" width="100"></el-table-column>
                                    <el-table-column label="æ“ä½œ" width="200">
                                        <template #default="scope">
                                            <el-button size="small" @click="editDish(scope.row)">
                                                ç¼–è¾‘
                                            </el-button>
                                            <el-button 
                                                size="small" 
                                                :type="scope.row.status === 'active' ? 'warning' : 'success'"
                                                @click="toggleDishStatus(scope.row)"
                                            >
                                                {{ scope.row.status === 'active' ? 'ç¦ç”¨' : 'å¯ç”¨' }}
                                            </el-button>
                                            <el-button size="small" type="danger" @click="deleteDish(scope.row)">
                                                åˆ é™¤
                                            </el-button>
                                        </template>
                                    </el-table-column>
                                </el-table>
                            </div>
                            
                            <!-- Pagination -->
                            <div style="text-align: center; margin-top: 20px;">
                                <el-pagination
                                    v-model:current-page="tablePage"
                                    v-model:page-size="pageSize"
                                    :page-sizes="[10, 20, 50, 100]"
                                    :small="false"
                                    :total="totalFilteredDishes"
                                    layout="total, sizes, prev, pager, next, jumper"
                                    @size-change="handleSizeChange"
                                    @current-change="handleCurrentChange"
                                />
                            </div>
                        </div>
                        
                        <!-- Module 2: Add New Dish Modal -->
                        <el-dialog
                            v-model="showAddDishModal"
                            title="æ·»åŠ æ–°èœå“"
                            width="600px"
                            :before-close="handleAddDishClose"
                        >
                            <el-form :model="newDishForm" :rules="dishFormRules" ref="dishForm" label-width="100px">
                                <el-form-item label="é¤å…åç§°" prop="restaurantName">
                                    <el-input v-model="newDishForm.restaurantName" placeholder="è¯·è¾“å…¥é¤å…åç§°"></el-input>
                                </el-form-item>
                                <el-form-item label="èœå“åç§°" prop="name">
                                    <el-input v-model="newDishForm.name" placeholder="è¯·è¾“å…¥èœå“åç§°"></el-input>
                                </el-form-item>
                                <el-form-item label="èœå“æ ‡ç­¾">
                                    <el-checkbox-group v-model="newDishForm.tags">
                                        <el-checkbox label="meat">è¤èœ</el-checkbox>
                                        <el-checkbox label="vegetarian">ç´ é£Ÿ</el-checkbox>
                                        <el-checkbox label="spicy">è¾›è¾£</el-checkbox>
                                        <el-checkbox label="mild">æ¸…æ·¡</el-checkbox>
                                        <el-checkbox label="specialty">æ‹›ç‰Œ</el-checkbox>
                                    </el-checkbox-group>
                                </el-form-item>
                                <el-form-item label="èœå“å›¾ç‰‡">
                                    <el-upload
                                        class="dish-image-uploader"
                                        :action="'/api/admin/dishes/upload-image'"
                                        :show-file-list="false"
                                        :on-success="handleImageUploadSuccess"
                                        :before-upload="beforeImageUpload"
                                        :headers="{ 'Authorization': 'Bearer ' + token }"
                                    >
                                        <img v-if="newDishForm.imageUrl" :src="newDishForm.imageUrl" class="dish-image" />
                                        <el-icon v-else class="dish-image-uploader-icon"><Plus /></el-icon>
                                    </el-upload>
                                    <div style="margin-top: 10px; color: #999; font-size: 12px;">
                                        æ”¯æŒ JPGã€PNG æ ¼å¼ï¼Œæ–‡ä»¶å¤§å°ä¸è¶…è¿‡ 2MB
                                    </div>
                                </el-form-item>
                            </el-form>
                            
                            <template #footer>
                                <span class="dialog-footer">
                                    <el-button @click="handleAddDishClose">å–æ¶ˆ</el-button>
                                    <el-button type="primary" @click="submitAddDish" :loading="addingDish">
                                        ç¡®å®šæ·»åŠ 
                                    </el-button>
                                </span>
                            </template>
                        </el-dialog>
                        
                        <!-- Dish Selection Modal for Menu -->
                        <el-dialog
                            v-model="showDishSelectionModal"
                            title="é€‰æ‹©èœå“"
                            width="800px"
                            :before-close="handleDishSelectionClose"
                        >
                            <div style="margin-bottom: 20px;">
                                <el-input
                                    v-model="dishSelectionSearch"
                                    placeholder="æœç´¢èœå“"
                                    clearable
                                    @input="filterSelectionDishes"
                                >
                                    <template #prefix>ğŸ”</template>
                                </el-input>
                            </div>
                            
                            <el-table 
                                :data="selectionFilteredDishes" 
                                max-height="400px"
                                @row-click="selectDishForMenu"
                                style="cursor: pointer;"
                            >
                                <el-table-column prop="restaurantName" label="é¤å…" width="150"></el-table-column>
                                <el-table-column prop="name" label="èœå“åç§°" width="200"></el-table-column>
                                <el-table-column label="æ ‡ç­¾" width="200">
                                    <template #default="scope">
                                        <el-tag 
                                            v-for="tag in scope.row.tags" 
                                            :key="tag" 
                                            size="small" 
                                            :type="getTagType(tag)"
                                            style="margin-right: 5px;"
                                        >
                                            {{ getTagLabel(tag) }}
                                        </el-tag>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="rating" label="è¯„åˆ†" width="100">
                                    <template #default="scope">
                                        <span v-if="scope.row.rating">â­ {{ scope.row.rating.toFixed(1) }}</span>
                                        <span v-else>æš‚æ— è¯„åˆ†</span>
                                    </template>
                                </el-table-column>
                            </el-table>
                            
                            <template #footer>
                                <span class="dialog-footer">
                                    <el-button @click="handleDishSelectionClose">å–æ¶ˆ</el-button>
                                </span>
                            </template>
                        </el-dialog>
                        
                        <!-- ç¼–è¾‘èœå•å¯¹è¯æ¡† -->
                        <el-dialog 
                            v-model="showEditMealDialog" 
                            :title="`ç¼–è¾‘${editingMealType === 'lunch' ? 'åˆé¤' : 'æ™šé¤'}èœå•`"
                            width="50%">
                            <div class="edit-meal-content">
                                <div class="meal-dishes-list">
                                    <div v-if="editingMealDishes.length === 0" class="empty-meal">
                                        <el-empty description="æš‚æ— èœå“" />
                                    </div>
                                    <div v-else>
                                        <el-card v-for="(dish, index) in editingMealDishes" :key="index" class="dish-card">
                                            <div class="dish-item">
                                                <div class="dish-info">
                                                    <div class="dish-name">{{ dish.dishName }}</div>
                                                    <div class="restaurant-name">{{ dish.restaurantName }}</div>
                                                </div>
                                                <el-button 
                                                    type="danger" 
                                                    size="small" 
                                                    @click="removeDishFromEditing(index)">
                                                    ç§»é™¤
                                                </el-button>
                                            </div>
                                        </el-card>
                                    </div>
                                </div>
                            </div>
                            <template #footer>
                                <span class="dialog-footer">
                                    <el-button @click="showEditMealDialog = false">å–æ¶ˆ</el-button>
                                    <el-button type="primary" @click="saveCurrentMenuChanges">ä¿å­˜</el-button>
                                </span>
                            </template>
                        </el-dialog>
                    </div>
                    
                    <!-- ç‚¹é¤è®°å½•é¡µé¢ -->
                    <div v-if="currentPage === 'orders'">
                        <!-- ç»Ÿè®¡å¡ç‰‡ -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number">{{ systemConfig.totalEmployees }}</div>
                                <div class="stat-label">å½“å‰æ€»äººæ•°</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #36d1dc 0%, #5b86e5 100%);">
                                <div class="stat-number">{{ todayLunchOrderCount }}</div>
                                <div class="stat-label">ä»Šæ—¥ä¸­åˆç‚¹é¤æ•°é‡</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                <div class="stat-number">{{ todayDinnerOrderCount }}</div>
                                <div class="stat-label">ä»Šæ—¥æ™šé¥­ç‚¹é¤æ•°é‡</div>
                            </div>
                        </div>
                        
                        <div class="page-content">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3>ğŸ“Š ç‚¹é¤è®°å½•ç®¡ç†</h3>
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span>æ€»äººæ•°:</span>
                                        <el-input-number 
                                            v-model="systemConfig.totalEmployees" 
                                            :min="1" 
                                            :max="1000"
                                            size="small"
                                            style="width: 100px"
                                            @change="updateTotalEmployees">
                                        </el-input-number>
                                    </div>
                                    <el-button type="success" @click="exportOrderData">
                                        ğŸ“¥ å¯¼å‡ºæ•°æ®
                                    </el-button>
                                </div>
                            </div>
                            
                            <!-- æ—¥æœŸç­›é€‰æ§ä»¶ -->
                            <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                                    <span style="font-weight: 500;">ğŸ“… æŸ¥è¯¢æ—¶é—´èŒƒå›´:</span>
                                    
                                    <!-- å¿«æ·é€‰æ‹© -->
                                    <el-radio-group v-model="orderDateQuickSelect" size="small">
                                        <el-radio-button label="default">é»˜è®¤èŒƒå›´</el-radio-button>
                                        <el-radio-button label="today">ä»Šå¤©</el-radio-button>
                                        <el-radio-button label="week">æœ¬å‘¨</el-radio-button>
                                        <el-radio-button label="month">æœ¬æœˆ</el-radio-button>
                                        <el-radio-button label="custom">è‡ªå®šä¹‰</el-radio-button>
                                    </el-radio-group>
                                    
                                    <!-- è‡ªå®šä¹‰æ—¥æœŸé€‰æ‹©å™¨ -->
                                    <el-date-picker
                                        v-if="orderDateQuickSelect === 'custom'"
                                        v-model="orderDateRange"
                                        type="daterange"
                                        range-separator="è‡³"
                                        start-placeholder="å¼€å§‹æ—¥æœŸ"
                                        end-placeholder="ç»“æŸæ—¥æœŸ"
                                        format="YYYY-MM-DD"
                                        value-format="YYYY-MM-DD"
                                        @change="onCustomDateRangeChange"
                                        size="small">
                                    </el-date-picker>
                                    
                                    <!-- æŸ¥è¯¢æŒ‰é’® -->
                                    <el-button type="primary" @click="loadOrdersData" size="small">
                                        ğŸ” æŸ¥è¯¢
                                    </el-button>
                                    
                                    <!-- é‡ç½®æŒ‰é’® -->
                                    <el-button @click="resetDateFilter" size="small">
                                        ğŸ”„ é‡ç½®
                                    </el-button>
                                </div>
                            </div>
                            
                            <div class="table-container">
                                <el-table :data="ordersData" style="width: 100%" stripe>
                                    <el-table-column prop="dateWithWeekday" label="æ—¥æœŸ" width="150">
                                    </el-table-column>
                                    <el-table-column prop="mealTypeText" label="é¤æ¬¡" width="100">
                                    </el-table-column>
                                    <el-table-column prop="totalPeople" label="æ€»äººæ•°" width="100">
                                        <template #default="scope">
                                            {{ systemConfig.totalEmployees }}
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="noEatCount" label="ä¸åƒäººæ•°" width="100">
                                    </el-table-column>
                                    <el-table-column prop="orderCount" label="ç‚¹é¤äººæ•°" width="100">
                                        <template #default="scope">
                                            <span style="font-weight: bold; color: #67c23a;">{{ scope.row.orderCount }}</span>
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="statusText" label="çŠ¶æ€" width="100">
                                        <template #default="scope">
                                            <el-tag :type="scope.row.status === 'open' ? 'success' : 'info'">
                                                {{ scope.row.statusText }}
                                            </el-tag>
                                        </template>
                                    </el-table-column>
                                    <el-table-column label="æ“ä½œ" width="200">
                                        <template #default="scope">
                                            <el-button 
                                                size="small" 
                                                :type="scope.row.status === 'open' ? 'warning' : 'success'"
                                                @click="toggleOrderStatus(scope.row)"
                                                :loading="scope.row.loading"
                                            >
                                                {{ scope.row.status === 'open' ? 'å…³é—­ç‚¹é¤' : 'å¼€æ”¾ç‚¹é¤' }}
                                            </el-button>
                                            <el-button 
                                                size="small" 
                                                type="warning"
                                                @click="clearNoEatCount(scope.row)"
                                                :loading="scope.row.clearLoading"
                                            >
                                                æ¸…é›¶ä¸åƒ
                                            </el-button>
                                        </template>
                                    </el-table-column>
                                </el-table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- èœå“è¯„ä»·è®°å½•é¡µé¢ -->
                    <div v-if="currentPage === 'ratings'">
                        <!-- ç»Ÿè®¡å¡ç‰‡ -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number">{{ weeklyAvgRating }}</div>
                                <div class="stat-label">æœ¬å‘¨å¹³å‡è¯„åˆ†</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #36d1dc 0%, #5b86e5 100%);">
                                <div class="stat-number">{{ weeklyNewRatings }}</div>
                                <div class="stat-label">æœ¬å‘¨æ–°å¢è¯„ä»·</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                <div class="stat-number">{{ poorRatingPercentage }}%</div>
                                <div class="stat-label">å·®è¯„å æ¯”(1-2æ˜Ÿ)</div>
                            </div>
                        </div>
                        
                        <div class="page-content">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3>â­ é¤å…è¯„ä»·è®°å½•</h3>
                                <div>
                                    <el-button type="success" @click="exportRatingData">
                                        ğŸ“¥ å¯¼å‡ºè¯„ä»·æ•°æ®
                                    </el-button>
                                </div>
                            </div>
                            
                            <!-- æœç´¢å’Œç­›é€‰åŒºåŸŸ -->
                            <div class="filter-section" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                                    <!-- æœç´¢æ¡† -->
                                    <div style="flex: 1; min-width: 200px;">
                                        <el-input
                                            v-model="ratingSearchKeyword"
                                            placeholder="æœç´¢èœå“åã€é¤å…åã€ç”¨æˆ·å..."
                                            @input="searchRatings"
                                            clearable
                                        >
                                            <template #prefix>
                                                <span>ğŸ”</span>
                                            </template>
                                        </el-input>
                                    </div>
                                    
                                    <!-- æ—¶é—´ç­›é€‰ -->
                                    <el-select v-model="ratingTimeFilter" @change="filterRatings" placeholder="æ—¶é—´èŒƒå›´">
                                        <el-option label="å…¨éƒ¨æ—¶é—´" value="all"></el-option>
                                        <el-option label="ä»Šå¤©" value="today"></el-option>
                                        <el-option label="æœ¬å‘¨" value="week"></el-option>
                                        <el-option label="æœ¬æœˆ" value="month"></el-option>
                                        <el-option label="è‡ªå®šä¹‰" value="custom"></el-option>
                                    </el-select>
                                    
                                    <!-- è‡ªå®šä¹‰æ—¶é—´èŒƒå›´ -->
                                    <el-date-picker
                                        v-if="ratingTimeFilter === 'custom'"
                                        v-model="ratingDateRange"
                                        type="daterange"
                                        range-separator="è‡³"
                                        start-placeholder="å¼€å§‹æ—¥æœŸ"
                                        end-placeholder="ç»“æŸæ—¥æœŸ"
                                        @change="filterRatings"
                                    >
                                    </el-date-picker>
                                    
                                    <!-- è¯„åˆ†ç­›é€‰ -->
                                    <el-select v-model="ratingScoreFilter" @change="filterRatings" placeholder="è¯„åˆ†èŒƒå›´">
                                        <el-option label="å…¨éƒ¨è¯„åˆ†" value="all"></el-option>
                                        <el-option label="1-2æ˜Ÿ (å·®è¯„)" value="1-2"></el-option>
                                        <el-option label="3æ˜Ÿ (ä¸­è¯„)" value="3"></el-option>
                                        <el-option label="4-5æ˜Ÿ (å¥½è¯„)" value="4-5"></el-option>
                                    </el-select>
                                    
                                    <!-- ç‚¹èµæ•°ç­›é€‰ -->
                                    <el-select v-model="ratingLikesFilter" @change="filterRatings" placeholder="ç‚¹èµæ•°">
                                        <el-option label="å…¨éƒ¨" value="all"></el-option>
                                        <el-option label="é«˜ç‚¹èµ (â‰¥10)" value="high"></el-option>
                                        <el-option label="ä½ç‚¹èµ (<10)" value="low"></el-option>
                                    </el-select>
                                    
                                    <!-- æ’åº -->
                                    <el-select v-model="ratingSortBy" @change="sortRatings" placeholder="æ’åºæ–¹å¼">
                                        <el-option label="æ—¶é—´å€’åº (æœ€æ–°)" value="time_desc"></el-option>
                                        <el-option label="æ—¶é—´æ­£åº (æœ€æ—©)" value="time_asc"></el-option>
                                        <el-option label="çƒ­åº¦æ’åº (ç‚¹èµæ•°)" value="likes_desc"></el-option>
                                        <el-option label="è¯„åˆ†é«˜åˆ°ä½" value="rating_desc"></el-option>
                                        <el-option label="è¯„åˆ†ä½åˆ°é«˜" value="rating_asc"></el-option>
                                    </el-select>
                                    
                                    <!-- é‡ç½®æŒ‰é’® -->
                                    <el-button @click="resetFilters">é‡ç½®ç­›é€‰</el-button>
                                </div>
                            </div>
                            
                            <div class="table-container">
                                <el-table :data="filteredRatingsData" style="width: 100%" stripe>
                                    <el-table-column prop="userName" label="ç”¨æˆ·å" width="120">
                                        <template #default="scope">
                                            <span>{{ scope.row.userName || 'åŒ¿åç”¨æˆ·' }}</span>
                                        </template>
                                    </el-table-column>
                                    <el-table-column label="é¤å… + èœå“" width="280">
                                        <template #default="scope">
                                            <div>
                                                <div style="font-weight: bold; color: #409eff;">{{ scope.row.restaurantName }}</div>
                                                <div style="font-size: 12px; color: #666;">{{ scope.row.dishName }}</div>
                                            </div>
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="rating" label="è¯„åˆ†" width="120">
                                        <template #default="scope">
                                            <div style="display: flex; align-items: center;">
                                                <span style="font-size: 16px; margin-right: 5px;">{{ generateStars(scope.row.rating) }}</span>
                                                <span style="color: #666; font-size: 14px;">({{ scope.row.rating }})</span>
                                            </div>
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="comment" label="è¯„ä»·å†…å®¹" min-width="250">
                                        <template #default="scope">
                                            <div v-if="scope.row.comment && scope.row.comment.trim()" style="max-height: 60px; overflow-y: auto;">
                                                {{ scope.row.comment }}
                                            </div>
                                            <span v-else style="color: #999; font-style: italic;">æ— è¯„ä»·å†…å®¹</span>
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="likesCount" label="ç‚¹èµæ•°" width="80">
                                        <template #default="scope">
                                            <el-tag size="small" type="success">{{ scope.row.likesCount || 0 }}</el-tag>
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="createdAt" label="å‘å¸ƒæ—¶é—´" width="160">
                                        <template #default="scope">
                                            <div style="font-size: 12px;">
                                                <div>{{ formatDate(scope.row.createdAt) }}</div>
                                                <div style="color: #666;">{{ formatTime(scope.row.createdAt) }}</div>
                                            </div>
                                        </template>
                                    </el-table-column>
                                    <el-table-column label="æ“ä½œ" width="160">
                                        <template #default="scope">
                                            <el-button size="small" @click="viewRatingDetail(scope.row)">
                                                æŸ¥çœ‹è¯¦æƒ…
                                            </el-button>
                                            <el-button size="small" type="danger" @click="confirmDeleteRating(scope.row)">
                                                åˆ é™¤
                                            </el-button>
                                        </template>
                                    </el-table-column>
                                </el-table>
                            </div>
                            
                            <!-- åˆ†é¡µ -->
                            <div style="margin-top: 20px; text-align: center;">
                                <el-pagination
                                    v-model:current-page="ratingCurrentPage"
                                    v-model:page-size="ratingPageSize"
                                    :page-sizes="[10, 20, 50, 100]"
                                    :total="totalFilteredRatings"
                                    layout="total, sizes, prev, pager, next, jumper"
                                    @size-change="handleRatingPageSizeChange"
                                    @current-change="handleRatingCurrentChange"
                                />
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç”¨æˆ·ç®¡ç†é¡µé¢ -->
                    <div v-if="currentPage === 'users'">
                        <!-- ç»Ÿè®¡å¡ç‰‡ -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number">{{ totalUsers }}</div>
                                <div class="stat-label">ç³»ç»Ÿç”¨æˆ·æ€»æ•°</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #36d1dc 0%, #5b86e5 100%);">
                                <div class="stat-number">{{ totalEmployees }}</div>
                                <div class="stat-label">å‘˜å·¥ç”¨æˆ·æ•°</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                <div class="stat-number">{{ activeUsersToday }}</div>
                                <div class="stat-label">ä»Šæ—¥æ´»è·ƒç”¨æˆ·</div>
                            </div>
                        </div>
                        
                        <div class="page-content">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3>ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h3>
                                <div>
                                    <el-button type="primary" @click="showAddEmployeeDialog">
                                        â• æ·»åŠ å‘˜å·¥
                                    </el-button>
                                    <el-button type="success" @click="exportUserData">
                                        ğŸ“¥ å¯¼å‡ºç”¨æˆ·æ•°æ®
                                    </el-button>
                                </div>
                            </div>
                            
                            <div class="table-container">
                                <el-table :data="usersData" style="width: 100%" stripe>
                                    <el-table-column prop="name" label="å§“å" width="120">
                                    </el-table-column>
                                    <el-table-column prop="open_id" label="ç”¨æˆ·ID" width="120">
                                        <template #default="scope">
                                            <span style="font-family: monospace; font-size: 12px;">
                                                {{ scope.row.open_id ? scope.row.open_id.substring(0, 8) + '...' : 'N/A' }}
                                            </span>
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="department" label="éƒ¨é—¨" width="120">
                                    </el-table-column>
                                    <el-table-column label="ç™»å½•æ–¹å¼" width="100">
                                        <template #default="scope">
                                            <el-tag type="primary">
                                                {{ scope.row.loginMethod || 'é£ä¹¦ç™»å½•' }}
                                            </el-tag>
                                        </template>
                                    </el-table-column>
                                    <el-table-column label="ç”¨æˆ·è§’è‰²" width="120">
                                        <template #default="scope">
                                            <el-tag :type="scope.row.role === 'admin' ? 'danger' : 'success'">
                                                {{ scope.row.role === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·' }}
                                            </el-tag>
                                            <el-tag type="warning" size="small" v-if="scope.row.isDefaultAdmin" style="margin-left: 5px;">
                                                é»˜è®¤
                                            </el-tag>
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="ratingCount" label="è¯„ä»·æ¬¡æ•°" width="100">
                                    </el-table-column>
                                    <el-table-column prop="registerTimeFormatted" label="æ³¨å†Œæ—¶é—´" width="120">
                                    </el-table-column>
                                    <el-table-column prop="lastLoginFormatted" label="æœ€åç™»å½•" width="120">
                                    </el-table-column>
                                    <el-table-column label="æ“ä½œ" width="260">
                                        <template #default="scope">
                                            <el-button size="small" @click="viewUserDetail(scope.row)">
                                                æŸ¥çœ‹è¯¦æƒ…
                                            </el-button>
                                            <el-button size="small" type="primary" @click="showSetRoleDialog(scope.row)" 
                                                       :disabled="scope.row.isDefaultAdmin">
                                                è®¾ç½®è§’è‰²
                                            </el-button>
                                            <el-button size="small" type="warning" @click="editUser(scope.row)" v-if="scope.row.isEmployee">
                                                ç¼–è¾‘
                                            </el-button>
                                        </template>
                                    </el-table-column>
                                </el-table>
                            </div>
                        </div>
                    </div>
                    
                </div>
                
                <!-- è®¾ç½®ç”¨æˆ·è§’è‰²å¯¹è¯æ¡† -->
                <el-dialog 
                    title="è®¾ç½®ç”¨æˆ·è§’è‰²" 
                    v-model="showRoleDialog" 
                    width="500px"
                    :close-on-click-modal="false">
                    <div v-if="selectedUser">
                        <div style="margin-bottom: 20px;">
                            <strong>ç”¨æˆ·ä¿¡æ¯ï¼š</strong>
                            <div style="margin-top: 10px; padding: 15px; background: #f5f7fa; border-radius: 8px;">
                                <div><strong>å§“åï¼š</strong>{{ selectedUser.name }}</div>
                                <div><strong>ç”¨æˆ·IDï¼š</strong>{{ selectedUser.id }}</div>
                                <div><strong>ç™»å½•æ–¹å¼ï¼š</strong>{{ selectedUser.loginMethod || 'é£ä¹¦ç™»å½•' }}</div>
                                <div><strong>å½“å‰è§’è‰²ï¼š</strong>
                                    <el-tag :type="selectedUser.role === 'admin' ? 'danger' : 'success'">
                                        {{ selectedUser.role === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·' }}
                                    </el-tag>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <strong>é€‰æ‹©æ–°è§’è‰²ï¼š</strong>
                            <el-radio-group v-model="newUserRole" style="margin-top: 10px;">
                                <el-radio value="user">
                                    <div style="display: flex; flex-direction: column; margin-left: 10px;">
                                        <span style="font-weight: bold;">æ™®é€šç”¨æˆ·</span>
                                        <span style="color: #666; font-size: 12px;">ä»…èƒ½è®¿é—®ç”¨æˆ·ä¸­å¿ƒé¡µé¢ï¼Œæ‹¥æœ‰ç‚¹é¤ã€è¯„ä»·å’ŒæŠ•ç¨¿åŠŸèƒ½</span>
                                    </div>
                                </el-radio>
                                <el-radio value="admin" style="margin-top: 15px;">
                                    <div style="display: flex; flex-direction: column; margin-left: 10px;">
                                        <span style="font-weight: bold;">ç®¡ç†å‘˜</span>
                                        <span style="color: #666; font-size: 12px;">æ‹¥æœ‰ç®¡ç†å‘˜é¡µé¢å’Œç”¨æˆ·é¡µé¢çš„æŸ¥çœ‹ç¼–è¾‘æƒé™</span>
                                    </div>
                                </el-radio>
                            </el-radio-group>
                        </div>
                        
                        <div v-if="selectedUser.isDefaultAdmin" style="padding: 10px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; color: #856404;">
                            <i class="el-icon-warning" style="margin-right: 5px;"></i>
                            <strong>æ³¨æ„ï¼š</strong>æ­¤ç”¨æˆ·ä¸ºç³»ç»Ÿé»˜è®¤ç®¡ç†å‘˜ï¼Œæ— æ³•ä¿®æ”¹è§’è‰²ã€‚
                        </div>
                    </div>
                    
                    <template #footer>
                        <span class="dialog-footer">
                            <el-button @click="showRoleDialog = false">å–æ¶ˆ</el-button>
                            <el-button type="primary" @click="confirmSetUserRole" :loading="settingRole" 
                                       :disabled="selectedUser && selectedUser.isDefaultAdmin">
                                ç¡®å®šè®¾ç½®
                            </el-button>
                        </span>
                    </template>
                </el-dialog>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.8/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/element-plus@2.4.4/dist/index.full.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@element-plus/icons-vue@2.1.0/dist/index.iife.min.js"></script>
    <script>
        const { createApp } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;
        const { Plus } = ElementPlusIconsVue;

        createApp({
            data() {
                return {
                    currentPage: 'dishes', // é»˜è®¤è¿›å…¥èœå“ç®¡ç†é¡µé¢
                    
                    // èœå“æ•°æ®
                    dishesData: [],
                    totalDishes: 0,
                    totalRestaurants: 0,
                    avgRating: 0,
                    
                    // èœå•ç®¡ç†æ•°æ®
                    selectedPeriod: 'today',
                    selectedDate: new Date(),
                    dailyMenu: {
                        lunch: [],
                        dinner: []
                    },
                    
                    // å½“å‰èœå•æ˜¾ç¤ºæ•°æ®
                    currentMenuData: {
                        hasMenu: false,
                        lunch: [],
                        dinner: [],
                        date: null
                    },
                    loadingCurrentMenu: false,
                    
                    // èœå•ç¼–è¾‘å¯¹è¯æ¡†
                    showEditMealDialog: false,
                    editingMealType: '', // 'lunch' or 'dinner'
                    editingMealDishes: [],
                    weeklyMenu: {
                        monday: { lunch: [], dinner: [] },
                        tuesday: { lunch: [], dinner: [] },
                        wednesday: { lunch: [], dinner: [] },
                        thursday: { lunch: [], dinner: [] },
                        friday: { lunch: [], dinner: [] },
                        saturday: { lunch: [], dinner: [] },
                        sunday: { lunch: [], dinner: [] }
                    },
                    // è¥ä¸šæ—¥ï¼šå‘¨ä¸€-å‘¨äº” + å‘¨æ—¥ (6å¤©)
                    weekDays: [
                        { key: 'monday', label: 'å‘¨ä¸€' },
                        { key: 'tuesday', label: 'å‘¨äºŒ' },
                        { key: 'wednesday', label: 'å‘¨ä¸‰' },
                        { key: 'thursday', label: 'å‘¨å››' },
                        { key: 'friday', label: 'å‘¨äº”' },
                        { key: 'sunday', label: 'å‘¨æ—¥' }
                    ],
                    
                    // èœå•ç”Ÿæˆå†å²è®°å½•ï¼ˆç”¨äº3å¤©ä¸é‡å¤è§„åˆ™ï¼‰
                    menuHistory: [],
                    
                    // æ”¾çºµé¤æ ‡ç­¾
                    indulgentTags: ['æ”¾çºµé¤'],
                    
                    // èœå•æ“ä½œçŠ¶æ€
                    generatingMenu: false,
                    savingMenu: false,
                    publishingMenu: false,
                    
                    // èœå“åº“ç®¡ç†
                    selectedDishes: [],
                    dishSearch: '',
                    restaurantFilter: '',
                    tagFilter: '',
                    statusFilter: '',
                    filteredDishes: [],
                    loadingDishes: false,
                    
                    // åˆ†é¡µ
                    tablePage: 1,
                    pageSize: 20,
                    totalFilteredDishes: 0,
                    
                    // æ·»åŠ èœå“å¼¹çª—
                    showAddDishModal: false,
                    isEditMode: false, // æ ‡è¯†æ˜¯å¦ä¸ºç¼–è¾‘æ¨¡å¼
                    newDishForm: {
                        id: null, // ç¼–è¾‘æ—¶å­˜å‚¨èœå“ID
                        restaurantName: '',
                        name: '',
                        tags: [],
                        imageUrl: ''
                    },
                    dishFormRules: {
                        restaurantName: [
                            { required: true, message: 'è¯·è¾“å…¥é¤å…åç§°', trigger: 'blur' }
                        ],
                        name: [
                            { required: true, message: 'è¯·è¾“å…¥èœå“åç§°', trigger: 'blur' }
                        ]
                    },
                    addingDish: false,
                    token: localStorage.getItem('adminToken') || '',
                    
                    // èœå“é€‰æ‹©å¼¹çª—
                    showDishSelectionModal: false,
                    dishSelectionSearch: '',
                    selectionFilteredDishes: [],
                    currentMenuAction: null, // { type: 'add'|'replace', mealType: 'lunch'|'dinner', index?: number }
                    
                    // ç‚¹é¤è®°å½•ç›¸å…³æ•°æ®
                    ordersData: [],
                    totalOrderRecords: 0,
                    todayOrderRecords: 0,
                    totalOrderCount: 0,
                    todayLunchOrderCount: 0,
                    todayDinnerOrderCount: 0,
                    
                    // æ—¥æœŸç­›é€‰ç›¸å…³
                    orderDateRange: null,
                    orderDateQuickSelect: 'default', // 'default', 'today', 'week', 'month', 'custom'
                    
                    // èœå“è¯„ä»·ç›¸å…³æ•°æ®
                    ratingsData: [],
                    filteredRatingsData: [],
                    totalRatings: 0,
                    todayRatings: 0,
                    avgOverallRating: 0,
                    // æ–°çš„ç»Ÿè®¡æ•°æ®
                    weeklyAvgRating: 0,
                    weeklyNewRatings: 0,
                    poorRatingPercentage: 0,
                    // ç­›é€‰å’Œæœç´¢å‚æ•°
                    ratingSearchKeyword: '',
                    ratingTimeFilter: 'all',
                    ratingDateRange: null,
                    ratingScoreFilter: 'all',
                    ratingLikesFilter: 'all',
                    ratingSortBy: 'time_desc',
                    // åˆ†é¡µå‚æ•°
                    ratingCurrentPage: 1,
                    ratingPageSize: 20,
                    totalFilteredRatings: 0,
                    
                    // ç”¨æˆ·ç®¡ç†ç›¸å…³æ•°æ®
                    usersData: [],
                    totalUsers: 0,
                    totalEmployees: 0,
                    activeUsersToday: 0,
                    
                    // ç”¨æˆ·è§’è‰²ç®¡ç†ç›¸å…³æ•°æ®
                    showRoleDialog: false,
                    selectedUser: null,
                    newUserRole: 'user',
                    settingRole: false,
                    
                    // ç³»ç»Ÿé…ç½®ç›¸å…³æ•°æ®
                    systemConfig: {
                        totalPeople: {
                            lunch: 50,
                            dinner: 45
                        },
                        totalEmployees: 100,
                        createdAt: null,
                        updatedAt: null
                    }
                };
            },
            computed: {
                uniqueRestaurants() {
                    const restaurants = [...new Set(this.dishesData.map(dish => dish.restaurantName))];
                    return restaurants.sort();
                },
                
                paginatedDishes() {
                    const start = (this.tablePage - 1) * this.pageSize;
                    const end = start + this.pageSize;
                    return this.filteredDishes.slice(start, end);
                }
            },
            mounted() {
                this.loadDishesData();
                this.loadMenuForPeriod(); // åˆå§‹åŒ–èœå•æ•°æ®
                this.loadCurrentMenu(); // åŠ è½½å½“å‰èœå•æ˜¾ç¤º
                
                // æ£€æŸ¥URLå‚æ•°ç¡®å®šå½“å‰é¡µé¢
                const urlParams = new URLSearchParams(window.location.search);
                const page = urlParams.get('page');
                if (page && ['dishes', 'orders', 'ratings', 'users'].includes(page)) {
                    this.currentPage = page;
                }
                
                // å¦‚æœæ˜¯ç‚¹é¤è®°å½•é¡µé¢ï¼ŒåŠ è½½è®¾ç½®æ•°æ®
                if (this.currentPage === 'orders') {
                    this.loadSettings();
                }
            },
            methods: {
                switchPage(page) {
                    this.currentPage = page;
                    // æ›´æ–°URLä½†ä¸åˆ·æ–°é¡µé¢
                    const newUrl = `${window.location.pathname}?page=${page}`;
                    window.history.pushState({ page }, '', newUrl);
                    
                    // æ ¹æ®é¡µé¢åŠ è½½å¯¹åº”æ•°æ®
                    if (page === 'dishes') {
                        this.loadDishesData();
                    } else if (page === 'orders') {
                        this.loadOrdersData();
                        this.loadSettings();
                    } else if (page === 'ratings') {
                        this.loadRatingsData();
                    } else if (page === 'users') {
                        this.loadUsersData();
                    }
                },
                
                getPageTitle() {
                    const titles = {
                        dishes: 'èœå“ç®¡ç†',
                        orders: 'ç‚¹é¤è®°å½•ç®¡ç†', 
                        ratings: 'èœå“è¯„ä»·è®°å½•',
                        users: 'ç”¨æˆ·ç®¡ç†'
                    };
                    return titles[this.currentPage] || 'èœå“ç®¡ç†';
                },
                
                getPageSubtitle() {
                    const subtitles = {
                        dishes: 'ç®¡ç†ç³»ç»Ÿèœå“åº“ï¼Œç”Ÿæˆæ¯æ—¥èœå•',
                        orders: 'æŸ¥çœ‹å’Œç®¡ç†ç”¨æˆ·ç‚¹é¤è®°å½•',
                        ratings: 'æŸ¥çœ‹ç”¨æˆ·å¯¹èœå“çš„è¯„ä»·åé¦ˆ', 
                        users: 'ç®¡ç†ç³»ç»Ÿç”¨æˆ·å’Œæƒé™'
                    };
                    return subtitles[this.currentPage] || '';
                },
                
                // === å½“å‰èœå•ç®¡ç† ===
                async loadCurrentMenu() {
                    this.loadingCurrentMenu = true;
                    try {
                        const response = await fetch('/api/menu/today');
                        const result = await response.json();
                        
                        if (result.success && result.data) {
                            this.currentMenuData = {
                                hasMenu: true,
                                lunch: result.data.lunch || [],
                                dinner: result.data.dinner || [],
                                date: result.data.date
                            };
                        } else {
                            this.currentMenuData = {
                                hasMenu: false,
                                lunch: [],
                                dinner: [],
                                date: null
                            };
                        }
                    } catch (error) {
                        console.error('åŠ è½½å½“å‰èœå•å¤±è´¥:', error);
                        ElMessage.error('åŠ è½½å½“å‰èœå•å¤±è´¥');
                        this.currentMenuData.hasMenu = false;
                    }
                    this.loadingCurrentMenu = false;
                },
                
                editMeal(mealType) {
                    // å‡†å¤‡ç¼–è¾‘å¯¹è¯æ¡†çš„æ•°æ®
                    this.editingMealType = mealType;
                    this.editingMealDishes = [...this.currentMenuData[mealType]];
                    this.showEditMealDialog = true;
                },
                
                async saveCurrentMenuChanges() {
                    try {
                        const menuData = {
                            lunch: this.editingMealType === 'lunch' ? this.editingMealDishes : this.currentMenuData.lunch,
                            dinner: this.editingMealType === 'dinner' ? this.editingMealDishes : this.currentMenuData.dinner,
                            date: new Date().toISOString().split('T')[0]
                        };
                        
                        const response = await fetch('/api/admin/menu/update', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(menuData)
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            ElMessage.success('èœå•æ›´æ–°æˆåŠŸ');
                            this.showEditMealDialog = false;
                            this.loadCurrentMenu(); // é‡æ–°åŠ è½½å½“å‰èœå•
                        } else {
                            ElMessage.error(result.message || 'èœå•æ›´æ–°å¤±è´¥');
                        }
                    } catch (error) {
                        console.error('ä¿å­˜èœå•å¤±è´¥:', error);
                        ElMessage.error('ä¿å­˜èœå•å¤±è´¥');
                    }
                },
                
                removeDishFromEditing(index) {
                    this.editingMealDishes.splice(index, 1);
                },
                
                // === èœå“æ•°æ®ç®¡ç† ===
                async loadDishesData() {
                    this.loadingDishes = true;
                    try {
                        const response = await fetch('/api/admin/dishes');
                        const result = await response.json();
                        if (result.success) {
                            this.dishesData = result.data.map(dish => ({
                                ...dish,
                                tags: dish.tags || [],
                                status: dish.status || 'active'
                            }));
                            this.calculateStats();
                            this.filterDishes();
                        }
                    } catch (error) {
                        console.error('åŠ è½½èœå“æ•°æ®å¤±è´¥:', error);
                        ElMessage.error('åŠ è½½èœå“æ•°æ®å¤±è´¥');
                    }
                    this.loadingDishes = false;
                },
                
                calculateStats() {
                    this.totalDishes = this.dishesData.length;
                    
                    const restaurants = [...new Set(this.dishesData.map(dish => dish.restaurantName))];
                    this.totalRestaurants = restaurants.length;
                    
                    const ratedDishes = this.dishesData.filter(dish => dish.rating && dish.rating > 0);
                    if (ratedDishes.length > 0) {
                        const totalRating = ratedDishes.reduce((sum, dish) => sum + dish.rating, 0);
                        this.avgRating = (totalRating / ratedDishes.length).toFixed(1);
                    } else {
                        this.avgRating = 'æš‚æ— ';
                    }
                },
                
                // === èœå“åº“ç®¡ç† ===
                filterDishes() {
                    let filtered = this.dishesData;
                    
                    // æŒ‰èœå“åç§°æœç´¢
                    if (this.dishSearch.trim()) {
                        filtered = filtered.filter(dish => 
                            dish.name.toLowerCase().includes(this.dishSearch.toLowerCase()) ||
                            dish.restaurantName.toLowerCase().includes(this.dishSearch.toLowerCase())
                        );
                    }
                    
                    // æŒ‰é¤å…ç­›é€‰
                    if (this.restaurantFilter) {
                        filtered = filtered.filter(dish => dish.restaurantName === this.restaurantFilter);
                    }
                    
                    // æŒ‰æ ‡ç­¾ç­›é€‰
                    if (this.tagFilter) {
                        filtered = filtered.filter(dish => dish.tags && dish.tags.includes(this.tagFilter));
                    }
                    
                    // æŒ‰çŠ¶æ€ç­›é€‰
                    if (this.statusFilter) {
                        filtered = filtered.filter(dish => dish.status === this.statusFilter);
                    }
                    
                    this.filteredDishes = filtered;
                    this.totalFilteredDishes = filtered.length;
                    this.tablePage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
                },
                
                handleSelectionChange(selection) {
                    this.selectedDishes = selection;
                },
                
                handleSizeChange(newSize) {
                    this.pageSize = newSize;
                    this.tablePage = 1;
                },
                
                handleCurrentChange(newPage) {
                    this.tablePage = newPage;
                },
                
                getTagType(tag) {
                    const typeMap = {
                        'meat': '',
                        'vegetarian': 'success',
                        'spicy': 'danger',
                        'mild': 'info',
                        'specialty': 'warning'
                    };
                    return typeMap[tag] || '';
                },
                
                getTagLabel(tag) {
                    const labelMap = {
                        'meat': 'è¤èœ',
                        'vegetarian': 'ç´ é£Ÿ',
                        'spicy': 'è¾›è¾£',
                        'mild': 'æ¸…æ·¡',
                        'specialty': 'æ‹›ç‰Œ'
                    };
                    return labelMap[tag] || tag;
                },
                
                // === æ·»åŠ /ç¼–è¾‘èœå“ ===
                showAddDishDialog() {
                    this.showAddDishModal = true;
                    this.resetDishForm();
                },
                
                resetDishForm() {
                    this.isEditMode = false;
                    this.newDishForm = {
                        id: null,
                        restaurantName: '',
                        name: '',
                        tags: [],
                        imageUrl: ''
                    };
                },
                
                handleAddDishClose() {
                    this.showAddDishModal = false;
                    this.resetDishForm();
                },
                
                async submitAddDish() {
                    if (!this.$refs.dishForm) return;
                    
                    try {
                        await this.$refs.dishForm.validate();
                        
                        this.addingDish = true;
                        
                        let response;
                        if (this.isEditMode) {
                            // ç¼–è¾‘æ¨¡å¼ï¼šä½¿ç”¨PUTæ–¹æ³•æ›´æ–°ç°æœ‰èœå“
                            const { id, ...formData } = this.newDishForm; // æ’é™¤idå­—æ®µ
                            response = await fetch(`/api/admin/dishes/${id}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${this.token}`
                                },
                                body: JSON.stringify(formData)
                            });
                        } else {
                            // æ·»åŠ æ¨¡å¼ï¼šä½¿ç”¨POSTæ–¹æ³•åˆ›å»ºæ–°èœå“
                            const { id, ...formData } = this.newDishForm; // æ’é™¤idå­—æ®µ
                            response = await fetch('/api/admin/dishes', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${this.token}`
                                },
                                body: JSON.stringify(formData)
                            });
                        }
                        
                        const result = await response.json();
                        if (result.success) {
                            const successMessage = this.isEditMode ? 'èœå“ä¿®æ”¹æˆåŠŸ' : 'èœå“æ·»åŠ æˆåŠŸ';
                            ElMessage.success(successMessage);
                            this.handleAddDishClose();
                            await this.loadDishesData();
                        } else {
                            const errorMessage = this.isEditMode ? 'ä¿®æ”¹å¤±è´¥' : 'æ·»åŠ å¤±è´¥';
                            ElMessage.error(result.message || errorMessage);
                        }
                    } catch (error) {
                        if (error.message) {
                            const errorMessage = this.isEditMode ? 'ä¿®æ”¹èœå“å¤±è´¥' : 'æ·»åŠ èœå“å¤±è´¥';
                            console.error(errorMessage + ':', error);
                            ElMessage.error(errorMessage);
                        }
                    }
                    this.addingDish = false;
                },
                
                beforeImageUpload(file) {
                    const isJPGorPNG = file.type === 'image/jpeg' || file.type === 'image/png';
                    const isLt2M = file.size / 1024 / 1024 < 2;
                    
                    if (!isJPGorPNG) {
                        ElMessage.error('å›¾ç‰‡åªèƒ½æ˜¯ JPG/PNG æ ¼å¼!');
                    }
                    if (!isLt2M) {
                        ElMessage.error('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 2MB!');
                    }
                    return isJPGorPNG && isLt2M;
                },
                
                handleImageUploadSuccess(response) {
                    if (response.success) {
                        this.newDishForm.imageUrl = response.data.url;
                        ElMessage.success('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ');
                    } else {
                        ElMessage.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥');
                    }
                },
                
                editDish(dish) {
                    this.isEditMode = true;
                    this.newDishForm = {
                        ...dish,
                        tags: dish.tags || []
                    };
                    this.showAddDishModal = true;
                },
                
                async toggleDishStatus(dish) {
                    try {
                        const newStatus = dish.status === 'active' ? 'inactive' : 'active';
                        const statusText = newStatus === 'active' ? 'å¯ç”¨' : 'ç¦ç”¨';
                        
                        const response = await fetch(`/api/admin/dishes/${dish.id}/status`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.token}`
                            },
                            body: JSON.stringify({ status: newStatus })
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            ElMessage.success(`${statusText}æˆåŠŸ`);
                            await this.loadDishesData();
                        } else {
                            ElMessage.error(result.message || `${statusText}å¤±è´¥`);
                        }
                    } catch (error) {
                        console.error('æ›´æ–°èœå“çŠ¶æ€å¤±è´¥:', error);
                        ElMessage.error('æ“ä½œå¤±è´¥');
                    }
                },
                
                async deleteDish(dish) {
                    try {
                        await ElMessageBox.confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªèœå“å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚', 'ç¡®è®¤åˆ é™¤', {
                            confirmButtonText: 'ç¡®å®šåˆ é™¤',
                            cancelButtonText: 'å–æ¶ˆ',
                            type: 'warning'
                        });
                        
                        const response = await fetch(`/api/admin/dishes/${dish.id}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${this.token}`
                            }
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            ElMessage.success('åˆ é™¤æˆåŠŸ');
                            await this.loadDishesData();
                        } else {
                            ElMessage.error(result.message || 'åˆ é™¤å¤±è´¥');
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('åˆ é™¤èœå“å¤±è´¥:', error);
                            ElMessage.error('åˆ é™¤å¤±è´¥');
                        }
                    }
                },
                
                async batchDisableDishes() {
                    try {
                        await ElMessageBox.confirm(`ç¡®å®šè¦æ‰¹é‡ç¦ç”¨é€‰ä¸­çš„ ${this.selectedDishes.length} ä¸ªèœå“å—ï¼Ÿ`, 'æ‰¹é‡ç¦ç”¨', {
                            confirmButtonText: 'ç¡®å®š',
                            cancelButtonText: 'å–æ¶ˆ',
                            type: 'warning'
                        });
                        
                        const dishIds = this.selectedDishes.map(dish => dish.id);
                        const response = await fetch('/api/admin/dishes/batch-disable', {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.token}`
                            },
                            body: JSON.stringify({ dishIds })
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            ElMessage.success(`æˆåŠŸç¦ç”¨ ${dishIds.length} ä¸ªèœå“`);
                            await this.loadDishesData();
                        } else {
                            ElMessage.error(result.message || 'æ‰¹é‡ç¦ç”¨å¤±è´¥');
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('æ‰¹é‡ç¦ç”¨å¤±è´¥:', error);
                            ElMessage.error('æ‰¹é‡ç¦ç”¨å¤±è´¥');
                        }
                    }
                },
                
                async batchDeleteDishes() {
                    try {
                        await ElMessageBox.confirm(`ç¡®å®šè¦æ‰¹é‡åˆ é™¤é€‰ä¸­çš„ ${this.selectedDishes.length} ä¸ªèœå“å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ï¼`, 'æ‰¹é‡åˆ é™¤', {
                            confirmButtonText: 'ç¡®å®šåˆ é™¤',
                            cancelButtonText: 'å–æ¶ˆ',
                            type: 'danger'
                        });
                        
                        const dishIds = this.selectedDishes.map(dish => dish.id);
                        const response = await fetch('/api/admin/dishes/batch-delete', {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.token}`
                            },
                            body: JSON.stringify({ dishIds })
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            ElMessage.success(`æˆåŠŸåˆ é™¤ ${dishIds.length} ä¸ªèœå“`);
                            await this.loadDishesData();
                        } else {
                            ElMessage.error(result.message || 'æ‰¹é‡åˆ é™¤å¤±è´¥');
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('æ‰¹é‡åˆ é™¤å¤±è´¥:', error);
                            ElMessage.error('æ‰¹é‡åˆ é™¤å¤±è´¥');
                        }
                    }
                },
                
                // === èœå•ç®¡ç† ===
                formatDateDisplay(date) {
                    if (!date) return '';
                    const d = new Date(date);
                    const month = d.getMonth() + 1;
                    const day = d.getDate();
                    const weekDay = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'][d.getDay()];
                    return `${month}æœˆ${day}æ—¥ ${weekDay}`;
                },
                
                async loadMenuForPeriod() {
                    if (this.selectedPeriod === 'today') {
                        await this.loadMenuForDate();
                    } else {
                        await this.loadWeeklyMenu();
                    }
                },
                
                async loadMenuForDate() {
                    try {
                        const dateStr = this.selectedDate.toISOString().split('T')[0];
                        const todayStr = new Date().toISOString().split('T')[0];
                        
                        // å§‹ç»ˆä½¿ç”¨ä»Šæ—¥èœå•APIï¼Œå› ä¸ºç›®å‰åªæ”¯æŒå½“æ—¥èœå•ç¼–è¾‘
                        const response = await fetch('/api/menu/today');
                        const result = await response.json();
                        
                        if (result.success && result.data) {
                            // è½¬æ¢èœå•æ•°æ®æ ¼å¼ä¸ºé¤å…å¼æ˜¾ç¤º
                            this.dailyMenu = {
                                lunch: this.convertToRestaurantFormat(result.data.lunch || []),
                                dinner: this.convertToRestaurantFormat(result.data.dinner || [])
                            };
                        } else {
                            this.dailyMenu = { lunch: [], dinner: [] };
                        }
                        
                        // åŠ è½½è‰ç¨¿èœå•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                        await this.loadMenuDraft();
                    } catch (error) {
                        console.error('åŠ è½½æ—¥èœå•å¤±è´¥:', error);
                        this.dailyMenu = { lunch: [], dinner: [] };
                    }
                },
                
                // è½¬æ¢èœå•æ ¼å¼ä¸ºé¤å…å¼æ˜¾ç¤ºæ ¼å¼
                convertToRestaurantFormat(dishes) {
                    if (!Array.isArray(dishes) || dishes.length === 0) {
                        return [];
                    }
                    
                    // æŒ‰é¤å…åˆ†ç»„
                    const restaurantGroups = {};
                    dishes.forEach(dish => {
                        if (!restaurantGroups[dish.restaurantName]) {
                            restaurantGroups[dish.restaurantName] = [];
                        }
                        restaurantGroups[dish.restaurantName].push({
                            id: dish.dishId,
                            name: dish.dishName,
                            tags: dish.tags || []
                        });
                    });
                    
                    // è½¬æ¢ä¸ºé¤å…å¼èœå•æ ¼å¼
                    return Object.keys(restaurantGroups).map(restaurantName => ({
                        isRestaurantMenu: true,
                        restaurantName: restaurantName,
                        dishes: restaurantGroups[restaurantName]
                    }));
                },
                
                async loadWeeklyMenu() {
                    try {
                        const weekStart = this.getWeekStart(this.selectedPeriod);
                        const response = await fetch('/api/menu/week');
                        
                        const result = await response.json();
                        if (result.success && result.data) {
                            // è½¬æ¢APIè¿”å›çš„æ•°å­—ç´¢å¼•æ ¼å¼ä¸ºå‰ç«¯æœŸæœ›çš„å‘½åå¤©æ ¼å¼
                            const dayNames = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                            const convertedData = {};
                            
                            // åªå¤„ç†å·¥ä½œæ—¥ + å‘¨æ—¥ï¼ˆ0-4, 6ï¼‰
                            dayNames.forEach((dayName, index) => {
                                if (index === 5) return; // è·³è¿‡å‘¨å…­
                                
                                const apiIndex = index === 6 ? 5 : index; // å‘¨æ—¥åœ¨APIä¸­æ˜¯ç´¢å¼•5
                                const dayData = result.data[apiIndex.toString()];
                                
                                if (dayData) {
                                    // è½¬æ¢èœå•æ•°æ®æ ¼å¼ä¸ºé¤å…å¼æ˜¾ç¤º
                                    convertedData[dayName] = {
                                        lunch: this.convertToRestaurantFormat(dayData.lunch || []),
                                        dinner: this.convertToRestaurantFormat(dayData.dinner || [])
                                    };
                                } else {
                                    convertedData[dayName] = { lunch: [], dinner: [] };
                                }
                            });
                            
                            this.weeklyMenu = convertedData;
                        } else {
                            this.weeklyMenu = this.getEmptyWeeklyMenu();
                        }
                        
                        // åŠ è½½è‰ç¨¿èœå•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                        await this.loadMenuDraft();
                    } catch (error) {
                        console.error('åŠ è½½å‘¨èœå•å¤±è´¥:', error);
                        this.weeklyMenu = this.getEmptyWeeklyMenu();
                    }
                },
                
                getWeekStart(period) {
                    const today = new Date();
                    const day = today.getDay(); // 0=å‘¨æ—¥, 1=å‘¨ä¸€...6=å‘¨å…­
                    let weekStart;
                    
                    if (day === 6) { // å¦‚æœä»Šå¤©æ˜¯å‘¨å…­
                        // ä»æ˜å¤©(å‘¨æ—¥)å¼€å§‹çš„ä¸€å‘¨
                        weekStart = new Date(today);
                        weekStart.setDate(today.getDate() + 1);
                        // è°ƒæ•´åˆ°å‘¨æ—¥ï¼ˆå¦‚æœæ˜å¤©ä¸æ˜¯å‘¨æ—¥çš„è¯ï¼‰
                        const nextDay = weekStart.getDay();
                        if (nextDay !== 0) {
                            weekStart.setDate(weekStart.getDate() - nextDay);
                        }
                    } else {
                        // å‘¨æ—¥åˆ°å‘¨äº”ï¼šæ˜¾ç¤ºæœ¬å‘¨çš„å‘¨æ—¥å¼€å§‹
                        const diff = today.getDate() - day;
                        weekStart = new Date(today.setDate(diff));
                    }
                    
                    if (period === 'nextWeek') {
                        weekStart.setDate(weekStart.getDate() + 7);
                    }
                    
                    return weekStart.toISOString().split('T')[0];
                },
                
                getEmptyWeeklyMenu() {
                    return {
                        monday: { lunch: [], dinner: [] },
                        tuesday: { lunch: [], dinner: [] },
                        wednesday: { lunch: [], dinner: [] },
                        thursday: { lunch: [], dinner: [] },
                        friday: { lunch: [], dinner: [] },
                        sunday: { lunch: [], dinner: [] }
                    };
                },
                
                async generateRandomMenu() {
                    try {
                        this.generatingMenu = true;
                        
                        // å¦‚æœæ˜¯æœ¬åœ°ç”Ÿæˆï¼Œä½¿ç”¨æ–°çš„ç®—æ³•
                        if (this.selectedPeriod === 'today') {
                            await this.generateDailyRestaurantMenu();
                        } else {
                            await this.generateWeeklyRestaurantMenu();
                        }
                        
                        ElMessage.success('éšæœºèœå•ç”ŸæˆæˆåŠŸ');
                    } catch (error) {
                        console.error('ç”Ÿæˆéšæœºèœå•å¤±è´¥:', error);
                        ElMessage.error('ç”Ÿæˆéšæœºèœå•å¤±è´¥');
                    }
                    this.generatingMenu = false;
                },
                
                // ç”ŸæˆåŸºäºé¤å…çš„æ¯æ—¥èœå•
                async generateDailyRestaurantMenu() {
                    const selectedDate = this.selectedDate;
                    const dayOfWeek = selectedDate.getDay();
                    
                    // è·å–å¯ç”¨é¤å…åˆ—è¡¨
                    const restaurants = this.getAvailableRestaurants();
                    
                    // ç”Ÿæˆåˆé¤èœå•
                    const lunchRestaurant = this.selectRestaurantForMeal(restaurants, selectedDate, 'lunch');
                    this.dailyMenu.lunch = lunchRestaurant ? this.getRestaurantMenuData(lunchRestaurant) : [];
                    
                    // ç”Ÿæˆæ™šé¤èœå•
                    const dinnerRestaurant = this.selectRestaurantForMeal(restaurants, selectedDate, 'dinner', lunchRestaurant);
                    this.dailyMenu.dinner = dinnerRestaurant ? this.getRestaurantMenuData(dinnerRestaurant) : [];
                    
                    // æ›´æ–°èœå•å†å²
                    this.updateMenuHistory(selectedDate, {
                        lunch: lunchRestaurant ? [lunchRestaurant] : [],
                        dinner: dinnerRestaurant ? [dinnerRestaurant] : []
                    });
                },
                
                // ç”ŸæˆåŸºäºé¤å…çš„å‘¨èœå•
                async generateWeeklyRestaurantMenu() {
                    const weekStart = new Date(this.getWeekStart(this.selectedPeriod));
                    const restaurants = this.getAvailableRestaurants();
                    const weekMenu = {};
                    
                    // ä¸ºæ¯ä¸€å¤©ç”Ÿæˆèœå•
                    for (const day of this.weekDays) {
                        const dayDate = new Date(weekStart);
                        const dayIndex = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'].indexOf(day.key);
                        dayDate.setDate(weekStart.getDate() + dayIndex);
                        
                        // ç”Ÿæˆåˆé¤èœå•
                        const lunchRestaurant = this.selectRestaurantForMeal(restaurants, dayDate, 'lunch');
                        
                        // ç”Ÿæˆæ™šé¤èœå•
                        const dinnerRestaurant = this.selectRestaurantForMeal(restaurants, dayDate, 'dinner', lunchRestaurant);
                        
                        weekMenu[day.key] = {
                            lunch: lunchRestaurant ? this.getRestaurantMenuData(lunchRestaurant) : [],
                            dinner: dinnerRestaurant ? this.getRestaurantMenuData(dinnerRestaurant) : []
                        };
                        
                        // æ›´æ–°èœå•å†å²
                        this.updateMenuHistory(dayDate, {
                            lunch: lunchRestaurant ? [lunchRestaurant] : [],
                            dinner: dinnerRestaurant ? [dinnerRestaurant] : []
                        });
                    }
                    
                    this.weeklyMenu = weekMenu;
                    
                    // ç”Ÿæˆåè‡ªåŠ¨ä¿å­˜ä¸ºè‰ç¨¿
                    await this.autoSaveMenuDraft();
                },
                
                // è·å–å¯ç”¨é¤å…åˆ—è¡¨
                getAvailableRestaurants() {
                    // æŒ‰é¤å…åˆ†ç»„èœå“
                    const restaurantMap = {};
                    
                    this.dishesData
                        .filter(dish => dish.status === 'active')
                        .forEach(dish => {
                            if (!restaurantMap[dish.restaurantName]) {
                                restaurantMap[dish.restaurantName] = {
                                    name: dish.restaurantName,
                                    dishes: [],
                                    avgRating: 0,
                                    totalRatingCount: 0,
                                    hasIndulgent: false,
                                    isNew: false
                                };
                            }
                            
                            const restaurant = restaurantMap[dish.restaurantName];
                            restaurant.dishes.push(dish);
                            
                            // è®¡ç®—å¹³å‡è¯„åˆ†
                            if (dish.rating && dish.ratingCount) {
                                restaurant.totalRatingCount += dish.ratingCount;
                                restaurant.avgRating += dish.rating * dish.ratingCount;
                            }
                            
                            // æ£€æŸ¥æ˜¯å¦æœ‰æ”¾çºµé¤
                            if (dish.tags && dish.tags.some(tag => this.indulgentTags.includes(tag))) {
                                restaurant.hasIndulgent = true;
                            }
                            
                            // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°èœå“ï¼ˆæœ€è¿‘7å¤©æ·»åŠ ï¼‰
                            if (dish.createdAt && new Date(dish.createdAt) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)) {
                                restaurant.isNew = true;
                            }
                        });
                    
                    // è®¡ç®—æœ€ç»ˆå¹³å‡è¯„åˆ†
                    Object.values(restaurantMap).forEach(restaurant => {
                        if (restaurant.totalRatingCount > 0) {
                            restaurant.avgRating = restaurant.avgRating / restaurant.totalRatingCount;
                        } else {
                            restaurant.avgRating = 0;
                        }
                    });
                    
                    // æŒ‰ä¼˜å…ˆçº§æ’åºï¼šæ–°é¤å… > é«˜è¯„åˆ†é¤å… > å…¶ä»–
                    const restaurants = Object.values(restaurantMap);
                    return restaurants.sort((a, b) => {
                        // æ–°é¤å…ä¼˜å…ˆ
                        if (a.isNew !== b.isNew) {
                            return a.isNew ? -1 : 1;
                        }
                        // è¯„åˆ†é«˜çš„ä¼˜å…ˆ
                        return b.avgRating - a.avgRating;
                    });
                },
                
                // ä¸ºç‰¹å®šé¤æ¬¡é€‰æ‹©é¤å…
                selectRestaurantForMeal(restaurants, date, mealType, excludeRestaurant = null) {
                    const dayOfWeek = date.getDay();
                    const isFridayDinner = dayOfWeek === 5 && mealType === 'dinner';
                    
                    // è·å–è¿‡å»3å¤©çš„é¤å…å†å²
                    const recentRestaurants = this.getRecentRestaurants(date, 3);
                    
                    let availableRestaurants = restaurants.filter(restaurant => {
                        // æ’é™¤å½“å‰é¤æ¬¡å·²é€‰æ‹©çš„é¤å…
                        if (excludeRestaurant && restaurant.name === excludeRestaurant.name) {
                            return false;
                        }
                        
                        // æ’é™¤æœ€è¿‘3å¤©ä½¿ç”¨è¿‡çš„é¤å…
                        if (recentRestaurants.includes(restaurant.name)) {
                            return false;
                        }
                        
                        // å¦‚æœä¸æ˜¯å‘¨äº”æ™šé¤ï¼Œæ’é™¤æ”¾çºµé¤é¤å…
                        if (!isFridayDinner && restaurant.hasIndulgent) {
                            return false;
                        }
                        
                        // å¦‚æœæ˜¯å‘¨äº”æ™šé¤ï¼Œä¼˜å…ˆé€‰æ‹©æ”¾çºµé¤é¤å…
                        return true;
                    });
                    
                    // å¦‚æœæ˜¯å‘¨äº”æ™šé¤ï¼Œä¼˜å…ˆé€‰æ‹©æœ‰æ”¾çºµé¤çš„é¤å…
                    if (isFridayDinner) {
                        const indulgentRestaurants = availableRestaurants.filter(r => r.hasIndulgent);
                        if (indulgentRestaurants.length > 0) {
                            availableRestaurants = indulgentRestaurants;
                        }
                    }
                    
                    // å¦‚æœæ²¡æœ‰å¯ç”¨é¤å…ï¼Œæ”¾å®½é™åˆ¶
                    if (availableRestaurants.length === 0) {
                        availableRestaurants = restaurants.filter(restaurant => {
                            return excludeRestaurant && restaurant.name !== excludeRestaurant.name;
                        });
                    }
                    
                    // éšæœºé€‰æ‹©ï¼ˆå·²ç»æŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
                    if (availableRestaurants.length === 0) {
                        return null;
                    }
                    
                    // ä»å‰30%çš„é«˜ä¼˜å…ˆçº§é¤å…ä¸­éšæœºé€‰æ‹©
                    const topRestaurantsCount = Math.max(1, Math.ceil(availableRestaurants.length * 0.3));
                    const topRestaurants = availableRestaurants.slice(0, topRestaurantsCount);
                    
                    return topRestaurants[Math.floor(Math.random() * topRestaurants.length)];
                },
                
                // è·å–æœ€è¿‘å‡ å¤©ä½¿ç”¨è¿‡çš„é¤å…
                getRecentRestaurants(currentDate, days) {
                    const recentRestaurants = [];
                    const startDate = new Date(currentDate);
                    startDate.setDate(startDate.getDate() - days);
                    
                    for (const entry of this.menuHistory) {
                        const entryDate = new Date(entry.date);
                        if (entryDate >= startDate && entryDate < currentDate) {
                            recentRestaurants.push(...entry.restaurants.lunch);
                            recentRestaurants.push(...entry.restaurants.dinner);
                        }
                    }
                    
                    return [...new Set(recentRestaurants)];
                },
                
                // æ›´æ–°èœå•å†å²
                updateMenuHistory(date, restaurantMenu) {
                    const dateStr = date.toISOString().split('T')[0];
                    const existingIndex = this.menuHistory.findIndex(entry => entry.date === dateStr);
                    
                    const historyEntry = {
                        date: dateStr,
                        restaurants: {
                            lunch: restaurantMenu.lunch.map(r => r.name || r),
                            dinner: restaurantMenu.dinner.map(r => r.name || r)
                        }
                    };
                    
                    if (existingIndex >= 0) {
                        this.menuHistory[existingIndex] = historyEntry;
                    } else {
                        this.menuHistory.push(historyEntry);
                    }
                    
                    // åªä¿ç•™æœ€è¿‘30å¤©çš„å†å²
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    this.menuHistory = this.menuHistory.filter(entry => 
                        new Date(entry.date) >= thirtyDaysAgo
                    );
                },
                
                // è·å–é¤å…çš„èœå•æ•°æ®ç»“æ„
                getRestaurantMenuData(restaurant) {
                    return [{
                        id: `restaurant_${restaurant.name}`,
                        restaurantName: restaurant.name,
                        name: 'æœ¬æ—¥èœå“',
                        dishes: restaurant.dishes.map(dish => ({
                            id: dish.id,
                            name: dish.name,
                            restaurantName: dish.restaurantName,
                            tags: dish.tags,
                            rating: dish.rating,
                            imageUrl: dish.imageUrl
                        })),
                        isRestaurantMenu: true,
                        rating: restaurant.avgRating
                    }];
                },
                
                addDishToMenu(mealType) {
                    this.currentMenuAction = { type: 'add', mealType };
                    this.showDishSelectionModal = true;
                    this.filterSelectionDishes();
                },
                
                replaceDish(mealType, index) {
                    this.currentMenuAction = { type: 'replace', mealType, index };
                    this.showDishSelectionModal = true;
                    this.filterSelectionDishes();
                },
                
                removeDish(mealType, index) {
                    this.dailyMenu[mealType].splice(index, 1);
                },
                
                addDishToWeeklyMenu(dayKey, mealType) {
                    this.currentMenuAction = { type: 'add', dayKey, mealType };
                    this.showDishSelectionModal = true;
                    this.filterSelectionDishes();
                },
                
                removeWeeklyDish(dayKey, mealType, index) {
                    if (!this.weeklyMenu[dayKey]) {
                        this.weeklyMenu[dayKey] = { lunch: [], dinner: [] };
                    }
                    this.weeklyMenu[dayKey][mealType].splice(index, 1);
                },
                
                handleDishSelectionClose() {
                    this.showDishSelectionModal = false;
                    this.dishSelectionSearch = '';
                    this.currentMenuAction = null;
                },
                
                filterSelectionDishes() {
                    let filtered = this.dishesData.filter(dish => dish.status === 'active');
                    
                    if (this.dishSelectionSearch.trim()) {
                        filtered = filtered.filter(dish => 
                            dish.name.toLowerCase().includes(this.dishSelectionSearch.toLowerCase()) ||
                            dish.restaurantName.toLowerCase().includes(this.dishSelectionSearch.toLowerCase())
                        );
                    }
                    
                    this.selectionFilteredDishes = filtered;
                },
                
                selectDishForMenu(dish) {
                    if (!this.currentMenuAction) return;
                    
                    const { type, mealType, index, dayKey } = this.currentMenuAction;
                    
                    if (dayKey) {
                        // å‘¨èœå•æ“ä½œ
                        if (!this.weeklyMenu[dayKey]) {
                            this.weeklyMenu[dayKey] = { lunch: [], dinner: [] };
                        }
                        
                        if (type === 'add') {
                            this.weeklyMenu[dayKey][mealType].push(dish);
                        } else if (type === 'replace' && index !== undefined) {
                            this.weeklyMenu[dayKey][mealType].splice(index, 1, dish);
                        }
                    } else {
                        // æ—¥èœå•æ“ä½œ
                        if (type === 'add') {
                            this.dailyMenu[mealType].push(dish);
                        } else if (type === 'replace' && index !== undefined) {
                            this.dailyMenu[mealType].splice(index, 1, dish);
                        }
                    }
                    
                    this.handleDishSelectionClose();
                    ElMessage.success('èœå“æ·»åŠ æˆåŠŸ');
                },
                
                async saveMenu() {
                    try {
                        this.savingMenu = true;
                        
                        const menuData = this.selectedPeriod === 'today' ? {
                            type: 'daily',
                            date: this.selectedDate.toISOString().split('T')[0],
                            menu: this.dailyMenu
                        } : {
                            type: 'weekly',
                            weekStart: this.getWeekStart(this.selectedPeriod),
                            menu: this.weeklyMenu
                        };
                        
                        const response = await fetch('/api/admin/menu/save', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.token}`
                            },
                            body: JSON.stringify(menuData)
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            ElMessage.success('èœå•å·²ä¿å­˜ä¸ºè‰ç¨¿');
                        } else {
                            ElMessage.error(result.message || 'ä¿å­˜å¤±è´¥');
                        }
                    } catch (error) {
                        console.error('ä¿å­˜èœå•å¤±è´¥:', error);
                        ElMessage.error('ä¿å­˜èœå•å¤±è´¥');
                    }
                    this.savingMenu = false;
                },
                
                // è‡ªåŠ¨ä¿å­˜èœå•è‰ç¨¿
                async autoSaveMenuDraft() {
                    try {
                        const menuData = this.selectedPeriod === 'today' ? {
                            type: 'daily',
                            date: this.selectedDate.toISOString().split('T')[0],
                            menu: this.dailyMenu
                        } : {
                            type: 'weekly',
                            weekStart: this.getWeekStart(this.selectedPeriod),
                            menu: this.weeklyMenu
                        };
                        
                        const response = await fetch('/api/admin/menu/save', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.token}`
                            },
                            body: JSON.stringify(menuData)
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            console.log('èœå•è‰ç¨¿è‡ªåŠ¨ä¿å­˜æˆåŠŸ');
                        }
                    } catch (error) {
                        console.error('è‡ªåŠ¨ä¿å­˜èœå•è‰ç¨¿å¤±è´¥:', error);
                    }
                },
                
                // åŠ è½½èœå•è‰ç¨¿
                async loadMenuDraft() {
                    try {
                        const params = new URLSearchParams();
                        if (this.selectedPeriod === 'today') {
                            params.append('type', 'daily');
                            params.append('date', this.selectedDate.toISOString().split('T')[0]);
                        } else {
                            params.append('type', 'weekly');
                            params.append('weekStart', this.getWeekStart(this.selectedPeriod));
                        }
                        
                        const response = await fetch(`/api/admin/menu/drafts?${params.toString()}`, {
                            headers: {
                                'Authorization': `Bearer ${this.token}`
                            }
                        });
                        
                        const result = await response.json();
                        if (result.success && result.data) {
                            if (this.selectedPeriod === 'today') {
                                this.dailyMenu = {
                                    lunch: result.data.lunch || [],
                                    dinner: result.data.dinner || []
                                };
                            } else {
                                this.weeklyMenu = result.data.menu || {};
                            }
                            console.log('èœå•è‰ç¨¿åŠ è½½æˆåŠŸ');
                        }
                    } catch (error) {
                        console.error('åŠ è½½èœå•è‰ç¨¿å¤±è´¥:', error);
                    }
                },
                
                async publishMenu() {
                    try {
                        await ElMessageBox.confirm('ç¡®å®šè¦å‘å¸ƒèœå•å—ï¼Ÿå‘å¸ƒåç”¨æˆ·å°†çœ‹åˆ°æ–°èœå•ã€‚', 'ç¡®è®¤å‘å¸ƒ', {
                            confirmButtonText: 'ç¡®å®šå‘å¸ƒ',
                            cancelButtonText: 'å–æ¶ˆ',
                            type: 'warning'
                        });
                        
                        this.publishingMenu = true;
                        
                        const menuData = this.selectedPeriod === 'today' ? {
                            type: 'daily',
                            date: this.selectedDate.toISOString().split('T')[0],
                            menu: this.dailyMenu
                        } : {
                            type: 'weekly',
                            weekStart: this.getWeekStart(this.selectedPeriod),
                            menu: this.weeklyMenu
                        };
                        
                        const response = await fetch('/api/admin/menu/publish', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.token}`
                            },
                            body: JSON.stringify(menuData)
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            ElMessage.success('èœå•å‘å¸ƒæˆåŠŸï¼ç”¨æˆ·ç°åœ¨å¯ä»¥çœ‹åˆ°æ–°èœå•äº†');
                        } else {
                            ElMessage.error(result.message || 'å‘å¸ƒå¤±è´¥');
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('å‘å¸ƒèœå•å¤±è´¥:', error);
                            ElMessage.error('å‘å¸ƒèœå•å¤±è´¥');
                        }
                    }
                    this.publishingMenu = false;
                },
                
                async refreshData() {
                    if (this.currentPage === 'dishes') {
                        await this.loadDishesData();
                        ElMessage.success('æ•°æ®å·²åˆ·æ–°');
                    } else if (this.currentPage === 'orders') {
                        await this.loadOrdersData();
                        ElMessage.success('æ•°æ®å·²åˆ·æ–°');
                    } else if (this.currentPage === 'ratings') {
                        await this.loadRatingsData();
                        ElMessage.success('æ•°æ®å·²åˆ·æ–°');
                    } else if (this.currentPage === 'users') {
                        await this.loadUsersData();
                        ElMessage.success('æ•°æ®å·²åˆ·æ–°');
                    }
                },
                
                // ç‚¹é¤è®°å½•ç®¡ç†ç›¸å…³æ–¹æ³•
                async loadOrdersData() {
                    try {
                        let url = '/api/admin/orders';
                        const dateRange = this.getDateRangeForQuery();
                        
                        if (dateRange.startDate && dateRange.endDate) {
                            url += `?startDate=${dateRange.startDate}&endDate=${dateRange.endDate}`;
                        }
                        const response = await fetch(url);
                        const result = await response.json();
                        if (result.success) {
                            this.ordersData = result.data;
                            this.calculateOrderStats();
                        }
                    } catch (error) {
                        console.error('åŠ è½½ç‚¹é¤è®°å½•å¤±è´¥:', error);
                        ElMessage.error('åŠ è½½ç‚¹é¤è®°å½•å¤±è´¥');
                    }
                },
                
                calculateOrderStats() {
                    this.totalOrderRecords = this.ordersData.length;
                    
                    // è®¡ç®—ä»Šæ—¥è®°å½•æ•°
                    const today = new Date().toISOString().split('T')[0];
                    this.todayOrderRecords = this.ordersData.filter(order => order.date === today).length;
                    
                    // è®¡ç®—æ€»ç‚¹é¤äººæ•°
                    this.totalOrderCount = this.ordersData.reduce((sum, order) => sum + (order.orderCount || 0), 0);
                    
                    // è®¡ç®—ä»Šæ—¥ä¸­åˆå’Œæ™šé¥­ç‚¹é¤æ•°é‡ (æ€»äººæ•° - ä¸åƒäººæ•°)
                    const todayOrders = this.ordersData.filter(order => order.date === today);
                    const todayLunch = todayOrders.find(order => order.mealType === 'lunch');
                    const todayDinner = todayOrders.find(order => order.mealType === 'dinner');
                    
                    const totalEmployees = this.systemConfig.totalEmployees || 0;
                    this.todayLunchOrderCount = todayLunch ? Math.max(0, totalEmployees - (todayLunch.noEatCount || 0)) : totalEmployees;
                    this.todayDinnerOrderCount = todayDinner ? Math.max(0, totalEmployees - (todayDinner.noEatCount || 0)) : totalEmployees;
                },
                
                async toggleOrderStatus(order) {
                    try {
                        // è®¾ç½®loadingçŠ¶æ€
                        order.loading = true;
                        
                        const response = await fetch('/api/admin/orders/toggle-status', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                date: order.date,
                                mealType: order.mealType
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            // æ›´æ–°æœ¬åœ°æ•°æ®
                            order.status = result.data.status;
                            order.statusText = order.status === 'open' ? 'å¼€æ”¾ç‚¹é¤' : 'å·²å…³é—­';
                            ElMessage.success(result.message);
                        } else {
                            ElMessage.error(result.message || 'æ“ä½œå¤±è´¥');
                        }
                    } catch (error) {
                        console.error('åˆ‡æ¢ç‚¹é¤çŠ¶æ€å¤±è´¥:', error);
                        ElMessage.error('åˆ‡æ¢ç‚¹é¤çŠ¶æ€å¤±è´¥');
                    } finally {
                        // æ¸…é™¤loadingçŠ¶æ€
                        order.loading = false;
                    }
                },

                exportOrderData() {
                    try {
                        const csvContent = [
                            ['æ—¥æœŸ', 'é¤æ¬¡', 'æ€»äººæ•°', 'ä¸åƒäººæ•°', 'ç‚¹é¤äººæ•°', 'çŠ¶æ€'].join(','),
                            ...this.ordersData.map(order => [
                                order.dateFormatted,
                                order.mealTypeText,
                                this.systemConfig.totalEmployees || 0,
                                order.noEatCount || 0,
                                order.orderCount || 0,
                                order.statusText
                            ].join(','))
                        ].join('\n');
                        
                        const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                        const link = document.createElement('a');
                        const url = URL.createObjectURL(blob);
                        link.setAttribute('href', url);
                        link.setAttribute('download', `ç‚¹é¤è®°å½•_${new Date().toISOString().split('T')[0]}.csv`);
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        ElMessage.success('æ•°æ®å¯¼å‡ºæˆåŠŸ');
                    } catch (error) {
                        console.error('å¯¼å‡ºå¤±è´¥:', error);
                        ElMessage.error('å¯¼å‡ºå¤±è´¥');
                    }
                },
                
                // æ—¥æœŸç­›é€‰ç›¸å…³æ–¹æ³•
                getDateRangeForQuery() {
                    const today = new Date();
                    const formatDate = (date) => {
                        return date.getFullYear() + '-' + 
                               String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                               String(date.getDate()).padStart(2, '0');
                    };
                    
                    switch (this.orderDateQuickSelect) {
                        case 'today':
                            return {
                                startDate: formatDate(today),
                                endDate: formatDate(today)
                            };
                        
                        case 'week':
                            const startOfWeek = new Date(today);
                            startOfWeek.setDate(today.getDate() - today.getDay()); // æœ¬å‘¨æ—¥
                            const endOfWeek = new Date(startOfWeek);
                            endOfWeek.setDate(startOfWeek.getDate() + 6); // æœ¬å‘¨å…­
                            return {
                                startDate: formatDate(startOfWeek),
                                endDate: formatDate(endOfWeek)
                            };
                            
                        case 'month':
                            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                            const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                            return {
                                startDate: formatDate(startOfMonth),
                                endDate: formatDate(endOfMonth)
                            };
                            
                        case 'custom':
                            if (this.orderDateRange && this.orderDateRange.length === 2) {
                                return {
                                    startDate: this.orderDateRange[0],
                                    endDate: this.orderDateRange[1]
                                };
                            }
                            break;
                            
                        default: // 'default'
                            return { startDate: null, endDate: null }; // ä½¿ç”¨æœåŠ¡ç«¯é»˜è®¤èŒƒå›´
                    }
                    
                    return { startDate: null, endDate: null };
                },
                
                onDateQuickSelectChange(value) {
                    if (value !== 'custom') {
                        this.orderDateRange = null;
                    }
                    // è‡ªåŠ¨æŸ¥è¯¢æ•°æ®
                    this.loadOrdersData();
                },
                
                onCustomDateRangeChange(dateRange) {
                    // å½“è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´æ”¹å˜æ—¶ï¼Œè‡ªåŠ¨æŸ¥è¯¢æ•°æ®
                    if (dateRange && dateRange.length === 2) {
                        this.loadOrdersData();
                    }
                },
                
                resetDateFilter() {
                    this.orderDateQuickSelect = 'default';
                    this.orderDateRange = null;
                    this.loadOrdersData();
                },
                
                // èœå“è¯„ä»·è®°å½•ç›¸å…³æ–¹æ³•
                async loadRatingsData() {
                    try {
                        const response = await fetch('/api/ratings');
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        const result = await response.json();
                        if (result.success) {
                            this.ratingsData = result.data || [];
                            this.calculateRatingStats();
                            this.filterRatings();
                        } else {
                            throw new Error(result.message || 'æœåŠ¡å™¨è¿”å›é”™è¯¯');
                        }
                    } catch (error) {
                        console.error('åŠ è½½è¯„ä»·è®°å½•å¤±è´¥:', error);
                        ElMessage.error('åŠ è½½è¯„ä»·è®°å½•å¤±è´¥: ' + error.message);
                        this.ratingsData = [];
                    }
                },
                
                calculateRatingStats() {
                    this.totalRatings = this.ratingsData.length;
                    
                    // è®¡ç®—ä»Šæ—¥è¯„ä»·æ•°
                    const today = new Date().toISOString().split('T')[0];
                    this.todayRatings = this.ratingsData.filter(rating => rating.date === today).length;
                    
                    // è®¡ç®—æ€»ä½“å¹³å‡è¯„åˆ†
                    if (this.ratingsData.length > 0) {
                        const totalRating = this.ratingsData.reduce((sum, rating) => sum + (rating.rating || 0), 0);
                        this.avgOverallRating = (totalRating / this.ratingsData.length).toFixed(1);
                    } else {
                        this.avgOverallRating = 'æš‚æ— ';
                    }
                },
                
                viewRatingDetail(rating) {
                    const comment = rating.comment && rating.comment.trim() ? rating.comment : 'æ— è¯„ä»·å†…å®¹';
                    ElMessage.info(`${rating.employeeName} å¯¹ ${rating.name} çš„è¯„ä»·ï¼š${rating.rating}åˆ† - ${comment}`);
                },
                
                exportRatingData() {
                    try {
                        const csvContent = [
                            ['è¯„ä»·æ—¥æœŸ', 'æ—¶é—´', 'è¯„ä»·è€…', 'èœå“åç§°', 'é¤æ¬¡', 'è¯„åˆ†', 'è¯„ä»·å†…å®¹'].join(','),
                            ...this.ratingsData.map(rating => [
                                rating.dateFormatted,
                                rating.timeFormatted,
                                rating.employeeName,
                                rating.name,
                                rating.mealTypeText,
                                rating.rating,
                                (rating.comment || '').replace(/,/g, 'ï¼Œ') // æ›¿æ¢é€—å·é¿å…CSVæ ¼å¼é—®é¢˜
                            ].join(','))
                        ].join('\n');
                        
                        const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                        const link = document.createElement('a');
                        const url = URL.createObjectURL(blob);
                        link.setAttribute('href', url);
                        link.setAttribute('download', `èœå“è¯„ä»·è®°å½•_${new Date().toISOString().split('T')[0]}.csv`);
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        ElMessage.success('è¯„ä»·æ•°æ®å¯¼å‡ºæˆåŠŸ');
                    } catch (error) {
                        console.error('å¯¼å‡ºå¤±è´¥:', error);
                        ElMessage.error('å¯¼å‡ºå¤±è´¥');
                    }
                },
                
                // ç”¨æˆ·ç®¡ç†ç›¸å…³æ–¹æ³•
                async loadUsersData() {
                    try {
                        const response = await fetch('/api/admin/users');
                        const result = await response.json();
                        if (result.success) {
                            this.usersData = result.data;
                            this.calculateUserStats();
                        }
                    } catch (error) {
                        console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
                        ElMessage.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥');
                    }
                },
                
                calculateUserStats() {
                    this.totalUsers = this.usersData.length;
                    this.totalEmployees = this.usersData.filter(user => user.isEmployee).length;
                    
                    // è®¡ç®—ä»Šæ—¥æ´»è·ƒç”¨æˆ·æ•°ï¼ˆä»Šæ—¥ç™»å½•çš„ç”¨æˆ·ï¼‰
                    const today = new Date().toISOString().split('T')[0];
                    this.activeUsersToday = this.usersData.filter(user => {
                        if (!user.lastLogin) return false;
                        return new Date(user.lastLogin).toISOString().split('T')[0] === today;
                    }).length;
                },
                
                viewUserDetail(user) {
                    const status = user.isEmployee ? 'å‘˜å·¥' : 'è®¿å®¢';
                    const loginInfo = user.lastLoginFormatted !== 'ä»æœªç™»å½•' ? 
                        `ï¼Œæœ€åç™»å½•ï¼š${user.lastLoginFormatted}` : 'ï¼Œä»æœªç™»å½•';
                    ElMessage.info(`ç”¨æˆ·è¯¦æƒ…ï¼š${user.name}ï¼ˆ${status}ï¼‰ï¼Œè¯„ä»·æ¬¡æ•°ï¼š${user.ratingCount}æ¬¡${loginInfo}`);
                },
                
                editUser(user) {
                    ElMessage.info('ç¼–è¾‘ç”¨æˆ·åŠŸèƒ½å¼€å‘ä¸­');
                    // TODO: å®ç°ç¼–è¾‘ç”¨æˆ·å¼¹çª—
                },
                
                showAddEmployeeDialog() {
                    ElMessage.info('æ·»åŠ å‘˜å·¥åŠŸèƒ½å¼€å‘ä¸­');
                    // TODO: å®ç°æ·»åŠ å‘˜å·¥å¼¹çª—
                },
                
                exportUserData() {
                    try {
                        const csvContent = [
                            ['å§“å', 'ç”¨æˆ·ID', 'éƒ¨é—¨', 'å‘˜å·¥çŠ¶æ€', 'è¯„ä»·æ¬¡æ•°', 'æ³¨å†Œæ—¶é—´', 'æœ€åç™»å½•'].join(','),
                            ...this.usersData.map(user => [
                                user.name,
                                user.open_id ? user.open_id.substring(0, 12) + '...' : 'N/A',
                                user.department,
                                user.isEmployee ? 'å‘˜å·¥' : 'è®¿å®¢',
                                user.ratingCount,
                                user.registerTimeFormatted,
                                user.lastLoginFormatted
                            ].join(','))
                        ].join('\n');
                        
                        const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                        const link = document.createElement('a');
                        const url = URL.createObjectURL(blob);
                        link.setAttribute('href', url);
                        link.setAttribute('download', `ç”¨æˆ·æ•°æ®_${new Date().toISOString().split('T')[0]}.csv`);
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        ElMessage.success('ç”¨æˆ·æ•°æ®å¯¼å‡ºæˆåŠŸ');
                    } catch (error) {
                        console.error('å¯¼å‡ºå¤±è´¥:', error);
                        ElMessage.error('å¯¼å‡ºå¤±è´¥');
                    }
                },
                
                // ç”¨æˆ·è§’è‰²ç®¡ç†ç›¸å…³æ–¹æ³•
                showSetRoleDialog(user) {
                    this.selectedUser = user;
                    this.newUserRole = user.role || 'user';
                    this.showRoleDialog = true;
                },
                
                async confirmSetUserRole() {
                    if (!this.selectedUser) return;
                    
                    try {
                        this.settingRole = true;
                        
                        const response = await fetch(`/api/admin/users/${this.selectedUser.id}/role`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.token}`
                            },
                            body: JSON.stringify({
                                role: this.newUserRole
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            ElMessage.success('ç”¨æˆ·è§’è‰²è®¾ç½®æˆåŠŸ');
                            this.showRoleDialog = false;
                            this.selectedUser = null;
                            await this.loadUsersData(); // é‡æ–°åŠ è½½ç”¨æˆ·æ•°æ®
                        } else {
                            ElMessage.error(result.message || 'è®¾ç½®å¤±è´¥');
                        }
                    } catch (error) {
                        console.error('è®¾ç½®ç”¨æˆ·è§’è‰²å¤±è´¥:', error);
                        ElMessage.error('è®¾ç½®å¤±è´¥');
                    } finally {
                        this.settingRole = false;
                    }
                },
                
                goToUserCenter() {
                    window.location.href = '/user-dashboard.html';
                },
                
                
                formatTodayDate() {
                    const today = new Date();
                    return today.toLocaleDateString('zh-CN');
                },
                
                getDayName() {
                    const days = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
                    return days[new Date().getDay()];
                },
                
                // æ¸…é›¶ä¸åƒäººæ•°
                async clearNoEatCount(order) {
                    try {
                        console.log('æ¸…é›¶ä¸åƒäººæ•° - å¼€å§‹:', order);
                        order.clearLoading = true;
                        
                        const requestData = {
                            date: order.date,
                            mealType: order.mealType
                        };
                        console.log('å‘é€è¯·æ±‚æ•°æ®:', requestData);
                        
                        const response = await fetch('/api/admin/orders/clear-no-eat', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.token}`
                            },
                            body: JSON.stringify(requestData)
                        });

                        console.log('å“åº”çŠ¶æ€:', response.status);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        const result = await response.json();
                        console.log('å“åº”ç»“æœ:', result);
                        
                        if (result.success) {
                            ElMessage.success(result.message);
                            // æ›´æ–°æœ¬åœ°æ•°æ®
                            order.noEatCount = 0;
                        } else {
                            ElMessage.error(result.message || 'æ“ä½œå¤±è´¥');
                        }
                    } catch (error) {
                        console.error('æ¸…é›¶ä¸åƒäººæ•°å¤±è´¥:', error);
                        ElMessage.error(`æ“ä½œå¤±è´¥: ${error.message}`);
                    } finally {
                        order.clearLoading = false;
                    }
                },
                

                async loadSettings() {
                    try {
                        const response = await fetch('/api/admin/settings', {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${this.token}`
                            }
                        });

                        const result = await response.json();
                        
                        if (result.success) {
                            if (result.data && typeof result.data.totalEmployees !== 'undefined') {
                                this.systemConfig.totalEmployees = result.data.totalEmployees;
                            }
                        }
                    } catch (error) {
                        console.error('åŠ è½½è®¾ç½®å¤±è´¥:', error);
                    }
                },

                // ç­›é€‰è¯„ä»·
                filterRatings() {
                    let filtered = [...this.ratingsData];

                    // å…³é”®è¯æœç´¢
                    if (this.ratingSearchKeyword.trim()) {
                        const keyword = this.ratingSearchKeyword.trim().toLowerCase();
                        filtered = filtered.filter(rating => 
                            rating.dishName.toLowerCase().includes(keyword) ||
                            rating.restaurantName.toLowerCase().includes(keyword) ||
                            rating.userName.toLowerCase().includes(keyword)
                        );
                    }

                    // æ—¶é—´ç­›é€‰
                    if (this.ratingTimeFilter !== 'all') {
                        const now = new Date();
                        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        
                        filtered = filtered.filter(rating => {
                            const ratingDate = new Date(rating.timestamp);
                            
                            switch (this.ratingTimeFilter) {
                                case 'today':
                                    return ratingDate >= today;
                                case 'week':
                                    const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                                    return ratingDate >= weekAgo;
                                case 'month':
                                    const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                                    return ratingDate >= monthAgo;
                                case 'custom':
                                    if (this.ratingDateRange && this.ratingDateRange.length === 2) {
                                        return ratingDate >= this.ratingDateRange[0] && ratingDate <= this.ratingDateRange[1];
                                    }
                                    return true;
                                default:
                                    return true;
                            }
                        });
                    }

                    // è¯„åˆ†ç­›é€‰
                    if (this.ratingScoreFilter !== 'all') {
                        filtered = filtered.filter(rating => {
                            switch (this.ratingScoreFilter) {
                                case 'low':
                                    return rating.score >= 1 && rating.score <= 2;
                                case 'medium':
                                    return rating.score === 3;
                                case 'high':
                                    return rating.score >= 4 && rating.score <= 5;
                                default:
                                    return true;
                            }
                        });
                    }

                    // ç‚¹èµæ•°ç­›é€‰
                    if (this.ratingLikesFilter !== 'all') {
                        filtered = filtered.filter(rating => {
                            const likes = rating.likeCount || 0;
                            switch (this.ratingLikesFilter) {
                                case 'none':
                                    return likes === 0;
                                case 'few':
                                    return likes >= 1 && likes <= 5;
                                case 'many':
                                    return likes > 5;
                                default:
                                    return true;
                            }
                        });
                    }

                    // æ’åº
                    this.sortRatings(filtered);

                    // æ›´æ–°åˆ†é¡µä¿¡æ¯
                    this.totalFilteredRatings = filtered.length;
                    
                    // åº”ç”¨åˆ†é¡µ
                    const start = (this.ratingCurrentPage - 1) * this.ratingPageSize;
                    const end = start + this.ratingPageSize;
                    this.filteredRatings = filtered.slice(start, end);
                },

                // å…³é”®è¯æœç´¢
                searchRatings() {
                    this.ratingCurrentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
                    this.filterRatings();
                },

                // æ’åº
                sortRatings(ratings) {
                    ratings.sort((a, b) => {
                        switch (this.ratingSortBy) {
                            case 'time_desc':
                                return new Date(b.timestamp) - new Date(a.timestamp);
                            case 'time_asc':
                                return new Date(a.timestamp) - new Date(b.timestamp);
                            case 'likes_desc':
                                return (b.likeCount || 0) - (a.likeCount || 0);
                            case 'likes_asc':
                                return (a.likeCount || 0) - (b.likeCount || 0);
                            case 'score_desc':
                                return b.score - a.score;
                            case 'score_asc':
                                return a.score - b.score;
                            default:
                                return new Date(b.timestamp) - new Date(a.timestamp);
                        }
                    });
                },

                // åˆ é™¤è¯„ä»·ç¡®è®¤
                confirmDeleteRating(rating) {
                    ElMessageBox.confirm(
                        `ç¡®å®šè¦åˆ é™¤ç”¨æˆ·ã€Œ${rating.userName}ã€å¯¹ã€Œ${rating.restaurantName} - ${rating.dishName}ã€çš„è¯„ä»·å—ï¼Ÿ`,
                        'åˆ é™¤ç¡®è®¤',
                        {
                            confirmButtonText: 'ç¡®å®šåˆ é™¤',
                            cancelButtonText: 'å–æ¶ˆ',
                            type: 'warning',
                            confirmButtonClass: 'el-button--danger'
                        }
                    ).then(() => {
                        this.deleteRating(rating.id);
                    }).catch(() => {
                        // ç”¨æˆ·å–æ¶ˆåˆ é™¤
                    });
                },

                // åˆ é™¤è¯„ä»·
                async deleteRating(ratingId) {
                    try {
                        const response = await fetch(`/api/admin/ratings/${ratingId}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${this.token}`
                            }
                        });

                        const result = await response.json();
                        
                        if (result.success) {
                            ElMessage.success('è¯„ä»·åˆ é™¤æˆåŠŸ');
                            await this.loadRatingsData(); // é‡æ–°åŠ è½½æ•°æ®
                            this.filterRatings(); // é‡æ–°ç­›é€‰
                        } else {
                            ElMessage.error(result.message || 'åˆ é™¤å¤±è´¥');
                        }
                    } catch (error) {
                        console.error('åˆ é™¤è¯„ä»·å¤±è´¥:', error);
                        ElMessage.error('åˆ é™¤å¤±è´¥');
                    }
                },

                // é‡ç½®ç­›é€‰
                resetFilters() {
                    this.ratingSearchKeyword = '';
                    this.ratingTimeFilter = 'all';
                    this.ratingDateRange = null;
                    this.ratingScoreFilter = 'all';
                    this.ratingLikesFilter = 'all';
                    this.ratingSortBy = 'time_desc';
                    this.ratingCurrentPage = 1;
                    this.filterRatings();
                },

                // å¤„ç†åˆ†é¡µå˜åŒ–
                handleRatingPageChange(page) {
                    this.ratingCurrentPage = page;
                    this.filterRatings();
                },

                // å¤„ç†åˆ†é¡µå¤§å°å˜åŒ–
                handleRatingPageSizeChange(size) {
                    this.ratingPageSize = size;
                    this.ratingCurrentPage = 1;
                    this.filterRatings();
                },

                // ç”Ÿæˆæ˜Ÿçº§æ˜¾ç¤º
                generateStars(score) {
                    const stars = [];
                    for (let i = 1; i <= 5; i++) {
                        stars.push(i <= score ? 'â˜…' : 'â˜†');
                    }
                    return stars.join('');
                },

                async updateTotalEmployees(value) {
                    try {
                        const response = await fetch('/api/admin/settings', {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.token}`
                            },
                            body: JSON.stringify({
                                totalEmployees: value
                            })
                        });

                        const result = await response.json();
                        
                        if (result.success) {
                            ElMessage.success('æ€»äººæ•°æ›´æ–°æˆåŠŸ');
                        } else {
                            ElMessage.error(result.message || 'æ›´æ–°å¤±è´¥');
                        }
                    } catch (error) {
                        console.error('æ›´æ–°æ€»äººæ•°å¤±è´¥:', error);
                        ElMessage.error('æ›´æ–°å¤±è´¥');
                    }
                },
                
                // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
                formatDate(dateStr) {
                    if (!dateStr) return 'æœªçŸ¥';
                    return new Date(dateStr).toLocaleString('zh-CN');
                }
            },
            watch: {
                orderDateQuickSelect(newValue, oldValue) {
                    if (newValue !== oldValue) {
                        this.onDateQuickSelectChange(newValue);
                    }
                }
            }
        }).use(ElementPlus).component('Plus', Plus).mount('#app');
    </script>
</body>
</html>